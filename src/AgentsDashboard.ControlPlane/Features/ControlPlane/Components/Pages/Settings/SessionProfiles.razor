@page "/settings/session-profiles"
@layout SettingsLayout
@rendermode InteractiveServer
@inject AgentsDashboard.ControlPlane.Data.IOrchestratorStore Store
@inject ISnackbar Snackbar
@using AgentsDashboard.Contracts.Api
@using AgentsDashboard.Contracts.Domain

@namespace AgentsDashboard.ControlPlane.Components.Pages
<PageTitle>Session Profiles - AgentsDashboard</PageTitle>

<MudStack Spacing="2">
    <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
        <MudText Typo="Typo.h4">Session Profiles</MudText>
        <MudButton Variant="Variant.Outlined" OnClick="LoadAsync">Refresh</MudButton>
    </MudStack>

    <MudPaper Class="pa-4">
        <MudGrid>
            <MudItem xs="12" md="3">
                <MudSelect T="RunSessionProfileScope" @bind-Value="_scope" @bind-Value:after="OnScopeChangedAsync" Label="Scope" Variant="Variant.Outlined" Margin="Margin.Dense">
                    <MudSelectItem T="RunSessionProfileScope" Value="@RunSessionProfileScope.Repository">Repository</MudSelectItem>
                    <MudSelectItem T="RunSessionProfileScope" Value="@RunSessionProfileScope.Global">Global</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="4">
                <MudSelect T="string" @bind-Value="_selectedRepositoryId" @bind-Value:after="OnRepositoryChangedAsync" Label="Repository" Variant="Variant.Outlined" Margin="Margin.Dense" Disabled="@(_scope == RunSessionProfileScope.Global)">
                    @foreach (var repository in _repositories)
                    {
                        <MudSelectItem T="string" Value="@repository.Id">@repository.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="5">
                <MudText Typo="Typo.caption" Class="d-block mt-4">Profiles define run defaults and MCP snapshot routing.</MudText>
            </MudItem>
        </MudGrid>

        <MudDivider Class="my-2" />

        <MudGrid>
            <MudItem xs="12" md="3">
                <MudTextField T="string" @bind-Value="_name" Label="Name" Variant="Variant.Outlined" Margin="Margin.Dense" />
            </MudItem>
            <MudItem xs="12" md="2">
                <MudSelect T="string" @bind-Value="_harness" Label="Harness" Variant="Variant.Outlined" Margin="Margin.Dense">
                    <MudSelectItem T="string" Value='@("codex")'>Codex</MudSelectItem>
                    <MudSelectItem T="string" Value='@("opencode")'>OpenCode</MudSelectItem>
                    <MudSelectItem T="string" Value='@("any")'>Any</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="2">
                <MudSelect T="HarnessExecutionMode" @bind-Value="_mode" Label="Mode" Variant="Variant.Outlined" Margin="Margin.Dense">
                    <MudSelectItem T="HarnessExecutionMode" Value="@HarnessExecutionMode.Default">Default</MudSelectItem>
                    <MudSelectItem T="HarnessExecutionMode" Value="@HarnessExecutionMode.Plan">Plan</MudSelectItem>
                    <MudSelectItem T="HarnessExecutionMode" Value="@HarnessExecutionMode.Review">Review</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="2">
                <MudTextField T="string" @bind-Value="_approvalMode" Label="Approval Mode" Variant="Variant.Outlined" Margin="Margin.Dense" />
            </MudItem>
            <MudItem xs="12" md="1">
                <MudSwitch T="bool" @bind-Value="_enabled" Label="Enabled" Color="Color.Primary" />
            </MudItem>
        </MudGrid>

        <MudGrid>
            <MudItem xs="12" md="3">
                <MudTextField T="string" @bind-Value="_diffViewDefault" Label="Diff View" Variant="Variant.Outlined" Margin="Margin.Dense" />
            </MudItem>
            <MudItem xs="12" md="3">
                <MudTextField T="string" @bind-Value="_toolTimelineMode" Label="Tool Timeline" Variant="Variant.Outlined" Margin="Margin.Dense" />
            </MudItem>
            <MudItem xs="12" md="6">
                <MudTextField T="string" @bind-Value="_mcpConfigJson" Label="MCP Config JSON" Variant="Variant.Outlined" Margin="Margin.Dense" Lines="3" />
            </MudItem>
        </MudGrid>

        <MudStack Row Spacing="1" Class="mt-2">
            @if (!string.IsNullOrWhiteSpace(_editingId))
            {
                <MudButton Variant="Variant.Filled" Color="Color.Warning" OnClick="SaveAsync">Update</MudButton>
                <MudButton Variant="Variant.Outlined" OnClick="CancelEdit">Cancel</MudButton>
            }
            else
            {
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveAsync">Create</MudButton>
            }
        </MudStack>
    </MudPaper>

    <MudTable Items="_profiles" Dense Hover>
        <HeaderContent>
            <MudTh>Name</MudTh>
            <MudTh>Scope</MudTh>
            <MudTh>Harness</MudTh>
            <MudTh>Mode</MudTh>
            <MudTh>Enabled</MudTh>
            <MudTh>Updated</MudTh>
            <MudTh></MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>@context.Name</MudTd>
            <MudTd>@context.Scope</MudTd>
            <MudTd>@context.Harness</MudTd>
            <MudTd>@context.ExecutionModeDefault</MudTd>
            <MudTd>@context.Enabled</MudTd>
            <MudTd>@context.UpdatedAtUtc.ToLocalTime().ToString("g")</MudTd>
            <MudTd>
                <MudStack Row Spacing="1">
                    <MudButton Variant="Variant.Text" Size="Size.Small" Color="Color.Secondary" OnClick="() => StartEdit(context)">Edit</MudButton>
                    <MudButton Variant="Variant.Text" Size="Size.Small" Color="Color.Error" OnClick="() => DeleteAsync(context)">Delete</MudButton>
                </MudStack>
            </MudTd>
        </RowTemplate>
    </MudTable>
</MudStack>

@code {
    private readonly List<RepositoryDocument> _repositories = [];
    private readonly List<RunSessionProfileDocument> _profiles = [];

    private RunSessionProfileScope _scope = RunSessionProfileScope.Repository;
    private string _selectedRepositoryId = string.Empty;

    private string _name = string.Empty;
    private string _harness = "codex";
    private HarnessExecutionMode _mode = HarnessExecutionMode.Default;
    private string _approvalMode = "auto";
    private string _diffViewDefault = "side-by-side";
    private string _toolTimelineMode = "table";
    private string _mcpConfigJson = string.Empty;
    private bool _enabled = true;
    private string _editingId = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        _repositories.Clear();
        _repositories.AddRange(await Store.ListRepositoriesAsync(CancellationToken.None));

        if (_scope == RunSessionProfileScope.Repository && string.IsNullOrWhiteSpace(_selectedRepositoryId))
        {
            _selectedRepositoryId = _repositories.FirstOrDefault()?.Id ?? string.Empty;
        }

        await LoadProfilesAsync();
    }

    private async Task LoadProfilesAsync()
    {
        _profiles.Clear();

        var scopeRepositoryId = _scope == RunSessionProfileScope.Global
            ? "global"
            : _selectedRepositoryId;

        if (string.IsNullOrWhiteSpace(scopeRepositoryId))
        {
            return;
        }

        _profiles.AddRange(await Store.ListRunSessionProfilesAsync(scopeRepositoryId, includeGlobal: false, CancellationToken.None));
    }

    private async Task OnScopeChangedAsync()
    {
        if (_scope == RunSessionProfileScope.Repository && string.IsNullOrWhiteSpace(_selectedRepositoryId))
        {
            _selectedRepositoryId = _repositories.FirstOrDefault()?.Id ?? string.Empty;
        }

        CancelEdit();
        await LoadProfilesAsync();
    }

    private async Task OnRepositoryChangedAsync()
    {
        CancelEdit();
        await LoadProfilesAsync();
    }

    private async Task SaveAsync()
    {
        var repositoryId = _scope == RunSessionProfileScope.Global ? "global" : _selectedRepositoryId;
        if (string.IsNullOrWhiteSpace(repositoryId))
        {
            Snackbar.Add("Repository scope is required.", Severity.Warning);
            return;
        }

        try
        {
            if (string.IsNullOrWhiteSpace(_editingId))
            {
                var createRequest = new CreateRunSessionProfileRequest(
                    repositoryId,
                    _name,
                    _harness,
                    _mode,
                    _approvalMode,
                    _diffViewDefault,
                    _toolTimelineMode,
                    _mcpConfigJson,
                    _scope);
                await Store.CreateRunSessionProfileAsync(createRequest, CancellationToken.None);
            }
            else
            {
                var updateRequest = new UpdateRunSessionProfileRequest(
                    _name,
                    _harness,
                    _mode,
                    _approvalMode,
                    _diffViewDefault,
                    _toolTimelineMode,
                    _mcpConfigJson,
                    _enabled);
                var updated = await Store.UpdateRunSessionProfileAsync(_editingId, updateRequest, CancellationToken.None);
                if (updated is null)
                {
                    Snackbar.Add("Session profile not found.", Severity.Warning);
                    return;
                }
            }

            CancelEdit();
            await LoadProfilesAsync();
            Snackbar.Add("Session profile saved.", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add(ex.Message, Severity.Warning);
        }
    }

    private void StartEdit(RunSessionProfileDocument profile)
    {
        _editingId = profile.Id;
        _name = profile.Name;
        _harness = profile.Harness;
        _mode = profile.ExecutionModeDefault;
        _approvalMode = profile.ApprovalMode;
        _diffViewDefault = profile.DiffViewDefault;
        _toolTimelineMode = profile.ToolTimelineMode;
        _mcpConfigJson = profile.McpConfigJson;
        _enabled = profile.Enabled;
        _scope = profile.Scope;

        if (_scope == RunSessionProfileScope.Repository)
        {
            _selectedRepositoryId = profile.RepositoryId;
        }
    }

    private void CancelEdit()
    {
        _editingId = string.Empty;
        _name = string.Empty;
        _harness = "codex";
        _mode = HarnessExecutionMode.Default;
        _approvalMode = "auto";
        _diffViewDefault = "side-by-side";
        _toolTimelineMode = "table";
        _mcpConfigJson = string.Empty;
        _enabled = true;
    }

    private async Task DeleteAsync(RunSessionProfileDocument profile)
    {
        var deleted = await Store.DeleteRunSessionProfileAsync(profile.Id, CancellationToken.None);
        if (!deleted)
        {
            Snackbar.Add("Session profile not found.", Severity.Warning);
            return;
        }

        if (string.Equals(_editingId, profile.Id, StringComparison.Ordinal))
        {
            CancelEdit();
        }

        await LoadProfilesAsync();
        Snackbar.Add("Session profile deleted.", Severity.Success);
    }
}
