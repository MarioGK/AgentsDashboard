@page "/settings/mcp"
@layout SettingsLayout
@rendermode InteractiveServer
@inject McpSettingsService McpSettingsManager
@inject McpRegistryCatalogService RegistryCatalog
@inject McpConfigJsonService McpJson
@inject ISnackbar Snackbar
@using AgentsDashboard.ControlPlane.Services

@namespace AgentsDashboard.ControlPlane.Components.Pages
<PageTitle>MCP Settings - AgentsDashboard</PageTitle>

<MudStack Spacing="2">
    <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
            <MudText Typo="Typo.h4">MCP Settings</MudText>
            <SettingsHintIcon Text="Model Context Protocol server discovery and JSON configuration for run dispatch." />
        </MudStack>
        <MudStack Row Spacing="1">
            <MudButton Variant="Variant.Outlined" OnClick="ReloadAllAsync">Reload</MudButton>
            <MudButton Variant="Variant.Outlined" OnClick="RefreshCatalogAsync" Disabled="@_catalogLoading">Refresh Catalog</MudButton>
        </MudStack>
    </MudStack>
    <MudText Typo="Typo.body2">
        Use catalog for quick onboarding, then validate JSON before saving production changes.
    </MudText>

    <MudTabs Elevation="0" Rounded="true" PanelClass="pa-4">
        <MudTabPanel Text="Catalog">
            <MudStack Spacing="2">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudText Typo="Typo.body2">Search official + popular MCP servers and add prefilled templates to your system MCP config.</MudText>
                    <SettingsHintIcon Text="Add inserts a server template into system JSON. Review command/args before saving." />
                </MudStack>
                <MudGrid>
                    <MudItem xs="12" md="8">
                        <SettingsHintedField ContainerClass="" Hint="Search by server name, source, package identifier, or description.">
                            <MudTextField T="string"
                                          @bind-Value="_catalogSearch"
                                          Placeholder="Search by name, package, source"
                                          Variant="Variant.Outlined"
                                          Margin="Margin.Dense"
                                          Immediate="true" />
                        </SettingsHintedField>
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudChipSet T="string">
                            <MudChip T="string" Color="Color.Primary" Variant="Variant.Outlined">@($"Entries: {_catalogEntries.Count}")</MudChip>
                            <MudChip T="string" Color="Color.Secondary" Variant="Variant.Outlined">@($"Filtered: {FilteredCatalog.Count}")</MudChip>
                        </MudChipSet>
                    </MudItem>
                </MudGrid>

                <MudTable Items="FilteredCatalog" Dense Hover Height="500px" FixedHeader>
                    <HeaderContent>
                        <MudTh>Server</MudTh>
                        <MudTh>Source</MudTh>
                        <MudTh>Package</MudTh>
                        <MudTh>Transport</MudTh>
                        <MudTh>Install</MudTh>
                        <MudTh></MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.subtitle2">@context.DisplayName</MudText>
                                <MudText Typo="Typo.caption">@context.ServerName</MudText>
                                @if (!string.IsNullOrWhiteSpace(context.Description))
                                {
                                    <MudText Typo="Typo.caption">@context.Description</MudText>
                                }
                            </MudStack>
                        </MudTd>
                        <MudTd>@context.Source</MudTd>
                        <MudTd>@context.PackageIdentifier</MudTd>
                        <MudTd>@context.TransportType</MudTd>
                        <MudTd>
                            @if (string.IsNullOrWhiteSpace(context.InstallCommand))
                            {
                                <MudText Typo="Typo.caption">N/A</MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.caption">@context.InstallCommand</MudText>
                            }
                        </MudTd>
                        <MudTd>
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small" OnClick="() => AddServerAsync(context)">Add</MudButton>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudStack>
        </MudTabPanel>

        <MudTabPanel Text="Configured Servers">
            <MudStack Spacing="2">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudText Typo="Typo.body2">Current servers defined under <code>mcpServers</code> in the system config snapshot.</MudText>
                    <SettingsHintIcon Text="Remove updates only in-memory JSON until saved in JSON Editor." />
                </MudStack>

                @if (_settingsValidation.Servers.Count == 0)
                {
                    <MudAlert Severity="Severity.Info">No configured MCP servers yet. Add from Catalog or edit JSON manually.</MudAlert>
                }
                else
                {
                    <MudTable Items="_settingsValidation.Servers" Dense Hover>
                        <HeaderContent>
                            <MudTh>Key</MudTh>
                            <MudTh>Transport</MudTh>
                            <MudTh>Command / URL</MudTh>
                            <MudTh>Args</MudTh>
                            <MudTh></MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@context.Key</MudTd>
                            <MudTd>@context.TransportType</MudTd>
                            <MudTd>@(string.IsNullOrWhiteSpace(context.Command) ? context.Url : context.Command)</MudTd>
                            <MudTd>@string.Join(" ", context.Args)</MudTd>
                            <MudTd>
                                <MudButton Variant="Variant.Text" Color="Color.Error" Size="Size.Small" OnClick="() => RemoveServerAsync(context.Key)">Remove</MudButton>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                }
            </MudStack>
        </MudTabPanel>

        <MudTabPanel Text="JSON Editor">
            <MudStack Spacing="2">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudText Typo="Typo.body2">Edit and save the system MCP snapshot JSON used during run dispatch.</MudText>
                    <SettingsHintIcon Text="Changes here affect global MCP behavior when profile overrides are absent." />
                </MudStack>
                <SettingsHintedField ContainerClass="" Hint="Validate and format before saving to reduce runtime dispatch errors.">
                    <MudTextField T="string"
                                  @bind-Value="_settingsJson"
                                  Label="System MCP JSON"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Lines="20"
                                  Immediate="true" />
                </SettingsHintedField>
                <MudStack Row Spacing="1">
                    <MudButton Variant="Variant.Outlined" OnClick="ValidateSystemJson">Validate</MudButton>
                    <MudButton Variant="Variant.Outlined" OnClick="FormatSystemJson">Format</MudButton>
                </MudStack>
                <SettingsActionBar IsDirty="@HasSystemJsonChanges"
                                   IsSaving="_systemSaving"
                                   SaveLabel="Save System JSON"
                                   OnSave="SaveSystemJsonAsync"
                                   OnRevert="RevertSystemJsonAsync"
                                   OnResetDefaults="ResetSystemJsonAsync" />

                @if (_settingsValidation.Errors.Count > 0)
                {
                    <MudAlert Severity="Severity.Error">
                        @foreach (var error in _settingsValidation.Errors)
                        {
                            <MudText Typo="Typo.caption">@error</MudText>
                        }
                    </MudAlert>
                }
            </MudStack>
        </MudTabPanel>

        <MudTabPanel Text="File">
            <MudStack Spacing="2">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudText Typo="Typo.body2">File-backed MCP config for direct JSON file editing and sync with DB settings.</MudText>
                    <SettingsHintIcon Text="This tab edits the physical MCP settings file. Keep DB and file in sync when needed." />
                </MudStack>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudText Typo="Typo.caption">@_filePath</MudText>
                    <SettingsHintIcon Text="Path to the MCP configuration file used by file-based workflows." />
                </MudStack>
                <SettingsHintedField ContainerClass="" Hint="Validate file JSON before Save File.">
                    <MudTextField T="string"
                                  @bind-Value="_fileJson"
                                  Label="MCP Settings File JSON"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Lines="20"
                                  Immediate="true" />
                </SettingsHintedField>
                <MudStack Row Spacing="1" Class="flex-wrap">
                    <MudButton Variant="Variant.Outlined" OnClick="ValidateFileJson">Validate</MudButton>
                    <MudButton Variant="Variant.Outlined" OnClick="FormatFileJson">Format</MudButton>
                    <MudButton Variant="Variant.Outlined" OnClick="LoadFileJsonAsync">Reload File</MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="SyncFileToSettingsAsync">Sync File → Settings</MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="SyncSettingsToFileAsync">Sync Settings → File</MudButton>
                </MudStack>
                <SettingsActionBar IsDirty="@HasFileJsonChanges"
                                   IsSaving="_fileSaving"
                                   SaveLabel="Save File JSON"
                                   OnSave="SaveFileJsonAsync"
                                   OnRevert="RevertFileJsonAsync"
                                   OnResetDefaults="ResetFileJsonAsync" />

                @if (_fileValidation.Errors.Count > 0)
                {
                    <MudAlert Severity="Severity.Error">
                        @foreach (var error in _fileValidation.Errors)
                        {
                            <MudText Typo="Typo.caption">@error</MudText>
                        }
                    </MudAlert>
                }
            </MudStack>
        </MudTabPanel>
    </MudTabs>
</MudStack>

@code {
    private string _settingsJson = string.Empty;
    private string _fileJson = string.Empty;
    private string _savedSettingsJson = string.Empty;
    private string _savedFileJson = string.Empty;
    private string _filePath = string.Empty;
    private string _catalogSearch = string.Empty;
    private bool _catalogLoading;
    private bool _systemSaving;
    private bool _fileSaving;

    private McpConfigValidationResult _settingsValidation = new();
    private McpConfigValidationResult _fileValidation = new();
    private List<McpCatalogEntry> _catalogEntries = [];
    private bool HasSystemJsonChanges => NormalizeJson(_settingsJson) != NormalizeJson(_savedSettingsJson);
    private bool HasFileJsonChanges => NormalizeJson(_fileJson) != NormalizeJson(_savedFileJson);

    private List<McpCatalogEntry> FilteredCatalog =>
        _catalogEntries
            .Where(MatchesCatalogSearch)
            .OrderByDescending(x => x.Score)
            .ThenBy(x => x.DisplayName, StringComparer.OrdinalIgnoreCase)
            .Take(300)
            .ToList();

    protected override async Task OnInitializedAsync()
    {
        _filePath = McpSettingsManager.GetSystemFilePath();
        await ReloadAllAsync();
    }

    private async Task ReloadAllAsync()
    {
        await LoadSystemJsonAsync();
        await LoadFileJsonAsync();
        await LoadCatalogAsync(forceRefresh: false);
    }

    private async Task LoadSystemJsonAsync()
    {
        var (json, validation) = await McpSettingsManager.LoadSystemConfigAsync(CancellationToken.None);
        _settingsJson = json;
        _savedSettingsJson = json;
        _settingsValidation = validation;
    }

    private async Task SaveSystemJsonAsync()
    {
        _systemSaving = true;
        try
        {
        var result = await McpSettingsManager.SaveSystemConfigAsync(_settingsJson, CancellationToken.None);
            _settingsValidation = result;
            _settingsJson = result.FormattedJson;

            if (!result.IsValid)
            {
                Snackbar.Add("System MCP JSON is invalid. Fix errors before saving.", Severity.Error);
                return;
            }

            _savedSettingsJson = _settingsJson;
            Snackbar.Add("System MCP settings saved.", Severity.Success);
        }
        finally
        {
            _systemSaving = false;
        }
    }

    private void ValidateSystemJson()
    {
        var result = McpJson.ValidateAndFormat(_settingsJson);
        _settingsValidation = result;
        if (result.IsValid)
        {
            Snackbar.Add("System MCP JSON is valid.", Severity.Success);
            return;
        }

        Snackbar.Add("System MCP JSON has validation errors.", Severity.Warning);
    }

    private void FormatSystemJson()
    {
        var result = McpJson.ValidateAndFormat(_settingsJson);
        _settingsValidation = result;
        _settingsJson = result.FormattedJson;
    }

    private async Task LoadFileJsonAsync()
    {
        var (json, validation) = await McpSettingsManager.LoadSystemFileAsync(CancellationToken.None);
        _fileJson = json;
        _savedFileJson = json;
        _fileValidation = validation;
    }

    private async Task SaveFileJsonAsync()
    {
        _fileSaving = true;
        try
        {
        var result = await McpSettingsManager.SaveSystemFileAsync(_fileJson, CancellationToken.None);
            _fileValidation = result;
            _fileJson = result.FormattedJson;

            if (!result.IsValid)
            {
                Snackbar.Add("MCP settings file JSON is invalid.", Severity.Error);
                return;
            }

            _savedFileJson = _fileJson;
            Snackbar.Add("MCP settings file saved.", Severity.Success);
        }
        finally
        {
            _fileSaving = false;
        }
    }

    private void ValidateFileJson()
    {
        var result = McpJson.ValidateAndFormat(_fileJson);
        _fileValidation = result;
        if (result.IsValid)
        {
            Snackbar.Add("MCP settings file JSON is valid.", Severity.Success);
            return;
        }

        Snackbar.Add("MCP settings file JSON has validation errors.", Severity.Warning);
    }

    private void FormatFileJson()
    {
        var result = McpJson.ValidateAndFormat(_fileJson);
        _fileValidation = result;
        _fileJson = result.FormattedJson;
    }

    private async Task SyncFileToSettingsAsync()
    {
        var result = await McpSettingsManager.SyncSystemFromFileAsync(CancellationToken.None);
        if (!result.IsValid)
        {
            _fileValidation = result;
            Snackbar.Add("Unable to sync from file. File JSON is invalid.", Severity.Error);
            return;
        }

        await LoadSystemJsonAsync();
        Snackbar.Add("Synced file JSON into system settings.", Severity.Success);
    }

    private async Task SyncSettingsToFileAsync()
    {
        var result = await McpSettingsManager.SyncFileFromSystemAsync(CancellationToken.None);
        if (!result.IsValid)
        {
            _settingsValidation = result;
            Snackbar.Add("Unable to sync settings to file. Settings JSON is invalid.", Severity.Error);
            return;
        }

        await LoadFileJsonAsync();
        Snackbar.Add("Synced system settings JSON into file.", Severity.Success);
    }

    private async Task LoadCatalogAsync(bool forceRefresh)
    {
        _catalogLoading = true;
        try
        {
            _catalogEntries = (await RegistryCatalog.GetCatalogAsync(forceRefresh, CancellationToken.None)).ToList();
        }
        finally
        {
            _catalogLoading = false;
        }
    }

    private async Task RefreshCatalogAsync()
    {
        _catalogLoading = true;
        try
        {
            _catalogEntries = (await RegistryCatalog.RefreshCatalogAsync(CancellationToken.None)).ToList();
            Snackbar.Add("MCP catalog refreshed.", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"MCP catalog refresh failed: {ex.Message}", Severity.Warning);
        }
        finally
        {
            _catalogLoading = false;
        }
    }

    private async Task AddServerAsync(McpCatalogEntry entry)
    {
        _settingsJson = McpJson.AddOrUpdateServer(_settingsJson, entry);
        _settingsValidation = McpJson.ValidateAndFormat(_settingsJson);
        await SaveSystemJsonAsync();
    }

    private void RemoveServerAsync(string key)
    {
        _settingsJson = McpJson.RemoveServer(_settingsJson, key);
        _settingsValidation = McpJson.ValidateAndFormat(_settingsJson);
        Snackbar.Add($"Removed MCP server '{key}' from system JSON.", Severity.Info);
    }

    private bool MatchesCatalogSearch(McpCatalogEntry entry)
    {
        if (string.IsNullOrWhiteSpace(_catalogSearch))
        {
            return true;
        }

        var search = _catalogSearch.Trim();
        return entry.DisplayName.Contains(search, StringComparison.OrdinalIgnoreCase)
            || entry.ServerName.Contains(search, StringComparison.OrdinalIgnoreCase)
            || entry.PackageIdentifier.Contains(search, StringComparison.OrdinalIgnoreCase)
            || entry.Source.Contains(search, StringComparison.OrdinalIgnoreCase)
            || entry.Description.Contains(search, StringComparison.OrdinalIgnoreCase);
    }

    private Task RevertSystemJsonAsync()
    {
        _settingsJson = _savedSettingsJson;
        _settingsValidation = McpJson.ValidateAndFormat(_settingsJson);
        return Task.CompletedTask;
    }

    private Task ResetSystemJsonAsync()
    {
        _settingsJson = "{}";
        _settingsValidation = McpJson.ValidateAndFormat(_settingsJson);
        return Task.CompletedTask;
    }

    private Task RevertFileJsonAsync()
    {
        _fileJson = _savedFileJson;
        _fileValidation = McpJson.ValidateAndFormat(_fileJson);
        return Task.CompletedTask;
    }

    private Task ResetFileJsonAsync()
    {
        _fileJson = "{}";
        _fileValidation = McpJson.ValidateAndFormat(_fileJson);
        return Task.CompletedTask;
    }

    private static string NormalizeJson(string value)
    {
        return (value ?? string.Empty).Trim();
    }
}
