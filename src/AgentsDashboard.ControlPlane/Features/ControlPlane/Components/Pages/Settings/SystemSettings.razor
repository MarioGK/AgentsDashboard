@page "/settings/system"
@layout SettingsLayout
@rendermode InteractiveServer
@inject AgentsDashboard.ControlPlane.Data.IOrchestratorStore Store
@inject ISnackbar Snackbar

@namespace AgentsDashboard.ControlPlane.Components.Pages
<PageTitle>System Settings - AgentsDashboard</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">System Settings</MudText>
<MudText Typo="Typo.body2" Class="mb-3">
    Global operational defaults used across repositories and runs.
</MudText>

@if (_loading)
{
    <MudProgressLinear Indeterminate />
}
else
{
    <SettingsActionBar IsDirty="@HasUnsavedChanges"
                       IsSaving="_saving"
                       SaveLabel="Save Settings"
                       OnSave="SaveAsync"
                       OnRevert="RevertChangesAsync"
                       OnResetDefaults="ResetToDefaultsAsync" />
    <MudGrid>
        <MudItem xs="12" md="6">
            <MudPaper Elevation="2" Class="pa-4 mb-4">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mb-1">
                    <MudText Typo="Typo.h6">Docker Policy</MudText>
                    <SettingsHintIcon Text="Restricts which Docker images can be used at runtime. One image reference per line." />
                </MudStack>
                <MudText Typo="Typo.body2" Class="mb-2">Allowed images (one per line)</MudText>
                <SettingsHintedField ContainerClass="" Hint="Use exact image tags where possible to avoid accidental changes from floating latest tags.">
                    <MudTextField T="string" @bind-Value="_allowedImagesText" Lines="6" Variant="Variant.Outlined"
                                  Placeholder="e.g. mcr.microsoft.com/dotnet/sdk:10.0" />
                </SettingsHintedField>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="6">
            <MudPaper Elevation="2" Class="pa-4 mb-4">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mb-1">
                    <MudText Typo="Typo.h6">Retention</MudText>
                    <SettingsHintIcon Text="Controls how long logs and run records are kept before cleanup." />
                </MudStack>
                <SettingsHintedField Hint="Retention period for run logs. Lower values reduce storage use.">
                    <MudNumericField T="int" @bind-Value="_retentionDaysLogs" Label="Log retention (days)"
                                     Variant="Variant.Outlined" Min="1" Max="365" />
                </SettingsHintedField>
                <SettingsHintedField ContainerClass="" Hint="Retention period for run history and metadata.">
                    <MudNumericField T="int" @bind-Value="_retentionDaysRuns" Label="Run retention (days)"
                                     Variant="Variant.Outlined" Min="1" Max="365" />
                </SettingsHintedField>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="6">
            <MudPaper Elevation="2" Class="pa-4 mb-4">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mb-1">
                    <MudText Typo="Typo.h6">Observability</MudText>
                    <SettingsHintIcon Text="External endpoints used for metrics ingestion and UI navigation." />
                </MudStack>
                <SettingsHintedField Hint="VictoriaMetrics write/read endpoint used by observability integrations.">
                    <MudTextField T="string" @bind-Value="_victoriaMetricsEndpoint" Label="VictoriaMetrics Endpoint"
                                  Variant="Variant.Outlined" />
                </SettingsHintedField>
                <SettingsHintedField ContainerClass="" Hint="Optional direct link to VMUI for operators.">
                    <MudTextField T="string" @bind-Value="_vmUiEndpoint" Label="VMUI Endpoint"
                                  Variant="Variant.Outlined" />
                </SettingsHintedField>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <SettingsActionBar IsDirty="@HasUnsavedChanges"
                       IsSaving="_saving"
                       SaveLabel="Save Settings"
                       Class="mt-2"
                       OnSave="SaveAsync"
                       OnRevert="RevertChangesAsync"
                       OnResetDefaults="ResetToDefaultsAsync" />
}

@code {
    private bool _loading = true;
    private bool _saving;
    private string _allowedImagesText = string.Empty;
    private int _retentionDaysLogs = 30;
    private int _retentionDaysRuns = 90;
    private string _victoriaMetricsEndpoint = string.Empty;
    private string _vmUiEndpoint = string.Empty;
    private string _savedAllowedImagesText = string.Empty;
    private int _savedRetentionDaysLogs = 30;
    private int _savedRetentionDaysRuns = 90;
    private string _savedVictoriaMetricsEndpoint = string.Empty;
    private string _savedVmUiEndpoint = string.Empty;
    private bool HasUnsavedChanges =>
        NormalizeAllowedImagesText(_allowedImagesText) != NormalizeAllowedImagesText(_savedAllowedImagesText) ||
        _retentionDaysLogs != _savedRetentionDaysLogs ||
        _retentionDaysRuns != _savedRetentionDaysRuns ||
        _victoriaMetricsEndpoint != _savedVictoriaMetricsEndpoint ||
        _vmUiEndpoint != _savedVmUiEndpoint;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        _loading = true;
        try
        {
            var settings = await Store.GetSettingsAsync(CancellationToken.None);
            _allowedImagesText = string.Join("\n", settings.DockerAllowedImages);
            _retentionDaysLogs = settings.RetentionDaysLogs;
            _retentionDaysRuns = settings.RetentionDaysRuns;
            _victoriaMetricsEndpoint = settings.VictoriaMetricsEndpoint;
            _vmUiEndpoint = settings.VmUiEndpoint;
            CaptureSavedState();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load settings: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task SaveAsync()
    {
        _saving = true;
        try
        {
            var images = _allowedImagesText
                .Split('\n', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
                .ToList();

            var updated = await Store.GetSettingsAsync(CancellationToken.None);
            updated.DockerAllowedImages = images;
            updated.RetentionDaysLogs = _retentionDaysLogs;
            updated.RetentionDaysRuns = _retentionDaysRuns;
            updated.VictoriaMetricsEndpoint = _victoriaMetricsEndpoint;
            updated.VmUiEndpoint = _vmUiEndpoint;
            updated.UpdatedAtUtc = DateTime.UtcNow;

            await Store.UpdateSettingsAsync(updated, CancellationToken.None);
            CaptureSavedState();
            Snackbar.Add("Settings saved", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to save settings: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private Task RevertChangesAsync()
    {
        _allowedImagesText = _savedAllowedImagesText;
        _retentionDaysLogs = _savedRetentionDaysLogs;
        _retentionDaysRuns = _savedRetentionDaysRuns;
        _victoriaMetricsEndpoint = _savedVictoriaMetricsEndpoint;
        _vmUiEndpoint = _savedVmUiEndpoint;
        return Task.CompletedTask;
    }

    private Task ResetToDefaultsAsync()
    {
        _allowedImagesText = string.Empty;
        _retentionDaysLogs = 30;
        _retentionDaysRuns = 90;
        _victoriaMetricsEndpoint = string.Empty;
        _vmUiEndpoint = string.Empty;
        return Task.CompletedTask;
    }

    private void CaptureSavedState()
    {
        _savedAllowedImagesText = NormalizeAllowedImagesText(_allowedImagesText);
        _allowedImagesText = _savedAllowedImagesText;
        _savedRetentionDaysLogs = _retentionDaysLogs;
        _savedRetentionDaysRuns = _retentionDaysRuns;
        _savedVictoriaMetricsEndpoint = _victoriaMetricsEndpoint;
        _savedVmUiEndpoint = _vmUiEndpoint;
    }

    private static string NormalizeAllowedImagesText(string value)
    {
        return string.Join(
            "\n",
            (value ?? string.Empty)
                .Split('\n', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries));
    }
}
