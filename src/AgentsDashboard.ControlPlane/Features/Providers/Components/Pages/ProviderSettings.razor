@page "/providers"
@rendermode InteractiveServer
@inject IRepositoryStore RepositoryStore
@inject ISystemStore SystemStore
@inject SecretCryptoService SecretCrypto
@inject CredentialValidationService CredentialValidator
@inject ISnackbar Snackbar

@namespace AgentsDashboard.ControlPlane.Components.Pages
<PageTitle>Providers - AgentsDashboard</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Provider Settings</MudText>

<MudStack Spacing="4">
    <MudPaper Class="pa-4" Elevation="2">
        <MudText Typo="Typo.h6" Class="mb-3">Global AI Key (LlmTornado)</MudText>
        <MudStack Spacing="2">
            <MudStack Row AlignItems="AlignItems.Center">
                <MudText Typo="Typo.subtitle1" Style="font-weight: 500;">LlmTornado (Z.ai via Anthropic-compatible API)</MudText>
                @if (_globalLlmTornadoConfigured)
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Text">
                        Configured
                    </MudChip>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        Last updated: @_globalLlmTornadoUpdatedAt?.ToLocalTime().ToString("g")
                    </MudText>
                }
            </MudStack>
            <MudTextField @bind-Value="_globalLlmTornadoValue"
                          Label="Z.ai API Key"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          InputType="InputType.Password"
                          HelperText="Stored globally and used by dashboard AI features (image generation, prompt generation)." />
            <MudStack Row Spacing="2">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           Size="Size.Small"
                           StartIcon="@Icons.Material.Filled.Save"
                           OnClick="SaveGlobalLlmTornadoSecretAsync"
                           Disabled="@string.IsNullOrWhiteSpace(_globalLlmTornadoValue)">
                    Save Global Key
                </MudButton>
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Info"
                           Size="Size.Small"
                           StartIcon="@Icons.Material.Filled.NetworkCheck"
                           OnClick="TestGlobalLlmTornadoSecretAsync"
                           Disabled="@(!_globalLlmTornadoConfigured && string.IsNullOrWhiteSpace(_globalLlmTornadoValue) || _testingGlobalLlmTornado)">
                    @if (_testingGlobalLlmTornado)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate />
                        <span>Testing...</span>
                    }
                    else
                    {
                        <span>Test Connection</span>
                    }
                </MudButton>
            </MudStack>
        </MudStack>
    </MudPaper>

    <MudPaper Class="pa-4" Elevation="2">
        <MudText Typo="Typo.h6" Class="mb-3">Repository Selection</MudText>
        @if (_repositories.Count == 0)
        {
            <MudAlert Severity="Severity.Info">No repositories found. Create a project and repository first.</MudAlert>
        }
        else
        {
            <MudSelect T="string" @bind-Value="_selectedRepositoryId" Label="Repository" Variant="Variant.Outlined"
                       AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter"
                       Placeholder="Select a repository to manage provider secrets"
                       @bind-Value:after="OnRepositorySelectedAsync">
                @foreach (var repo in _repositories)
                {
                    <MudSelectItem Value="@repo.Id">@repo.Name</MudSelectItem>
                }
            </MudSelect>
        }
    </MudPaper>

    @if (!string.IsNullOrWhiteSpace(_selectedRepositoryId))
    {
        <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4">
            <MudTabPanel Text="API Keys" Icon="@Icons.Material.Filled.Key">
                <MudStack Spacing="3">
                    @foreach (var provider in _providers)
                    {
                        <MudStack Spacing="2">
                            <MudStack Row AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.subtitle1" Style="font-weight: 500;">@provider.DisplayName</MudText>
                                @if (provider.HasValue)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Text">
                                        Configured
                                    </MudChip>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        Last updated: @provider.UpdatedAt?.ToLocalTime().ToString("g")
                                    </MudText>
                                }
                            </MudStack>
                            <MudTextField @bind-Value="provider.Value"
                                          Label="@provider.EnvVar"
                                          Variant="Variant.Outlined"
                                          Margin="Margin.Dense"
                                          InputType="InputType.Password"
                                          HelperText="@provider.Description"
                                          Placeholder="Enter API key or token" />
                            <MudStack Row Spacing="2">
                                <MudButton Variant="Variant.Filled"
                                           Color="Color.Primary"
                                           Size="Size.Small"
                                           StartIcon="@Icons.Material.Filled.Save"
                                           OnClick="() => SaveProviderSecretAsync(provider)"
                                           Disabled="@string.IsNullOrWhiteSpace(provider.Value)">
                                    Save @provider.DisplayName Secret
                                </MudButton>
                                <MudButton Variant="Variant.Outlined"
                                           Color="Color.Info"
                                           Size="Size.Small"
                                           StartIcon="@Icons.Material.Filled.NetworkCheck"
                                           OnClick="() => TestConnectionAsync(provider)"
                                           Disabled="@(!provider.HasValue && string.IsNullOrWhiteSpace(provider.Value) || provider.Testing)">
                                    @if (provider.Testing)
                                    {
                                        <MudProgressCircular Size="Size.Small" Indeterminate />
                                        <span>Testing...</span>
                                    }
                                    else
                                    {
                                        <span>Test Connection</span>
                                    }
                                </MudButton>
                            </MudStack>
                        </MudStack>
                        <MudDivider Class="my-2" />
                    }
                </MudStack>
            </MudTabPanel>

            <MudTabPanel Text="Codex" Icon="@Icons.Material.Filled.Code">
                @RenderHarnessSettings("codex", "Codex", _codexModels)
            </MudTabPanel>

            <MudTabPanel Text="OpenCode" Icon="@Icons.Material.Filled.OpenInNew">
                @RenderHarnessSettings("opencode", "OpenCode", _openCodeModels)
            </MudTabPanel>
        </MudTabs>
    }

    <MudText Typo="Typo.h5" Class="mt-6 mb-3">System Settings</MudText>
    <MudPaper Class="pa-4" Elevation="2">
        <MudStack Spacing="3">
            <MudStack Row AlignItems="AlignItems.Center">
                <MudIcon Icon="@Icons.Material.Filled.Settings" Size="Size.Medium" />
                <MudText Typo="Typo.h6">Global Configuration</MudText>
            </MudStack>

            <MudDivider />

            <MudGrid>
                <MudItem xs="12">
                    <MudTextField @bind-Value="_dockerAllowedImagesInput"
                                  Label="Docker Allowed Images"
                                  Variant="Variant.Outlined"
                                  Lines="3"
                                  HelperText="Comma-separated list of allowed Docker images (e.g., ubuntu:22.04, node:20-alpine)"
                                  Placeholder="ubuntu:22.04, node:20, python:3.11" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudNumericField T="int"
                                     @bind-Value="_retentionDaysLogs"
                                     Label="Log Retention (days)"
                                     Variant="Variant.Outlined"
                                     Min="1"
                                     Max="365"
                                     HelperText="How long to keep run logs" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudNumericField T="int"
                                     @bind-Value="_retentionDaysRuns"
                                     Label="Run Retention (days)"
                                     Variant="Variant.Outlined"
                                     Min="1"
                                     Max="365"
                                     HelperText="How long to keep run history" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_victoriaMetricsEndpoint"
                                  Label="VictoriaMetrics Endpoint"
                                  Variant="Variant.Outlined"
                                  HelperText="VictoriaMetrics server URL" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_vmUiEndpoint"
                                  Label="VMUI Endpoint"
                                  Variant="Variant.Outlined"
                                  HelperText="VictoriaMetrics UI URL" />
                </MudItem>
            </MudGrid>

            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Save"
                       OnClick="SaveSystemSettingsAsync">
                Save System Settings
            </MudButton>
        </MudStack>
    </MudPaper>
</MudStack>

@code {
    private class ProviderConfig
    {
        public required string Provider { get; set; }
        public required string DisplayName { get; set; }
        public required string EnvVar { get; set; }
        public required string Description { get; set; }
        public string Value { get; set; } = string.Empty;
        public bool HasValue { get; set; }
        public bool Testing { get; set; }
        public DateTime? UpdatedAt { get; set; }
    }

    private class RepositoryInfo
    {
        public required string Id { get; set; }
        public required string Name { get; set; }
    }

    private class HarnessSettingsState
    {
        public string Harness { get; set; } = string.Empty;
        public string Model { get; set; } = string.Empty;
        public double Temperature { get; set; } = 0.7;
        public int MaxTokens { get; set; } = 4096;
        public bool IsLoading { get; set; }
        public bool IsSaving { get; set; }
    }

    private readonly List<ProviderConfig> _providers = [];
    private readonly List<RepositoryInfo> _repositories = [];
    private string _selectedRepositoryId = string.Empty;

    private readonly Dictionary<string, HarnessSettingsState> _harnessSettings = new()
    {
        ["codex"] = new HarnessSettingsState { Harness = "codex" },
        ["opencode"] = new HarnessSettingsState { Harness = "opencode" }
    };

    private readonly List<string> _codexModels = ["gpt-4o", "gpt-4-turbo", "gpt-4", "gpt-3.5-turbo", "o1", "o1-mini", "o1-preview"];
    private readonly List<string> _openCodeModels = ["gpt-4o", "claude-3-5-sonnet-20241022", "gemini-2.0-flash", "llama-3.1-70b"];

    private const string GlobalSecretsRepositoryId = "global";
    private string _globalLlmTornadoValue = string.Empty;
    private bool _globalLlmTornadoConfigured;
    private DateTime? _globalLlmTornadoUpdatedAt;
    private bool _testingGlobalLlmTornado;

    private int _retentionDaysLogs = 30;
    private int _retentionDaysRuns = 90;
    private string _victoriaMetricsEndpoint = "http://localhost:8428";
    private string _vmUiEndpoint = "http://localhost:8081";
    private string _dockerAllowedImagesInput = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadGlobalLlmTornadoSecretAsync();
        await LoadRepositoriesAsync();
        await LoadSystemSettingsAsync();
    }

    private async Task LoadRepositoriesAsync()
    {
        try
        {
            _repositories.Clear();
            var repos = await RepositoryStore.ListRepositoriesAsync(CancellationToken.None);
            _repositories.AddRange(repos.Select(r => new RepositoryInfo
            {
                Id = r.Id,
                Name = r.Name
            }));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load repositories: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadSystemSettingsAsync()
    {
        try
        {
            var settings = await SystemStore.GetSettingsAsync(CancellationToken.None);
            _retentionDaysLogs = settings.RetentionDaysLogs;
            _retentionDaysRuns = settings.RetentionDaysRuns;
            _victoriaMetricsEndpoint = settings.VictoriaMetricsEndpoint;
            _vmUiEndpoint = settings.VmUiEndpoint;
            _dockerAllowedImagesInput = string.Join(", ", settings.DockerAllowedImages);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load system settings: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadGlobalLlmTornadoSecretAsync()
    {
        try
        {
            var secret = await RepositoryStore.GetProviderSecretAsync(GlobalSecretsRepositoryId, "llmtornado", CancellationToken.None);
            _globalLlmTornadoConfigured = secret is not null;
            _globalLlmTornadoUpdatedAt = secret?.UpdatedAtUtc;
            _globalLlmTornadoValue = string.Empty;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load global LlmTornado key: {ex.Message}", Severity.Error);
        }
    }

    private async Task SaveGlobalLlmTornadoSecretAsync()
    {
        if (string.IsNullOrWhiteSpace(_globalLlmTornadoValue))
        {
            Snackbar.Add("Global LlmTornado key cannot be empty", Severity.Warning);
            return;
        }

        try
        {
            var encrypted = SecretCrypto.Encrypt(_globalLlmTornadoValue.Trim());
            await RepositoryStore.UpsertProviderSecretAsync(
                GlobalSecretsRepositoryId,
                "llmtornado",
                encrypted,
                CancellationToken.None);

            _globalLlmTornadoConfigured = true;
            _globalLlmTornadoUpdatedAt = DateTime.UtcNow;
            _globalLlmTornadoValue = string.Empty;
            Snackbar.Add("Global LlmTornado key saved", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving global LlmTornado key: {ex.Message}", Severity.Error);
        }
    }

    private async Task TestGlobalLlmTornadoSecretAsync()
    {
        _testingGlobalLlmTornado = true;
        StateHasChanged();

        try
        {
            string? key = null;

            if (!string.IsNullOrWhiteSpace(_globalLlmTornadoValue))
            {
                key = _globalLlmTornadoValue.Trim();
            }
            else if (_globalLlmTornadoConfigured)
            {
                var secret = await RepositoryStore.GetProviderSecretAsync(GlobalSecretsRepositoryId, "llmtornado", CancellationToken.None);
                if (secret is not null)
                {
                    key = SecretCrypto.Decrypt(secret.EncryptedValue);
                }
            }

            if (string.IsNullOrWhiteSpace(key))
            {
                Snackbar.Add("No global LlmTornado key found", Severity.Error);
                return;
            }

            var (success, message) = await CredentialValidator.ValidateAsync("llmtornado", key, CancellationToken.None);
            Snackbar.Add($"LlmTornado: {message}", success ? Severity.Success : Severity.Error);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error testing global LlmTornado key: {ex.Message}", Severity.Error);
        }
        finally
        {
            _testingGlobalLlmTornado = false;
            StateHasChanged();
        }
    }

    private async Task OnRepositorySelectedAsync()
    {
        if (string.IsNullOrWhiteSpace(_selectedRepositoryId))
            return;

        _providers.Clear();
        _providers.AddRange(new[]
        {
            new ProviderConfig
            {
                Provider = "codex",
                DisplayName = "Codex",
                EnvVar = "CODEX_API_KEY",
                Description = "OpenAI Codex API key for code generation"
            },
            new ProviderConfig
            {
                Provider = "opencode",
                DisplayName = "OpenCode",
                EnvVar = "OPENCODE_API_KEY",
                Description = "OpenCode API key for open-source coding agents"
            },
            new ProviderConfig
            {
                Provider = "llmtornado",
                DisplayName = "LlmTornado",
                EnvVar = "ANTHROPIC_AUTH_TOKEN",
                Description = "Z.ai key routed through Anthropic-compatible settings (ANTHROPIC_BASE_URL)"
            },
            new ProviderConfig
            {
                Provider = "github",
                DisplayName = "GitHub",
                EnvVar = "GH_TOKEN",
                Description = "GitHub personal access token for repository operations"
            }
        });

        await LoadProviderSecretsAsync();
        await LoadAllHarnessSettingsAsync();
    }

    private async Task LoadProviderSecretsAsync()
    {
        try
        {
            var secrets = await RepositoryStore.ListProviderSecretsAsync(_selectedRepositoryId, CancellationToken.None);
            foreach (var secret in secrets)
            {
                var provider = _providers.FirstOrDefault(p => p.Provider == secret.Provider);
                if (provider is not null)
                {
                    provider.HasValue = true;
                    provider.UpdatedAt = secret.UpdatedAtUtc;
                    provider.Value = string.Empty;
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load provider secrets: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadAllHarnessSettingsAsync()
    {
        var tasks = _harnessSettings.Keys.Select(LoadHarnessSettingsAsync);
        await Task.WhenAll(tasks);
    }

    private async Task LoadHarnessSettingsAsync(string harness)
    {
        var state = _harnessSettings[harness];
        state.IsLoading = true;

        try
        {
            var settings = await RepositoryStore.GetHarnessProviderSettingsAsync(_selectedRepositoryId, harness, CancellationToken.None);
            if (settings is not null)
            {
                state.Model = settings.Model;
                state.Temperature = settings.Temperature;
                state.MaxTokens = settings.MaxTokens;
            }
            else
            {
                state.Model = string.Empty;
                state.Temperature = 0.7;
                state.MaxTokens = 4096;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load {harness} settings: {ex.Message}", Severity.Error);
        }
        finally
        {
            state.IsLoading = false;
        }
    }

    private async Task SaveHarnessSettingsAsync(string harness)
    {
        var state = _harnessSettings[harness];
        state.IsSaving = true;

        try
        {
            if (state.Temperature < 0 || state.Temperature > 2)
            {
                Snackbar.Add("Temperature must be between 0 and 2", Severity.Error);
                return;
            }

            if (state.MaxTokens < 1)
            {
                Snackbar.Add("Max tokens must be at least 1", Severity.Error);
                return;
            }

            await RepositoryStore.UpsertHarnessProviderSettingsAsync(
                _selectedRepositoryId,
                harness,
                state.Model,
                state.Temperature,
                state.MaxTokens,
                null,
                CancellationToken.None);

            Snackbar.Add($"{harness} settings saved successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving {harness} settings: {ex.Message}", Severity.Error);
        }
        finally
        {
            state.IsSaving = false;
        }
    }

    private RenderFragment RenderHarnessSettings(string harness, string displayName, List<string> models) => __builder =>
    {
        var state = _harnessSettings[harness];
        var lockModel = false;

        __builder.OpenElement(0, "div");
        __builder.AddAttribute(1, "class", "mud-width-full");

        __builder.OpenComponent<MudStack>(2);
        __builder.AddAttribute(3, "Spacing", 4);

        __builder.OpenRegion(4);

        if (state.IsLoading)
        {
            __builder.OpenComponent<MudProgressLinear>(5);
            __builder.AddAttribute(6, "Indeterminate", true);
            __builder.CloseComponent();
        }
        else
        {
            __builder.OpenComponent<MudText>(7);
            __builder.AddAttribute(8, "Typo", Typo.h6);
            __builder.AddAttribute(9, "Class", "mb-2");
            __builder.AddContent(10, $"{displayName} Configuration");
            __builder.CloseComponent();

            __builder.OpenComponent<MudDivider>(11);
            __builder.CloseComponent();

            __builder.OpenComponent<MudGrid>(12);
            __builder.AddAttribute(13, "Class", "mt-3");

            __builder.OpenComponent<MudItem>(14);
            __builder.AddAttribute(15, "xs", 12);
            __builder.AddAttribute(16, "md", 6);

            __builder.OpenComponent<MudSelect<string>>(17);
            __builder.AddAttribute(18, "Label", "Model");
            __builder.AddAttribute(19, "Variant", Variant.Outlined);
            __builder.AddAttribute(20, "HelperText", lockModel ? "GLM-5 is required for this harness." : "Select the AI model to use");
            __builder.AddAttribute(21, "Class", "mud-width-full");
            __builder.AddAttribute(22, "Value", state.Model);
            __builder.AddAttribute(23, "ValueChanged", EventCallback.Factory.Create<string>(this, v => state.Model = v));
            __builder.AddAttribute(24, "Disabled", lockModel);

            foreach (var model in models)
            {
                __builder.OpenComponent<MudSelectItem<string>>(25);
                __builder.AddAttribute(26, "Value", model);
                __builder.CloseComponent();
            }

            __builder.CloseComponent();
            __builder.CloseComponent();

            __builder.OpenComponent<MudItem>(26);
            __builder.AddAttribute(27, "xs", 12);
            __builder.AddAttribute(28, "md", 6);

            __builder.OpenComponent<MudNumericField<int>>(29);
            __builder.AddAttribute(30, "Label", "Max Tokens");
            __builder.AddAttribute(31, "Variant", Variant.Outlined);
            __builder.AddAttribute(32, "Min", 256);
            __builder.AddAttribute(33, "Max", 128000);
            __builder.AddAttribute(34, "HelperText", "Maximum tokens in response");
            __builder.AddAttribute(35, "Class", "mud-width-full");
            __builder.AddAttribute(36, "Value", state.MaxTokens);
            __builder.AddAttribute(37, "ValueChanged", EventCallback.Factory.Create<int>(this, v => state.MaxTokens = v));
            __builder.CloseComponent();

            __builder.CloseComponent();

            __builder.OpenComponent<MudItem>(38);
            __builder.AddAttribute(39, "xs", 12);

            __builder.OpenComponent<MudStack>(40);
            __builder.AddAttribute(41, "Spacing", 1);

            __builder.OpenComponent<MudText>(42);
            __builder.AddAttribute(43, "Typo", Typo.body2);
            __builder.AddContent(44, $"Temperature: {state.Temperature:F2}");
            __builder.CloseComponent();

            __builder.OpenComponent<MudSlider<double>>(45);
            __builder.AddAttribute(46, "Min", 0.0);
            __builder.AddAttribute(47, "Max", 2.0);
            __builder.AddAttribute(48, "Step", 0.1);
            __builder.AddAttribute(49, "Class", "mud-width-full");
            __builder.AddAttribute(50, "Value", state.Temperature);
            __builder.AddAttribute(51, "ValueChanged", EventCallback.Factory.Create<double>(this, v => state.Temperature = v));
            __builder.CloseComponent();

            __builder.CloseComponent();

            __builder.CloseComponent();

            __builder.OpenComponent<MudItem>(52);
            __builder.AddAttribute(53, "xs", 12);

            __builder.OpenComponent<MudButton>(54);
            __builder.AddAttribute(55, "Variant", Variant.Filled);
            __builder.AddAttribute(56, "Color", Color.Primary);
            __builder.AddAttribute(57, "StartIcon", Icons.Material.Filled.Save);
            __builder.AddAttribute(58, "Disabled", state.IsSaving);
            __builder.AddAttribute(59, "OnClick", EventCallback.Factory.Create<MouseEventArgs>(this, () => SaveHarnessSettingsAsync(harness)));

            if (state.IsSaving)
            {
                __builder.OpenComponent<MudProgressCircular>(60);
                __builder.AddAttribute(61, "Size", Size.Small);
                __builder.AddAttribute(62, "Indeterminate", true);
                __builder.CloseComponent();
                __builder.AddContent(63, " Saving...");
            }
            else
            {
                __builder.AddContent(64, "Save Settings");
            }

            __builder.CloseComponent();
            __builder.CloseComponent();

            __builder.CloseComponent();
        }

        __builder.CloseRegion();
        __builder.CloseComponent();
        __builder.CloseElement();
    };

    private async Task SaveProviderSecretAsync(ProviderConfig provider)
    {
        if (string.IsNullOrWhiteSpace(provider.Value))
        {
            Snackbar.Add("Secret value cannot be empty", Severity.Warning);
            return;
        }

        try
        {
            var encrypted = SecretCrypto.Encrypt(provider.Value.Trim());
            await RepositoryStore.UpsertProviderSecretAsync(
                _selectedRepositoryId,
                provider.Provider.Trim().ToLowerInvariant(),
                encrypted,
                CancellationToken.None);

            provider.HasValue = true;
            provider.UpdatedAt = DateTime.UtcNow;
            provider.Value = string.Empty;
            Snackbar.Add($"{provider.DisplayName} secret saved successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving {provider.DisplayName} secret: {ex.Message}", Severity.Error);
        }
    }

    private async Task TestConnectionAsync(ProviderConfig provider)
    {
        provider.Testing = true;
        StateHasChanged();

        try
        {
            if (!string.IsNullOrWhiteSpace(provider.Value))
            {
                var (success, message) = await CredentialValidator.ValidateAsync(provider.Provider, provider.Value, CancellationToken.None);
                Snackbar.Add(
                    $"{provider.DisplayName}: {message}",
                    success ? Severity.Success : Severity.Error);
            }
            else if (provider.HasValue)
            {
                var secret = await RepositoryStore.GetProviderSecretAsync(
                    _selectedRepositoryId,
                    provider.Provider.Trim().ToLowerInvariant(),
                    CancellationToken.None);

                if (secret is null)
                {
                    Snackbar.Add($"{provider.DisplayName}: Secret not found", Severity.Error);
                    return;
                }

                var decrypted = SecretCrypto.Decrypt(secret.EncryptedValue);
                var (success, message) = await CredentialValidator.ValidateAsync(provider.Provider, decrypted, CancellationToken.None);
                Snackbar.Add(
                    $"{provider.DisplayName}: {message}",
                    success ? Severity.Success : Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error testing {provider.DisplayName}: {ex.Message}", Severity.Error);
        }
        finally
        {
            provider.Testing = false;
            StateHasChanged();
        }
    }

    private async Task SaveSystemSettingsAsync()
    {
        try
        {
            var dockerImages = _dockerAllowedImagesInput
                .Split(',')
                .Select(s => s.Trim())
                .Where(s => !string.IsNullOrWhiteSpace(s))
                .ToList();

            var settings = await SystemStore.GetSettingsAsync(CancellationToken.None);
            settings.DockerAllowedImages = dockerImages;
            settings.RetentionDaysLogs = _retentionDaysLogs;
            settings.RetentionDaysRuns = _retentionDaysRuns;
            settings.VictoriaMetricsEndpoint = _victoriaMetricsEndpoint;
            settings.VmUiEndpoint = _vmUiEndpoint;

            await SystemStore.UpdateSettingsAsync(settings, CancellationToken.None);
            Snackbar.Add("System settings saved successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving system settings: {ex.Message}", Severity.Error);
        }
    }
}
