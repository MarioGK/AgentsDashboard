@page "/settings/projects"
@page "/settings/repositories"
@layout SettingsLayout
@rendermode InteractiveServer
@inject IRepositoryStore Store
@inject IGitWorkspaceService GitWorkspace
@inject IHostFileExplorerService FileExplorer
@inject SecretCryptoService Crypto
@inject NavigationManager Nav
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@using System.IO


@namespace AgentsDashboard.ControlPlane.Components.Pages
<PageTitle>Repositories</PageTitle>

<MudStack Spacing="2">
    <MudStack Row AlignItems="AlignItems.Center">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
            <MudText Typo="Typo.h4">Repositories</MudText>
            <SettingsHintIcon Text="Register git repositories used by orchestration tasks and runtime workflows." />
        </MudStack>
    </MudStack>

    <MudPaper Class="pa-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mb-3">
            <MudText Typo="Typo.h6">Create Repository</MudText>
            <SettingsHintIcon Text="Create validates workspace clone/fetch, then stores repository metadata and optional GitHub token." />
        </MudStack>

        <MudGrid>
            <MudItem xs="12" md="3">
                <SettingsHintedField ContainerClass="" Hint="Friendly name shown throughout the dashboard.">
                    <MudTextField @bind-Value="_newRepositoryName"
                                  Label="Repository Name"
                                  Placeholder="Repository Name"
                                  Required="true"
                                  data-testid="repo-create-name" />
                </SettingsHintedField>
            </MudItem>
            <MudItem xs="12" md="5">
                <SettingsHintedField ContainerClass="" Hint="Clone/fetch source URL. HTTPS and SSH remotes are supported if credentials are available.">
                    <MudTextField @bind-Value="_newRepositoryGitUrl"
                                  Label="Git URL"
                                  Placeholder="https://github.com/org/repo.git"
                                  Required="true"
                                  data-testid="repo-create-git-url" />
                </SettingsHintedField>
            </MudItem>
            <MudItem xs="12" md="2">
                <SettingsHintedField ContainerClass="" Hint="Initial branch used for workspace checkout and task defaults.">
                    <MudTextField @bind-Value="_newRepositoryDefaultBranch"
                                  Label="Default Branch"
                                  Placeholder="main"
                                  Required="true"
                                  data-testid="repo-create-default-branch" />
                </SettingsHintedField>
            </MudItem>
            <MudItem xs="12" md="2" Class="d-flex align-center">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           Disabled="@_isCreating"
                           OnClick="CreateRepositoryAsync"
                           data-testid="repo-create-submit">
                    @if (_isCreating)
                    {
                        <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
                        <span>Creating...</span>
                    }
                    else
                    {
                        <span>Create</span>
                    }
                </MudButton>
            </MudItem>
        </MudGrid>

        <MudGrid Class="mt-2">
            <MudItem xs="12" md="8">
                <SettingsHintedField ContainerClass="" Hint="Absolute filesystem path where repository will be cloned or refreshed.">
                    <MudTextField @bind-Value="_newRepositoryLocalPath"
                                  Label="Local Folder"
                                  Placeholder="/absolute/path"
                                  Required="true"
                                  data-testid="repo-create-local-path" />
                </SettingsHintedField>
            </MudItem>
            <MudItem xs="12" md="4" Class="d-flex align-center">
                <MudButton Variant="Variant.Outlined" Color="Color.Info" OnClick="OpenFolderDialogAsync" Class="mr-2">Browse</MudButton>
            </MudItem>
        </MudGrid>
        <MudGrid Class="mt-2">
            <MudItem xs="12" md="8">
                <SettingsHintedField ContainerClass="" Hint="Optional token used for private repository access and persisted as encrypted provider secret.">
                    <MudTextField @bind-Value="_newRepositoryGithubToken"
                                  Label="GitHub Token (optional)"
                                  InputType="InputType.Password"
                                  data-testid="repo-create-github-token" />
                </SettingsHintedField>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudTable Items="_repositories" Dense Hover>
        <HeaderContent>
            <MudTh>Name</MudTh>
            <MudTh>Git URL</MudTh>
            <MudTh>Local Path</MudTh>
            <MudTh>Branch</MudTh>
            <MudTh>Ahead/Behind</MudTh>
            <MudTh>Staged/Modified/Untracked</MudTh>
            <MudTh></MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>@context.Name</MudTd>
            <MudTd>@context.GitUrl</MudTd>
            <MudTd>@context.LocalPath</MudTd>
            <MudTd>@(string.IsNullOrWhiteSpace(context.CurrentBranch) ? "-" : context.CurrentBranch)</MudTd>
            <MudTd>@context.AheadCount/@context.BehindCount</MudTd>
            <MudTd>@context.StagedCount/@context.ModifiedCount/@context.UntrackedCount</MudTd>
            <MudTd>
                <MudButtonGroup Variant="Variant.Outlined">
                    <MudButton Color="Color.Primary"
                               OnClick='@(() => Nav.NavigateTo($"/settings/repositories/{context.Id}"))'
                               data-testid="@($"repo-open-{context.Id}")">
                        Open
                    </MudButton>
                    <MudButton Color="Color.Info" OnClick="() => RefreshRepositoryAsync(context, true)">
                        Refresh
                    </MudButton>
                    <MudButton Color="Color.Error" OnClick="() => ConfirmDeleteRepositoryAsync(context)">
                        Delete
                    </MudButton>
                </MudButtonGroup>
            </MudTd>
        </RowTemplate>
    </MudTable>
</MudStack>

<MudDialog @bind-Visible="_folderDialogOpen" Options="_folderDialogOptions">
    <DialogContent>
        <MudStack Spacing="2">
            <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                <MudText Typo="Typo.h6">Folder Explorer</MudText>
                <MudText Typo="Typo.caption">@_browserPath</MudText>
            </MudStack>

            <MudStack Row Spacing="1">
                <MudButton Variant="Variant.Text" OnClick="NavigateUpAsync">Up</MudButton>
                <MudButton Variant="Variant.Text" OnClick="LoadDirectoriesAsync">Refresh</MudButton>
            </MudStack>

            <MudGrid>
                <MudItem xs="12" md="8">
                    <MudTextField @bind-Value="_newFolderName" Label="Create Folder" Placeholder="folder-name" />
                </MudItem>
                <MudItem xs="12" md="4" Class="d-flex align-center">
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="CreateFolderAsync">Create Folder</MudButton>
                </MudItem>
            </MudGrid>

            @if (_directories.Count == 0)
            {
                <MudText Typo="Typo.caption">No subfolders in current path.</MudText>
            }
            else
            {
                <MudChipSet T="string">
                    @foreach (var dir in _directories)
                    {
                        <MudChip T="string" OnClick="() => EnterDirectoryAsync(dir.FullPath)">@dir.Name</MudChip>
                    }
                </MudChipSet>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" Color="Color.Default" OnClick="CloseFolderDialog">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="UseCurrentFolderAndClose">Use This Folder</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private readonly List<RepositoryDocument> _repositories = [];

    private string _newRepositoryName = string.Empty;
    private string _newRepositoryGitUrl = string.Empty;
    private string _newRepositoryLocalPath = string.Empty;
    private string _newRepositoryDefaultBranch = "main";
    private string _newRepositoryGithubToken = string.Empty;
    private bool _isCreating;

    private string _browserPath = Path.GetPathRoot(System.Environment.CurrentDirectory) ?? "/";
    private readonly List<HostDirectoryEntry> _directories = [];
    private string _newFolderName = string.Empty;
    private bool _folderDialogOpen;
    private readonly DialogOptions _folderDialogOptions = new() { MaxWidth = MaxWidth.Medium, FullWidth = true, CloseOnEscapeKey = true };

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task CreateRepositoryAsync()
    {
        if (_isCreating)
        {
            return;
        }

        if (string.IsNullOrWhiteSpace(_newRepositoryName) ||
            string.IsNullOrWhiteSpace(_newRepositoryGitUrl) ||
            string.IsNullOrWhiteSpace(_newRepositoryLocalPath))
        {
            Snackbar.Add("Repository name, git URL, and local folder are required.", Severity.Warning);
            return;
        }

        try
        {
            _isCreating = true;
            var gitStatus = await GitWorkspace.EnsureWorkspaceAsync(
                _newRepositoryGitUrl.Trim(),
                _newRepositoryLocalPath.Trim(),
                string.IsNullOrWhiteSpace(_newRepositoryDefaultBranch) ? "main" : _newRepositoryDefaultBranch.Trim(),
                githubToken: string.IsNullOrWhiteSpace(_newRepositoryGithubToken) ? null : _newRepositoryGithubToken.Trim(),
                fetchRemote: true,
                CancellationToken.None);

            var created = await Store.CreateRepositoryAsync(
                new CreateRepositoryRequest(
                    _newRepositoryName.Trim(),
                    _newRepositoryGitUrl.Trim(),
                    _newRepositoryLocalPath.Trim(),
                    string.IsNullOrWhiteSpace(_newRepositoryDefaultBranch) ? "main" : _newRepositoryDefaultBranch.Trim()),
                CancellationToken.None);

            if (!string.IsNullOrWhiteSpace(_newRepositoryGithubToken))
            {
                await Store.UpsertProviderSecretAsync(created.Id, "github", Crypto.Encrypt(_newRepositoryGithubToken.Trim()), CancellationToken.None);
            }

            await Store.UpdateRepositoryGitStateAsync(created.Id, gitStatus, CancellationToken.None);

            _newRepositoryName = string.Empty;
            _newRepositoryGitUrl = string.Empty;
            _newRepositoryLocalPath = string.Empty;
            _newRepositoryDefaultBranch = "main";
            _newRepositoryGithubToken = string.Empty;

            await LoadAsync();
            Snackbar.Add("Repository created and cloned successfully.", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Repository create failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isCreating = false;
        }
    }

    private async Task LoadAsync()
    {
        _repositories.Clear();
        _repositories.AddRange(await Store.ListRepositoriesAsync(CancellationToken.None));
    }

    private async Task RefreshRepositoryAsync(RepositoryDocument repository, bool fetchRemote)
    {
        try
        {
            var githubToken = await TryGetGithubTokenAsync(repository.Id);
            var gitStatus = await GitWorkspace.RefreshStatusAsync(repository, githubToken, fetchRemote, CancellationToken.None);
            await Store.UpdateRepositoryGitStateAsync(repository.Id, gitStatus, CancellationToken.None);
            await LoadAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Refresh failed for {repository.Name}: {ex.Message}", Severity.Warning);
        }
    }

    private async Task<string?> TryGetGithubTokenAsync(string repositoryId)
    {
        var secret = await Store.GetProviderSecretAsync(repositoryId, "github", CancellationToken.None);
        if (secret is null)
        {
            return null;
        }

        try
        {
            return Crypto.Decrypt(secret.EncryptedValue);
        }
        catch
        {
            return null;
        }
    }

    private async Task ConfirmDeleteRepositoryAsync(RepositoryDocument repo)
    {
        var result = await DialogService.ShowMessageBoxAsync(
            "Delete Repository",
            $"Are you sure you want to delete repository '{repo.Name}'? This will also delete all tasks and runs.",
            yesText: "Delete",
            cancelText: "Cancel");

        if (result == true)
        {
            await Store.DeleteRepositoryAsync(repo.Id, CancellationToken.None);
            await LoadAsync();
        }
    }

    private async Task LoadDirectoriesAsync()
    {
        try
        {
            _directories.Clear();
            _directories.AddRange(await FileExplorer.ListDirectoriesAsync(_browserPath, CancellationToken.None));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Browse failed: {ex.Message}", Severity.Warning);
        }
    }

    private async Task OpenFolderDialogAsync()
    {
        var localPath = _newRepositoryLocalPath.Trim();
        if (!string.IsNullOrWhiteSpace(localPath) && Path.IsPathRooted(localPath))
        {
            var resolved = Path.GetFullPath(localPath);
            if (Directory.Exists(resolved))
            {
                _browserPath = resolved;
            }
            else
            {
                var parent = Directory.GetParent(resolved)?.FullName;
                if (!string.IsNullOrWhiteSpace(parent) && Directory.Exists(parent))
                {
                    _browserPath = parent;
                }
            }
        }

        _newFolderName = string.Empty;
        await LoadDirectoriesAsync();
        _folderDialogOpen = true;
    }

    private async Task NavigateUpAsync()
    {
        try
        {
            var current = Path.GetFullPath(_browserPath);
            var parent = Directory.GetParent(current)?.FullName;
            if (!string.IsNullOrWhiteSpace(parent))
            {
                _browserPath = parent;
                await LoadDirectoriesAsync();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Cannot navigate up: {ex.Message}", Severity.Warning);
        }
    }

    private async Task EnterDirectoryAsync(string path)
    {
        _browserPath = path;
        await LoadDirectoriesAsync();
    }

    private void UseCurrentFolderAndClose()
    {
        _newRepositoryLocalPath = _browserPath;
        _folderDialogOpen = false;
    }

    private void CloseFolderDialog()
    {
        _folderDialogOpen = false;
    }

    private async Task CreateFolderAsync()
    {
        if (string.IsNullOrWhiteSpace(_newFolderName))
        {
            return;
        }

        try
        {
            var created = await FileExplorer.CreateDirectoryAsync(_browserPath, _newFolderName.Trim(), CancellationToken.None);
            _browserPath = created;
            _newFolderName = string.Empty;
            await LoadDirectoriesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Create folder failed: {ex.Message}", Severity.Warning);
        }
    }
}
