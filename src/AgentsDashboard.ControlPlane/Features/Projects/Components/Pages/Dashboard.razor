@page "/overview"
@rendermode InteractiveServer
@inject IRunStore RunStore
@inject IGlobalSelectionService SelectionService
@inject ITaskRuntimeLifecycleManager WorkerLifecycle
@inject TaskRuntimeHealthSupervisorService TaskRuntimeHealthSupervisor
@inject NavigationManager NavigationManager

@using AgentsDashboard.ControlPlane.Features.Projects.Components.Pages.Models

@namespace AgentsDashboard.ControlPlane.Components.Pages
<PageTitle>Overview</PageTitle>

@if (_loading)
{
    <MudStack Class="overview-loading" AlignItems="AlignItems.Center" Justify="Justify.Center">
        <MudProgressCircular Indeterminate="true" Size="Size.Large" />
    </MudStack>
}
else
{
    <MudStack Spacing="3" Class="overview-shell">
        <MudPaper Class="overview-hero" Elevation="0">
            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-2">
                <MudText Typo="Typo.h4">Overview</MudText>
                <MudButton Variant="Variant.Outlined" Color="Color.Info" OnClick="LoadDataAsync">Refresh</MudButton>
            </MudStack>
            <MudText Typo="Typo.body2" Class="overview-hero-subtitle">@GetScopeText()</MudText>
            <MudText Typo="Typo.caption">Focused operational metrics only.</MudText>
        </MudPaper>

        @if (!string.IsNullOrWhiteSpace(_workerRuntimeMessage))
        {
            <MudAlert Severity="Severity.Warning" Variant="Variant.Text" Dense="true">@_workerRuntimeMessage</MudAlert>
        }

        @if (!string.IsNullOrWhiteSpace(_taskRuntimeHealthError))
        {
            <MudAlert Severity="Severity.Warning" Variant="Variant.Text" Dense="true">@_taskRuntimeHealthError</MudAlert>
        }

        <MudGrid>
            <MudItem xs="12" sm="6" lg="4" xl="2">
                <MudPaper Class="overview-stat-card" Elevation="0">
                    <MudText Typo="Typo.caption">Active Runs</MudText>
                    <MudText Typo="Typo.h4">@_activeRuns</MudText>
                    <MudText Typo="Typo.caption">Queued, running, and pending approval</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" lg="4" xl="2">
                <MudPaper Class="overview-stat-card" Elevation="0">
                    <MudText Typo="Typo.caption">Queued Runs</MudText>
                    <MudText Typo="Typo.h4">@_queuedRuns</MudText>
                    <MudText Typo="Typo.caption">Awaiting execution</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" lg="4" xl="2">
                <MudPaper Class="overview-stat-card" Elevation="0">
                    <MudText Typo="Typo.caption">Failures</MudText>
                    <MudText Typo="Typo.h4">@_failureRuns</MudText>
                    <MudText Typo="Typo.caption">Failed + cancelled terminal runs</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" lg="4" xl="2">
                <MudPaper Class="overview-stat-card" Elevation="0">
                    <MudText Typo="Typo.caption">Worker Readiness</MudText>
                    <MudText Typo="Typo.h4">@GetWorkerReadinessText()</MudText>
                    <MudText Typo="Typo.caption">Ready / Total workers</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" lg="4" xl="2">
                <MudPaper Class="overview-stat-card" Elevation="0">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-1">
                        <MudText Typo="Typo.caption">Runtime Health</MudText>
                        <MudChip T="string" Size="Size.Small" Color="@GetRuntimeHealthColor()">@GetRuntimeHealthText()</MudChip>
                    </MudStack>
                    <MudText Typo="Typo.h5">@_taskRuntimeHealth.HealthyRuntimes / @_taskRuntimeHealth.TotalRuntimes</MudText>
                    <MudText Typo="Typo.caption">Healthy / Total runtimes</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" lg="4" xl="2">
                <MudPaper Class="overview-stat-card" Elevation="0">
                    <MudText Typo="Typo.caption">Last Refresh</MudText>
                    <MudText Typo="Typo.h6">@GetLastRefreshText()</MudText>
                    <MudText Typo="Typo.caption">Local time</MudText>
                </MudPaper>
            </MudItem>
        </MudGrid>

        <MudGrid>
            <MudItem xs="12" lg="7">
                <MudPaper Class="overview-card" Elevation="0">
                    <MudText Typo="Typo.h6" Class="mb-2">Recent Runs</MudText>

                    @if (_runs.Count == 0)
                    {
                        <MudText Typo="Typo.body2">No runs available for the current selection.</MudText>
                    }
                    else
                    {
                        <MudList T="RunDocument" Dense="true">
                            @foreach (var run in _runs.Take(8))
                            {
                                var status = TaskRunStatusPresentation.FromRunState(run.State);
                                <MudListItem>
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Style="width:100%">
                                        <MudStack Spacing="0">
                                            <MudLink Href="@($"/settings/runs/{run.Id}")">@GetRunDisplayId(run.Id)</MudLink>
                                            <MudText Typo="Typo.caption">@run.CreatedAtUtc.ToLocalTime().ToString("g")</MudText>
                                        </MudStack>
                                        <MudChip T="string" Size="Size.Small" Color="@status.Color">@status.Label</MudChip>
                                    </MudStack>
                                </MudListItem>
                            }
                        </MudList>
                    }
                </MudPaper>
            </MudItem>

            <MudItem xs="12" lg="5">
                <MudPaper Class="overview-card" Elevation="0">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-2">
                        <MudText Typo="Typo.h6">Quick Links</MudText>
                        <MudLink Href="/settings">All settings</MudLink>
                    </MudStack>

                    <MudGrid>
                        @foreach (var link in _quickLinks)
                        {
                            <MudItem xs="12" sm="6">
                                <MudPaper Class="overview-quick-action" Elevation="0" @onclick="() => NavigationManager.NavigateTo(link.Href)">
                                    <MudIcon Icon="@link.Icon" Class="mr-2" />
                                    <div>
                                        <MudText Typo="Typo.subtitle2">@link.Title</MudText>
                                        <MudText Typo="Typo.caption">@link.Description</MudText>
                                    </div>
                                </MudPaper>
                            </MudItem>
                        }
                    </MudGrid>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudStack>
}
