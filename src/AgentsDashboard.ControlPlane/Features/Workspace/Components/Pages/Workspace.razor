@page "/workspace"
@page "/"
@rendermode InteractiveServer
@using System.Text
@using System.Text.Json
@using AgentsDashboard.ControlPlane.Components.Shared
@using AgentsDashboard.ControlPlane.Components.Workspace
@using AgentsDashboard.ControlPlane.Components.Workspace.Models

@inject IRepositoryStore RepositoryStore
@inject ITaskStore TaskStore
@inject IRunStore RunStore
@inject IGlobalSelectionService SelectionService
@inject IWorkspaceService WorkspaceService
@inject IWorkspaceAiService WorkspaceAiService
@inject IRunStructuredViewService RunStructuredViewService
@inject IHarnessOutputParserService HarnessOutputParser
@inject IUiRealtimeBroker UiRealtimeBroker
@inject ISnackbar Snackbar
@inject IJSRuntime JS
@inject IDialogService DialogService
@implements IAsyncDisposable

@namespace AgentsDashboard.ControlPlane.Components.Pages
<PageTitle>Workspace</PageTitle>

<MudStack Class="workspace-page workspace-chat-page" Spacing="2">
    <MudText Typo="Typo.h5">Workspace</MudText>
    @if (_loading)
    {
        <MudStack Class="overview-loading" AlignItems="AlignItems.Center" Justify="Justify.Center">
            <MudProgressCircular Indeterminate="true" Size="Size.Large" />
        </MudStack>
    }
    else
    {
        <div class="@GetWorkspaceShellClass()">
            <WorkspaceLeftRail IsCollapsed="@_leftRailCollapsed"
                               RepositoryFilter="@_repositoryFilter"
                               TaskFilter="@_taskFilter"
                               NewTaskDisabled="@(_selectedRepository is null)"
                               RepositoryGroups="@LeftRailRepositoryGroups"
                               Threads="@ThreadStates"
                               OnToggleCollapsed="ToggleLeftRail"
                               OnRepositoryFilterChanged="OnRepositoryFilterChangedAsync"
                               OnTaskFilterChanged="OnTaskFilterChangedAsync"
                               OnRepositorySelected="SelectRepositoryFromRailAsync"
                               OnThreadSelected="SelectTaskAsync"
                               OnThreadDeleteRequested="DeleteTaskAsync"
                               OnNewTask="StartNewTaskComposerAsync" />

            <div class="workspace-chat-main-pane">
                @if (_selectedRepository is null)
                {
                    <MudPaper Class="workspace-empty-state" Elevation="0">
                        <MudText Typo="Typo.h6">No repositories available</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Add a repository in settings, then return to Workspace.</MudText>
                    </MudPaper>
                }
                else
                {
                    <WorkspaceThreadChat TaskName="@GetActiveTaskTitle()"
                                         Harness="@GetActiveTaskHarness()"
                                         TaskStateLabel="@GetActiveTaskStateLabel()"
                                         TaskStateColor="@GetActiveTaskStateColor()"
                                         RunIdLabel="@GetSelectedRunShortId()"
                                         RunStateLabel="@GetSelectedRunStateLabel()"
                                         RunStateColor="@GetSelectedRunStateColor()"
                                         IsRunActive="@IsSelectedRunActive"
                                         IsPlanModeEnabled="@(_composerModeOverride == HarnessExecutionMode.Plan)"
                                         CanRefreshSummary="@(_selectedRun is not null)"
                                         IsAdvancedOpen="@_historyPanelOpen"
                                         OnRefreshSummary="RefreshSelectedRunSummaryAsync"
                                         OnRefreshRuns="RefreshSelectedRepositoryAsync"
                                         OnPlanModeChanged="OnPlanModeChangedAsync"
                                         OnToggleAdvanced="ToggleHistoryPanel">
                        <MessageList>
                            <WorkspaceThreadMessageList Messages="@ProjectedMessages" />
                        </MessageList>
                        <ContextPanel>
                            <WorkspaceQuestionInbox QuestionRequests="@_selectedRunQuestionRequests"
                                                    Disabled="@_isSubmittingQuestionAnswers"
                                                    OnSubmit="SubmitQuestionAnswersAsync" />
                        </ContextPanel>
                        <Composer>
                            <WorkspaceThreadComposerBar ComposerInputId="@_composerInputId"
                                                        ComposerValue="@_composerValue"
                                                        OnComposerValueChanged="OnComposerValueChangedAsync"
                                                        ComposerImages="@_composerImages"
                                                        OnComposerImagesChanged="OnComposerImagesChangedAsync"
                                                        IsSubmitting="@_isSubmittingComposer"
                                                        IsComposerBlocked="@IsComposerBlocked"
                                                        ComposerBlockReason="@ComposerBlockedReason"
                                                        ComposerHelperText="@ComposerHelperText"
                                                        GhostSuffix="@_composerGhostSuffix"
                                                        SubmitRequested="SubmitComposerAsync"
                                                        OnImprove="OpenImprovePromptDraftDialogAsync"
                                                        OnGenerate="OpenGeneratePromptDraftDialogAsync"
                                                        OnComposerKeyDown="OnComposerKeyDown"
                                                        OnValidationError="ShowComposerValidationAsync" />
                        </Composer>
                    </WorkspaceThreadChat>
                }
            </div>

            <WorkspaceAdvancedDrawer IsOpen="@_historyPanelOpen" CloseRequested="CloseHistoryPanel">
                @if (_selectedTask is null)
                {
                    <MudPaper Class="workspace-empty-state" Elevation="0">
                        <MudText Typo="Typo.subtitle1">No task selected</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Select a task to inspect timeline, tools, diff, raw output, and history.</MudText>
                    </MudPaper>
                }
                else
                {
                    <div class="workspace-advanced-grid">
                        <MudPaper Class="workspace-console-panel" Elevation="0">
                            <MudStack Row AlignItems="AlignItems.Center" Class="workspace-console-header">
                                <MudText Typo="Typo.subtitle1">Advanced Diagnostics</MudText>
                                <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">@_selectedTask.Name</MudChip>
                                @if (_selectedRun is not null)
                                {
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">Run @GetSelectedRunShortId()</MudChip>
                                    <MudChip T="string" Size="Size.Small" Color="@GetStateColor(_selectedRun.State)">@_selectedRun.State</MudChip>
                                }
                            </MudStack>

                            <MudTabs Elevation="0" Rounded>
                                <MudTabPanel Text="Timeline" Icon="@Icons.Material.Filled.Timeline">
                                    <div class="workspace-console-scroll">
                                        @if (_selectedRun is null)
                                        {
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">No executions found for this task.</MudText>
                                        }
                                        else
                                        {
                                            <MudStack Spacing="1">
                                                <MudGrid Class="mb-1">
                                                    <MudItem xs="6" md="2">
                                                        <MudPaper Class="workspace-structured-section" Elevation="0">
                                                            <MudText Typo="Typo.caption" Color="Color.Secondary">Thinking</MudText>
                                                            <MudText Typo="Typo.h6">@_selectedRunStructuredView.Thinking.Count</MudText>
                                                        </MudPaper>
                                                    </MudItem>
                                                    <MudItem xs="6" md="2">
                                                        <MudPaper Class="workspace-structured-section" Elevation="0">
                                                            <MudText Typo="Typo.caption" Color="Color.Secondary">Tools</MudText>
                                                            <MudText Typo="Typo.h6">@_selectedRunStructuredView.Tools.Count</MudText>
                                                        </MudPaper>
                                                    </MudItem>
                                                    <MudItem xs="6" md="2">
                                                        <MudPaper Class="workspace-structured-section" Elevation="0">
                                                            <MudText Typo="Typo.caption" Color="Color.Secondary">Diff</MudText>
                                                            <MudText Typo="Typo.h6">@RunDiffParser.Parse(GetWorkspaceResolvedDiffPatch()).Count</MudText>
                                                        </MudPaper>
                                                    </MudItem>
                                                    <MudItem xs="6" md="3">
                                                        <MudPaper Class="workspace-structured-section" Elevation="0">
                                                            <MudText Typo="Typo.caption" Color="Color.Secondary">Summary</MudText>
                                                            <MudText Typo="Typo.body2">@TruncateForDisplay(_selectedRunAiSummary?.Summary ?? _selectedRunParsed?.Summary ?? GetRunSummary(_selectedRun), 120)</MudText>
                                                        </MudPaper>
                                                    </MudItem>
                                                    <MudItem xs="12" md="3">
                                                        <MudPaper Class="workspace-structured-section workspace-structured-section-error" Elevation="0">
                                                            <MudText Typo="Typo.caption" Color="Color.Secondary">Errors</MudText>
                                                            <MudText Typo="Typo.body2">@TruncateForDisplay(_selectedRunParsed?.Error ?? string.Empty, 120)</MudText>
                                                        </MudPaper>
                                                    </MudItem>
                                                </MudGrid>

                                                @if (!string.IsNullOrWhiteSpace(_selectedRunAiSummary?.Summary))
                                                {
                                                    <MudAlert Severity="Severity.Info">
                                                        <MudText Typo="Typo.caption">@(_selectedRunAiSummary.Title == string.Empty ? "AI Summary" : _selectedRunAiSummary.Title)</MudText>
                                                        <MudText Typo="Typo.body2">@_selectedRunAiSummary.Summary</MudText>
                                                    </MudAlert>
                                                }

                                                @if (_selectedRunParsed is not null)
                                                {
                                                    <MudStack Row Spacing="1">
                                                        <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">Status: @_selectedRunParsed.Status</MudChip>
                                                        @if (_selectedRunParsed.ToolCallGroups.Count > 0)
                                                        {
                                                            <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">Tools: @_selectedRunParsed.ToolCallGroups.Count</MudChip>
                                                        }
                                                        @if (_selectedRunParsed.RawStream.Count > 0)
                                                        {
                                                            <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">Stream: @_selectedRunParsed.RawStream.Count lines</MudChip>
                                                        }
                                                    </MudStack>

                                                    @if (_selectedRunParsed.Summary != string.Empty)
                                                    {
                                                        <MudPaper Class="workspace-structured-section" Elevation="0">
                                                            <MudText Typo="Typo.caption">Summary</MudText>
                                                            <MudText Typo="Typo.body2">@_selectedRunParsed.Summary</MudText>
                                                        </MudPaper>
                                                    }

                                                    @if (_selectedRunParsed.Error != string.Empty)
                                                    {
                                                        <MudPaper Class="workspace-structured-section workspace-structured-section-error" Elevation="0">
                                                            <MudText Typo="Typo.caption">Error</MudText>
                                                            <MudText Typo="Typo.body2">@_selectedRunParsed.Error</MudText>
                                                        </MudPaper>
                                                    }

                                                    @foreach (var parsedSection in _selectedRunParsed.Sections.Where(section => section.Key != "summary" && section.Key != "error" && section.Key != "raw_json"))
                                                    {
                                                        <MudPaper Class="workspace-structured-section" Elevation="0">
                                                            <MudText Typo="Typo.caption">@parsedSection.Title</MudText>
                                                            <MudText Typo="Typo.body2">@parsedSection.Content</MudText>
                                                        </MudPaper>
                                                    }

                                                    @if (_selectedRunParsed.ToolCallGroups.Count > 0)
                                                    {
                                                        <MudText Typo="Typo.subtitle2" Class="mt-2">Tool Call Timeline</MudText>
                                                        <MudTimeline TimelinePosition="TimelinePosition.Start" TimelineOrientation="TimelineOrientation.Vertical">
                                                            @foreach (var toolGroup in _selectedRunParsed.ToolCallGroups)
                                                            {
                                                                <MudTimelineItem Color="Color.Info" Size="Size.Small">
                                                                    <ItemOpposite>
                                                                        <MudText Typo="Typo.caption">@toolGroup.ToolName</MudText>
                                                                    </ItemOpposite>
                                                                    <ItemContent>
                                                                        <MudPaper Class="workspace-structured-section" Elevation="0">
                                                                            <MudText Typo="Typo.caption">@toolGroup.Entries.Count entries</MudText>
                                                                            @foreach (var entry in toolGroup.Entries.Take(6))
                                                                            {
                                                                                <MudText Typo="Typo.caption">@entry.TimestampUtc.ToLocalTime().ToString("HH:mm:ss") @entry.Message</MudText>
                                                                            }
                                                                        </MudPaper>
                                                                    </ItemContent>
                                                                </MudTimelineItem>
                                                            }
                                                        </MudTimeline>
                                                    }
                                                }

                                                @if (_selectedRunLogs.Count == 0)
                                                {
                                                    <MudText Typo="Typo.body2" Color="Color.Secondary">No logs captured yet.</MudText>
                                                }
                                                else
                                                {
                                                    <MudText Typo="Typo.subtitle2" Class="mt-2">Live Stream</MudText>
                                                    @foreach (var log in _selectedRunLogs.TakeLast(120))
                                                    {
                                                        <MudText Typo="Typo.body2" Class="workspace-console-line">[@log.TimestampUtc.ToLocalTime().ToString("HH:mm:ss")] @log.Message</MudText>
                                                    }
                                                }
                                            </MudStack>
                                        }
                                    </div>
                                    @if (_selectedRun is not null && _selectedRun.State is RunState.Running or RunState.Queued or RunState.PendingApproval)
                                    {
                                        <MudProgressLinear Indeterminate="true" Color="Color.Info" />
                                    }
                                </MudTabPanel>

                                <MudTabPanel Text="Thinking" Icon="@Icons.Material.Filled.Psychology">
                                    <div class="workspace-console-scroll">
                                        @if (_selectedRun is null)
                                        {
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">No run selected.</MudText>
                                        }
                                        else if (_selectedRunStructuredView.Thinking.Count == 0)
                                        {
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">No thinking events captured.</MudText>
                                        }
                                        else
                                        {
                                            @foreach (var item in _selectedRunStructuredView.Thinking.TakeLast(160))
                                            {
                                                <MudText Typo="Typo.body2" Class="workspace-console-line">[@item.TimestampUtc.ToLocalTime().ToString("HH:mm:ss")] @item.Content</MudText>
                                            }
                                        }
                                    </div>
                                </MudTabPanel>

                                <MudTabPanel Text="Tools" Icon="@Icons.Material.Filled.Build">
                                    <div class="workspace-console-scroll">
                                        @if (_selectedRun is null)
                                        {
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">No run selected.</MudText>
                                        }
                                        else if (_selectedRunStructuredView.Tools.Count == 0)
                                        {
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">No tool lifecycle events captured.</MudText>
                                        }
                                        else
                                        {
                                            @foreach (var tool in _selectedRunStructuredView.Tools.TakeLast(240))
                                            {
                                                <MudPaper Class="workspace-structured-section" Elevation="0">
                                                    <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                                                        <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">@tool.ToolName</MudChip>
                                                        <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">@tool.State</MudChip>
                                                        @if (!string.IsNullOrWhiteSpace(tool.ToolCallId))
                                                        {
                                                            <MudText Typo="Typo.caption" Color="Color.Secondary">@tool.ToolCallId</MudText>
                                                        }
                                                        <MudSpacer />
                                                        <MudText Typo="Typo.caption">@tool.TimestampUtc.ToLocalTime().ToString("HH:mm:ss")</MudText>
                                                    </MudStack>
                                                </MudPaper>
                                            }
                                        }
                                    </div>
                                </MudTabPanel>

                                <MudTabPanel Text="Diff" Icon="@Icons.Material.Filled.Difference">
                                    <div class="workspace-console-scroll">
                                        @if (_selectedRun is null)
                                        {
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">No run selected.</MudText>
                                        }
                                        else
                                        {
                                            <RunDiffViewer RunId="@_selectedRun.Id"
                                                           Patch="@GetWorkspaceResolvedDiffPatch()"
                                                           DiffStat="@GetWorkspaceResolvedDiffStat()" />
                                        }
                                    </div>
                                </MudTabPanel>

                                <MudTabPanel Text="Raw" Icon="@Icons.Material.Filled.DataObject">
                                    <div class="workspace-console-scroll">
                                        @if (_selectedRun is null)
                                        {
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">Select a run from history to inspect payloads.</MudText>
                                        }
                                        else
                                        {
                                            <MudStack Spacing="1">
                                                <MudText Typo="Typo.caption">Run ID: @_selectedRun.Id</MudText>
                                                <MudText Typo="Typo.caption">Created: @_selectedRun.CreatedAtUtc.ToLocalTime().ToString("g")</MudText>
                                                <MudText Typo="Typo.caption">Summary: @(_selectedRun.Summary == string.Empty ? "-" : _selectedRun.Summary)</MudText>
                                                <MudStack Row Spacing="1">
                                                    <MudButton Variant="Variant.Outlined"
                                                               Size="Size.Small"
                                                               StartIcon="@Icons.Material.Filled.ContentCopy"
                                                               OnClick="CopySelectedRunStructuredEventsJsonAsync">
                                                        Copy Event JSON
                                                    </MudButton>
                                                </MudStack>
                                                <MudDivider />
                                                <MudText Typo="Typo.caption">Raw OutputJson</MudText>
                                                <pre class="workspace-raw-output">@GetSelectedRunRawOutput()</pre>

                                                <MudText Typo="Typo.caption">Structured Events (@_selectedRunStructuredEvents.Count)</MudText>
                                                <pre class="workspace-raw-output">@GetSelectedRunStructuredEventsJson()</pre>

                                                @if (_selectedRunParsed is not null && _selectedRunParsed.RawStream.Count > 0)
                                                {
                                                    <MudText Typo="Typo.caption">Raw Stream</MudText>
                                                    @foreach (var item in _selectedRunParsed.RawStream.TakeLast(240))
                                                    {
                                                        <MudText Typo="Typo.caption" Class="workspace-console-line">[@item.TimestampUtc.ToLocalTime().ToString("HH:mm:ss")] [@item.Level] @item.Message</MudText>
                                                    }
                                                }
                                            </MudStack>
                                        }
                                    </div>
                                </MudTabPanel>
                            </MudTabs>
                        </MudPaper>

                        <MudPaper Class="workspace-history-panel" Elevation="0">
                            <MudStack Row AlignItems="AlignItems.Center" Class="mb-2">
                                <MudText Typo="Typo.subtitle1">History</MudText>
                                <MudSpacer />
                                <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">@SelectedTaskRuns.Count runs</MudChip>
                            </MudStack>

                            <MudStack Row Spacing="1" Class="mb-2">
                                <MudSelect T="string"
                                           @bind-Value="_historyStateFilter"
                                           Label="State"
                                           Variant="Variant.Outlined"
                                           Margin="Margin.Dense"
                                           Dense="true"
                                           Class="workspace-filter-select">
                                    <MudSelectItem T="string" Value='@("all")'>All States</MudSelectItem>
                                    <MudSelectItem T="string" Value='@("running")'>Running</MudSelectItem>
                                    <MudSelectItem T="string" Value='@("queued")'>Queued</MudSelectItem>
                                    <MudSelectItem T="string" Value='@("pendingapproval")'>Pending Approval</MudSelectItem>
                                    <MudSelectItem T="string" Value='@("succeeded")'>Succeeded</MudSelectItem>
                                    <MudSelectItem T="string" Value='@("failed")'>Failed</MudSelectItem>
                                    <MudSelectItem T="string" Value='@("cancelled")'>Cancelled</MudSelectItem>
                                    <MudSelectItem T="string" Value='@("obsolete")'>Obsolete</MudSelectItem>
                                </MudSelect>
                                <MudSelect T="string"
                                           @bind-Value="_historyModeFilter"
                                           Label="Mode"
                                           Variant="Variant.Outlined"
                                           Margin="Margin.Dense"
                                           Dense="true"
                                           Class="workspace-filter-select">
                                    <MudSelectItem T="string" Value='@("all")'>All Modes</MudSelectItem>
                                    <MudSelectItem T="string" Value='@("default")'>Default</MudSelectItem>
                                    <MudSelectItem T="string" Value='@("plan")'>Plan</MudSelectItem>
                                    <MudSelectItem T="string" Value='@("review")'>Review</MudSelectItem>
                                </MudSelect>
                                <MudSelect T="string"
                                           @bind-Value="_historyHarnessFilter"
                                           Label="Harness"
                                           Variant="Variant.Outlined"
                                           Margin="Margin.Dense"
                                           Dense="true"
                                           Class="workspace-filter-select">
                                    <MudSelectItem T="string" Value='@("all")'>All Harnesses</MudSelectItem>
                                    <MudSelectItem T="string" Value='@("codex")'>Codex</MudSelectItem>
                                    <MudSelectItem T="string" Value='@("opencode")'>OpenCode</MudSelectItem>
                                </MudSelect>
                            </MudStack>

                            @if (SelectedTaskRuns.Count == 0)
                            {
                                <MudText Typo="Typo.body2" Color="Color.Secondary">No execution history yet.</MudText>
                            }
                            else
                            {
                                <MudTimeline TimelinePosition="TimelinePosition.Start" TimelineOrientation="TimelineOrientation.Vertical">
                                    @foreach (var run in SelectedTaskRuns)
                                    {
                                        <MudTimelineItem Color="@GetStateColor(run.State)" Size="Size.Small">
                                            <ItemOpposite>
                                                <MudText Typo="Typo.caption">@run.CreatedAtUtc.ToLocalTime().ToString("g")</MudText>
                                            </ItemOpposite>
                                            <ItemContent>
                                                <MudPaper Class="@GetHistoryItemClass(run)" Elevation="0" @onclick="() => SelectRunAsync(run.Id)">
                                                    <MudStack Spacing="0">
                                                        <MudStack Row AlignItems="AlignItems.Center">
                                                            <MudText Typo="Typo.caption">@run.Id[..Math.Min(8, run.Id.Length)]</MudText>
                                                            <MudSpacer />
                                                            <MudChip T="string" Size="Size.Small" Color="@GetStateColor(run.State)">@run.State</MudChip>
                                                        </MudStack>
                                                        <MudText Typo="Typo.caption" Class="workspace-history-summary">@GetRunSummary(run)</MudText>
                                                    </MudStack>
                                                </MudPaper>
                                            </ItemContent>
                                        </MudTimelineItem>
                                    }
                                </MudTimeline>
                            }

                            @if (_selectedTaskPromptHistory.Count > 0)
                            {
                                <MudDivider Class="my-2" />
                                <MudText Typo="Typo.subtitle2">Prompt History</MudText>
                                @foreach (var entry in _selectedTaskPromptHistory.Take(12))
                                {
                                    <MudPaper Class="workspace-history-item" Elevation="0">
                                        <MudStack Spacing="0">
                                            <MudStack Row AlignItems="AlignItems.Center">
                                                <MudText Typo="Typo.caption">@entry.CreatedAtUtc.ToLocalTime().ToString("g")</MudText>
                                                <MudSpacer />
                                                <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">@entry.Role</MudChip>
                                                @if (!string.IsNullOrWhiteSpace(entry.RunId))
                                                {
                                                    <MudChip T="string" Size="Size.Small" Color="Color.Info">@entry.RunId[..Math.Min(8, entry.RunId.Length)]</MudChip>
                                                }
                                                @if (entry.HasImages || !string.IsNullOrWhiteSpace(entry.ImageMetadataJson))
                                                {
                                                    <MudChip T="string" Size="Size.Small" Color="Color.Secondary">
                                                        Images @GetPromptHistoryImageCount(entry)
                                                    </MudChip>
                                                }
                                            </MudStack>
                                            <MudText Typo="Typo.caption">@TruncateForDisplay(entry.Content, 180)</MudText>
                                        </MudStack>
                                    </MudPaper>
                                }
                            }
                        </MudPaper>
                    </div>
                }
            </WorkspaceAdvancedDrawer>
        </div>
    }
</MudStack>

<MudDialog @bind-Visible="_promptDraftDialogOpen" Options="_promptDraftDialogOptions" Class="workspace-prompt-dialog">
    <TitleContent>
        <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudText Typo="Typo.h6">@GetPromptDraftTitle()</MudText>
            @if (_isPromptDraftLoading || _isPromptDraftRefining)
            {
                <MudProgressCircular Indeterminate="true" Size="Size.Small" />
            }
        </MudStack>
    </TitleContent>
    <DialogContent>
        @if (_isPromptDraftLoading)
        {
            <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Class="workspace-draft-loading">
                <MudProgressCircular Indeterminate="true" />
            </MudStack>
        }
        else if (!string.IsNullOrWhiteSpace(_promptDraftError))
        {
            <MudAlert Severity="Severity.Warning">@_promptDraftError</MudAlert>
        }
        else
        {
            <MudTabs @bind-ActivePanelIndex="_promptDraftActivePanel" Elevation="0" Rounded>
                <MudTabPanel Text="Preview">
                    <MudPaper Class="workspace-draft-preview" Elevation="0">
                        <pre class="workspace-draft-preview-text">@_promptDraftValue</pre>
                    </MudPaper>
                </MudTabPanel>
                <MudTabPanel Text="Editor">
                    <div class="workspace-draft-editor-host">
                        <StandaloneCodeEditor @key="_promptDraftEditorKey"
                                              @ref="_promptDraftEditor"
                                              ConstructionOptions="DraftEditorOptions"
                                              CssClass="monaco-fill-parent" />
                    </div>
                </MudTabPanel>
            </MudTabs>
        }
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="ClosePromptDraftDialog">Close</MudButton>
        <MudButton Variant="Variant.Outlined"
                   Color="Color.Secondary"
                   OnClick="RefreshPromptDraftPreviewAsync"
                   Disabled="@(_isPromptDraftLoading || _isPromptDraftRefining)">
            Refresh Preview
        </MudButton>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   OnClick="ApplyPromptDraftAsync"
                   Disabled="@(_isPromptDraftLoading || string.IsNullOrWhiteSpace(_promptDraftValue))">
            Apply
        </MudButton>
    </DialogActions>
</MudDialog>
