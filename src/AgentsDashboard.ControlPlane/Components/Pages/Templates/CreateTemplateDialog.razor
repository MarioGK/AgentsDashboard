@inject AgentsDashboard.ControlPlane.Services.TaskTemplateService TemplateService
@inject IDialogService DialogService
@using AgentsDashboard.Contracts.Domain

<MudDialog>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="_isValid">
            <MudStack Spacing="3">
                <MudTextField @bind-Value="_name" Label="Template Name" Required="true" />
                <MudTextField @bind-Value="_description" Label="Description" Lines="2" />

                <MudGrid>
                    <MudItem xs="6">
                        <MudSelect T="TaskKind" @bind-Value="_kind" Label="Kind">
                            <MudSelectItem T="TaskKind" Value="@TaskKind.OneShot">One Shot</MudSelectItem>
                            <MudSelectItem T="TaskKind" Value="@TaskKind.Cron">Cron</MudSelectItem>
                            <MudSelectItem T="TaskKind" Value="@TaskKind.EventDriven">Event Driven</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="6">
                        <MudSelect T="string" @bind-Value="_harness" Label="Harness">
                            <MudSelectItem T="string" Value='@("any")'>Any</MudSelectItem>
                            <MudSelectItem T="string" Value='@("codex")'>Codex</MudSelectItem>
                            <MudSelectItem T="string" Value='@("opencode")'>OpenCode</MudSelectItem>
                            <MudSelectItem T="string" Value='@("claude-code")'>Claude Code</MudSelectItem>
                            <MudSelectItem T="string" Value='@("zai")'>Zai (GLM-5)</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                </MudGrid>

                @if (_kind == TaskKind.Cron)
                {
                    <MudTextField @bind-Value="_cronExpression" Label="Cron Expression" 
                                  HelperText="e.g., 0 6 * * 1 (every Monday at 6 AM)" />
                }

                <MudSwitch @bind-Value="_autoPr" Label="Auto Create Pull Request" Color="Color.Primary" />

                <MudDivider />

                <MudText Typo="Typo.subtitle2">Commands</MudText>
                @for (var i = 0; i < _commands.Count; i++)
                {
                    var index = i;
                    <MudStack Row>
                        <MudTextField @bind-Value="_commands[index]" Label="@($"Command {index + 1}")" 
                                      Class="flex-grow-1" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error"
                                       OnClick="() => RemoveCommand(index)" />
                    </MudStack>
                }
                <MudButton Variant="Variant.Outlined" Size="Size.Small" StartIcon="@Icons.Material.Filled.Add"
                           OnClick="AddCommand">Add Command</MudButton>

                <MudDivider />

                <MudText Typo="Typo.subtitle2">Prompt</MudText>
                <MudTextField @bind-Value="_prompt" Label="Prompt" Lines="6" />

                <MudDivider />

                <MudText Typo="Typo.subtitle2">Resource Configuration</MudText>
                <MudGrid>
                    <MudItem xs="4">
                        <MudNumericField @bind-Value="_cpuLimit" Label="CPU Limit" Min="0.5" Max="8" Step="0.5" />
                    </MudItem>
                    <MudItem xs="4">
                        <MudSelect @bind-Value="_memoryLimit" Label="Memory">
                            <MudSelectItem Value='@("1g")'>1 GB</MudSelectItem>
                            <MudSelectItem Value='@("2g")'>2 GB</MudSelectItem>
                            <MudSelectItem Value='@("4g")'>4 GB</MudSelectItem>
                            <MudSelectItem Value='@("8g")'>8 GB</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="4">
                        <MudNumericField @bind-Value="_timeoutSeconds" Label="Timeout (s)" Min="60" Max="7200" />
                    </MudItem>
                </MudGrid>

                <MudGrid>
                    <MudItem xs="6">
                        <MudNumericField @bind-Value="_maxAttempts" Label="Max Retry Attempts" Min="1" Max="5" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudNumericField @bind-Value="_maxArtifacts" Label="Max Artifacts" Min="1" Max="100" />
                    </MudItem>
                </MudGrid>
            </MudStack>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="CreateTemplate" Disabled="!_isValid">
            Create
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;

    private MudForm _form = null!;
    private bool _isValid;

    private string _name = string.Empty;
    private string _description = string.Empty;
    private TaskKind _kind = TaskKind.OneShot;
    private string _harness = "any";
    private string _cronExpression = string.Empty;
    private bool _autoPr;
    private string _prompt = string.Empty;
    private List<string> _commands = ["echo 'Hello World'"];
    private double _cpuLimit = 1.5;
    private string _memoryLimit = "2g";
    private int _timeoutSeconds = 600;
    private int _maxAttempts = 1;
    private int _maxArtifacts = 50;

    private void AddCommand()
    {
        _commands.Add(string.Empty);
    }

    private void RemoveCommand(int index)
    {
        if (_commands.Count > 1)
        {
            _commands.RemoveAt(index);
        }
    }

    private void Cancel() => MudDialog.Cancel();

    private async Task CreateTemplate()
    {
        await _form.Validate();

        if (!_isValid) return;

        var template = new TaskTemplateDocument
        {
            Name = _name.Trim(),
            Description = _description.Trim(),
            Kind = _kind,
            Harness = _harness,
            Prompt = _prompt.Trim(),
            Commands = _commands.Where(c => !string.IsNullOrWhiteSpace(c)).ToList(),
            CronExpression = _kind == TaskKind.Cron ? _cronExpression.Trim() : string.Empty,
            AutoCreatePullRequest = _autoPr,
            RetryPolicy = new RetryPolicyConfig(_maxAttempts),
            Timeouts = new TimeoutConfig(_timeoutSeconds, _timeoutSeconds * 2),
            SandboxProfile = new SandboxProfileConfig(_cpuLimit, _memoryLimit),
            ArtifactPolicy = new ArtifactPolicyConfig(_maxArtifacts)
        };

        try
        {
            await TemplateService.CreateCustomTemplateAsync(template, CancellationToken.None);
            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            await DialogService.ShowMessageBox("Error", ex.Message, yesText: "OK");
        }
    }
}
