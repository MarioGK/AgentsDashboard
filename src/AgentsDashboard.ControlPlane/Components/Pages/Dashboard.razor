@page "/"
@rendermode InteractiveServer
@inject Data.IOrchestratorStore Store
@inject Services.IGlobalSelectionService SelectionService
@inject NavigationManager NavigationManager
@implements IDisposable

<PageTitle>Overview</PageTitle>

@if (_loading)
{
    <MudStack Class="overview-loading" AlignItems="AlignItems.Center" Justify="Justify.Center">
        <MudProgressCircular Indeterminate="true" Size="Size.Large" />
    </MudStack>
}
else
{
    <MudStack Spacing="4" Class="overview-shell">
        <MudPaper Class="overview-hero" Elevation="0">
            <MudText Typo="Typo.h4">Command Center</MudText>
            <MudText Typo="Typo.body2" Class="overview-hero-subtitle">Launch into settings pages quickly and keep operational context in one place.</MudText>

            <MudTextField T="string"
                          @bind-Value="_commandText"
                          Placeholder="Type a command like 'runs', 'findings', 'workflows stages', 'workers'"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Immediate="true"
                          OnKeyDown="OnCommandKeyDown" />

            <MudStack Row="true" Class="mt-3" Spacing="1">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OpenCommandTarget">Open</MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="ClearCommand">Clear</MudButton>
            </MudStack>
        </MudPaper>

        <MudGrid>
            <MudItem xs="12" md="4">
                <MudPaper Class="overview-stat-card" Elevation="0">
                    <MudText Typo="Typo.caption">Repositories</MudText>
                    <MudText Typo="Typo.h4">@_repositories.Count</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" md="4">
                <MudPaper Class="overview-stat-card" Elevation="0">
                    <MudText Typo="Typo.caption">Open Findings</MudText>
                    <MudText Typo="Typo.h4">@_openFindings</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" md="4">
                <MudPaper Class="overview-stat-card" Elevation="0">
                    <MudText Typo="Typo.caption">Active Runs</MudText>
                    <MudText Typo="Typo.h4">@_activeRuns</MudText>
                </MudPaper>
            </MudItem>
        </MudGrid>

        <MudGrid>
            <MudItem xs="12" lg="7">
                <MudPaper Class="overview-card" Elevation="0">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-2">
                        <MudText Typo="Typo.h6">Quick Actions</MudText>
                        <MudLink Href="/settings">View all settings sections</MudLink>
                    </MudStack>

                    <MudGrid>
                        @foreach (var action in _quickActions)
                        {
                            <MudItem xs="12" sm="6">
                                <MudPaper Class="overview-quick-action" Elevation="0" @onclick="() => NavigationManager.NavigateTo(action.Href)">
                                    <MudIcon Icon="@action.Icon" Class="mr-2" />
                                    <div>
                                        <MudText Typo="Typo.subtitle2">@action.Title</MudText>
                                        <MudText Typo="Typo.caption">@action.Description</MudText>
                                    </div>
                                </MudPaper>
                            </MudItem>
                        }
                    </MudGrid>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" lg="5">
                <MudPaper Class="overview-card" Elevation="0">
                    <MudText Typo="Typo.h6" Class="mb-2">Recent Runs</MudText>

                    @if (_runs.Count == 0)
                    {
                        <MudText Typo="Typo.body2">No runs available for the current selection.</MudText>
                    }
                    else
                    {
                        <MudList T="RunDocument" Dense="true">
                            @foreach (var run in _runs.Take(8))
                            {
                                <MudListItem>
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Style="width:100%">
                                        <MudStack Spacing="0">
                                            <MudLink Href="@($"/settings/runs/{run.Id}")">@run.Id[..Math.Min(8, run.Id.Length)]</MudLink>
                                            <MudText Typo="Typo.caption">@run.CreatedAtUtc.ToLocalTime().ToString("g")</MudText>
                                        </MudStack>
                                        <MudChip T="string" Size="Size.Small" Color="@GetRunStateColor(run.State)">
                                            @GetRunStateLabel(run.State)
                                        </MudChip>
                                    </MudStack>
                                </MudListItem>
                            }
                        </MudList>
                    }
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudStack>
}

@code {
    private readonly List<QuickAction> _quickActions =
    [
        new("Runs", "Inspect queues, active and finished runs", "/settings/runs", Icons.Material.Filled.PlayCircle),
        new("Findings", "Triage failures and quality issues", "/settings/findings", Icons.Material.Filled.BugReport),
        new("Workflows", "Manage stage workflows", "/settings/workflows/stages", Icons.Material.Filled.AccountTree),
        new("Repositories", "Manage git-linked repositories", "/settings/projects", Icons.Material.Filled.AccountTree),
        new("Workers", "Inspect worker status and tool availability", "/settings/workers", Icons.Material.Filled.Engineering),
        new("Orchestrator", "Tune worker pool reliability and scaling", "/settings/orchestrator", Icons.Material.Filled.Memory),
        new("System", "Update retention and docker policies", "/settings/system", Icons.Material.Filled.Tune)
    ];

    private bool _loading = true;
    private string _commandText = string.Empty;
    private int _openFindings;
    private int _activeRuns;
    private List<RepositoryDocument> _repositories = [];
    private List<RunDocument> _runs = [];
    private IDisposable? _selectionSubscription;

    protected override async Task OnInitializedAsync()
    {
        _selectionSubscription = SelectionService.Subscribe(async _ => await LoadDataAsync());
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _loading = true;
        await InvokeAsync(StateHasChanged);

        try
        {
            _repositories = await Store.ListRepositoriesAsync(CancellationToken.None);

            if (SelectionService.SelectedRepositoryId is not null)
            {
                _runs = await Store.ListRunsByRepositoryAsync(SelectionService.SelectedRepositoryId, CancellationToken.None);
                var findings = await Store.ListFindingsAsync(SelectionService.SelectedRepositoryId, CancellationToken.None);
                _openFindings = findings.Count(IsOpenFinding);
            }
            else
            {
                _runs = await Store.ListRecentRunsAsync(CancellationToken.None);
                var findings = await Store.ListAllFindingsAsync(CancellationToken.None);
                _openFindings = findings.Count(IsOpenFinding);
            }

            _activeRuns = _runs.Count(r => TaskRunStatusPresentation.FromRunState(r.State).IsWorking);
        }
        finally
        {
            _loading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void OpenCommandTarget()
    {
        NavigationManager.NavigateTo(ResolveCommandRoute(_commandText));
    }

    private void ClearCommand()
    {
        _commandText = string.Empty;
    }

    private Task OnCommandKeyDown(KeyboardEventArgs args)
    {
        if (args.Key == "Enter")
        {
            OpenCommandTarget();
        }

        return Task.CompletedTask;
    }

    private static string ResolveCommandRoute(string? command)
    {
        var normalized = command?.Trim().ToLowerInvariant() ?? string.Empty;

        if (normalized.Contains("run")) return "/settings/runs";
        if (normalized.Contains("finding")) return "/settings/findings";
        if (normalized.Contains("project") || normalized.Contains("repo")) return "/settings/projects";
        if (normalized.Contains("workflow") && normalized.Contains("stage")) return "/settings/workflows/stages";
        if (normalized.Contains("workflow") || normalized.Contains("stage")) return "/settings/workflows/stages";
        if (normalized.Contains("provider")) return "/providers";
        if (normalized.Contains("tool")) return "/settings/workers";
        if (normalized.Contains("worker")) return "/settings/workers";
        if (normalized.Contains("template")) return "/settings/templates";
        if (normalized.Contains("alert")) return "/settings/alerts";
        if (normalized.Contains("terminal")) return "/settings/terminals";
        if (normalized.Contains("proxy")) return "/settings/proxy-audits";
        if (normalized.Contains("orchestrator")) return "/settings/orchestrator";
        if (normalized.Contains("system") || normalized.Contains("settings")) return "/settings/system";
        return "/settings";
    }

    private static Color GetRunStateColor(RunState state) => TaskRunStatusPresentation.FromRunState(state).Color;

    private static string GetRunStateLabel(RunState state) => TaskRunStatusPresentation.FromRunState(state).Label;

    private static bool IsOpenFinding(FindingDocument finding) => finding.State is FindingState.New or FindingState.Acknowledged or FindingState.InProgress;

    public void Dispose()
    {
        _selectionSubscription?.Dispose();
    }

    private record QuickAction(string Title, string Description, string Href, string Icon);
}
