@page "/workflow-deadletters"
@attribute [Authorize]
@rendermode InteractiveServer
@inject AgentsDashboard.ControlPlane.Data.OrchestratorStore Store
@inject ISnackbar Snackbar
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager Nav

<PageTitle>Dead Letters - AgentsDashboard</PageTitle>

<MudStack Row AlignItems="AlignItems.Center" Class="mb-4">
    <MudText Typo="Typo.h4">Dead Letters</MudText>
    <MudSpacer />
    <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Refresh" OnClick="LoadAsync">
        Refresh
    </MudButton>
</MudStack>

@if (_loading)
{
    <MudProgressLinear Indeterminate />
}
else if (_deadLetters.Count == 0)
{
    <MudAlert Severity="Severity.Success">No unreplayed dead letters found.</MudAlert>
}
else
{
    <MudPaper Elevation="2">
        <MudTable Items="@_deadLetters" Hover Dense Striped>
            <ToolBarContent>
                <MudTextField @bind-Value="_searchString" Placeholder="Search dead letters..."
                              Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                              IconSize="Size.Medium" Class="mt-0" Immediate />
            </ToolBarContent>
            <HeaderContent>
                <MudTh>Workflow</MudTh>
                <MudTh>Failed Node</MudTh>
                <MudTh>Failure Reason</MudTh>
                <MudTh>Run ID</MudTh>
                <MudTh>Attempt</MudTh>
                <MudTh>Replayed</MudTh>
                <MudTh><MudTableSortLabel SortBy="new Func<DeadLetterRow, object>(x => x.CreatedAt)">Created</MudTableSortLabel></MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Workflow">
                    <MudLink Href="@($"/workflows-v2/{context.WorkflowV2Id}")">@context.WorkflowName</MudLink>
                </MudTd>
                <MudTd DataLabel="Failed Node">@context.FailedNodeName</MudTd>
                <MudTd DataLabel="Failure Reason">
                    <MudText Typo="Typo.body2" Style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        @context.FailureReason
                    </MudText>
                </MudTd>
                <MudTd DataLabel="Run ID">
                    @if (!string.IsNullOrEmpty(context.RunId))
                    {
                        <MudLink Href="@($"/runs/{context.RunId}")">@context.RunId[..Math.Min(8, context.RunId.Length)]</MudLink>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Default">-</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Attempt">@context.Attempt</MudTd>
                <MudTd DataLabel="Replayed">
                    @if (context.Replayed)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Success">Replayed</MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Error">Not Replayed</MudChip>
                    }
                </MudTd>
                <MudTd DataLabel="Created">@context.CreatedAt.ToString("g")</MudTd>
                <MudTd DataLabel="Actions">
                    <MudIconButton Icon="@Icons.Material.Filled.OpenInNew" Size="Size.Small"
                                   Href="@($"/workflows-v2/executions/{context.ExecutionId}")"
                                   Title="View Execution" />
                    @if (!context.Replayed)
                    {
                        <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small"
                                   StartIcon="@Icons.Material.Filled.Replay"
                                   OnClick="() => ReplayAsync(context.Id)">
                            Replay
                        </MudButton>
                    }
                </MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager />
            </PagerContent>
        </MudTable>
    </MudPaper>
}

@code {
    private string _searchString = "";
    private bool _loading = true;

    private record DeadLetterRow(
        string Id,
        string ExecutionId,
        string WorkflowV2Id,
        string WorkflowName,
        string FailedNodeName,
        string FailureReason,
        string? RunId,
        int Attempt,
        bool Replayed,
        DateTime CreatedAt);

    private List<DeadLetterRow> _deadLetters = [];
    private Dictionary<string, string> _workflowNameMap = [];

    protected override async Task OnInitializedAsync()
    {
        await LoadWorkflowNamesAsync();
        await LoadAsync();
    }

    private async Task LoadWorkflowNamesAsync()
    {
        var workflows = await Store.ListAllWorkflowsV2Async(CancellationToken.None);
        _workflowNameMap = workflows.ToDictionary(w => w.Id, w => w.Name);
    }

    private async Task LoadAsync()
    {
        _loading = true;

        var deadLetters = await Store.ListUnreplayedDeadLettersAsync(CancellationToken.None);

        _deadLetters = deadLetters
            .Select(dl => new DeadLetterRow(
                dl.Id,
                dl.ExecutionId,
                dl.WorkflowV2Id,
                _workflowNameMap.TryGetValue(dl.WorkflowV2Id, out var name) ? name : dl.WorkflowV2Id[..Math.Min(8, dl.WorkflowV2Id.Length)],
                dl.FailedNodeName,
                dl.FailureReason,
                dl.RunId,
                dl.Attempt,
                dl.Replayed,
                dl.CreatedAtUtc))
            .OrderByDescending(x => x.CreatedAt)
            .ToList();

        _loading = false;
    }

    private async Task ReplayAsync(string deadLetterId)
    {
        try
        {
            var client = HttpClientFactory.CreateClient("Api");
            var request = new ReplayDeadLetterRequest("manual");
            var response = await client.PostAsJsonAsync($"/api/workflow-deadletters/{deadLetterId}/replay", request);

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Dead letter replayed successfully", Severity.Success);
                await LoadAsync();
            }
            else
            {
                Snackbar.Add($"Replay failed: {response.StatusCode}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Replay error: {ex.Message}", Severity.Error);
        }
    }
}
