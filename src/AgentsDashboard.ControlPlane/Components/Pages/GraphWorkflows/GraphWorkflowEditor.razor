@page "/workflows-v2/new"
@page "/workflows-v2/{Id}"
@rendermode InteractiveServer
@inject AgentsDashboard.ControlPlane.Data.OrchestratorStore Store
@inject NavigationManager Nav
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IHttpClientFactory HttpClientFactory

<PageTitle>@(IsNew ? "New Graph Workflow" : "Edit Graph Workflow") - AgentsDashboard</PageTitle>

<MudStack Row AlignItems="AlignItems.Center" Class="mb-4">
    <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Href="/workflows-v2" />
    <MudText Typo="Typo.h4">@(IsNew ? "New Graph Workflow" : "Edit Graph Workflow")</MudText>
    <MudSpacer />
    <MudButtonGroup Variant="Variant.Outlined">
        <MudButton Color="Color.Default" StartIcon="@Icons.Material.Filled.Check" OnClick="ValidateWorkflow">
            Validate
        </MudButton>
        <MudButton Color="Color.Secondary" StartIcon="@Icons.Material.Filled.PlayArrow" OnClick="ExecuteWorkflowAsync" Disabled="@IsNew">
            Execute
        </MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Save" OnClick="SaveAsync">
            Save
        </MudButton>
    </MudButtonGroup>
</MudStack>

@if (!string.IsNullOrEmpty(_statusMessage))
{
    <MudAlert Severity="@_statusSeverity" Class="mb-4" CloseIconClicked="() => _statusMessage = null" ShowCloseIcon>
        @_statusMessage
    </MudAlert>
}

<MudGrid Class="ma-0 pa-0" Style="height: calc(100vh - 200px);">
    <MudItem xs="12" md="2" Class="pa-2">
        <MudPaper Elevation="2" Class="pa-4" Style="height: 100%; overflow-y: auto;">
            <MudText Typo="Typo.h6" Class="mb-4">Node Palette</MudText>
            <MudDivider Class="mb-4" />
            <MudStack Spacing="2">
                @foreach (var nodeType in _nodeTypes)
                {
                    <MudButton Variant="Variant.Outlined" Color="@nodeType.Color" FullWidth
                               StartIcon="@nodeType.Icon" OnClick="() => AddNodeFromPalette(nodeType.Type)">
                        @nodeType.Label
                    </MudButton>
                }
            </MudStack>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="7" Class="pa-2">
        <MudPaper Elevation="2" Class="pa-4" Style="height: 100%; overflow-y: auto;">
            <MudTabs Elevation="0" Rounded ApplyEffectsToContainer>
                <MudTabPanel Text="Nodes" Icon="@Icons.Material.Filled.AccountTree">
                    @if (_nodes.Count == 0)
                    {
                        <MudAlert Severity="Severity.Info" Class="mt-4">
                            Add nodes from the palette on the left to build your workflow graph.
                        </MudAlert>
                    }
                    else
                    {
                        <MudTable Items="@_nodes" Hover Dense Striped Class="mt-2" T="WorkflowNodeConfig"
                                  SelectedItem="_selectedNode" SelectedItemChanged="OnNodeSelected"
                                  RowClassFunc="@((node, _) => node.Id == _selectedNode?.Id ? "mud-theme-primary" : "")">
                            <HeaderContent>
                                <MudTh>Name</MudTh>
                                <MudTh>Type</MudTh>
                                <MudTh>Agent</MudTh>
                                <MudTh>Actions</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Name">@context.Name</MudTd>
                                <MudTd DataLabel="Type">
                                    <MudChip T="string" Size="Size.Small" Color="@GetNodeColor(context.Type)">
                                        @context.Type
                                    </MudChip>
                                </MudTd>
                                <MudTd DataLabel="Agent">
                                    @if (context.Type == WorkflowNodeType.Agent && !string.IsNullOrEmpty(context.AgentId))
                                    {
                                        var agent = _agents.FirstOrDefault(a => a.Id == context.AgentId);
                                        @(agent?.Name ?? context.AgentId[..Math.Min(8, context.AgentId.Length)])
                                    }
                                </MudTd>
                                <MudTd DataLabel="Actions">
                                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small"
                                                   OnClick="() => OpenEditNodeDialog(context)" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error"
                                                   OnClick="() => RemoveNode(context)" />
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                    }
                </MudTabPanel>

                <MudTabPanel Text="Edges" Icon="@Icons.Material.Filled.Timeline">
                    <MudStack Row AlignItems="AlignItems.Center" Class="mt-2 mb-2">
                        <MudSpacer />
                        <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small"
                                   StartIcon="@Icons.Material.Filled.Add" OnClick="OpenAddEdgeDialog">
                            Add Edge
                        </MudButton>
                    </MudStack>

                    @if (_edges.Count == 0)
                    {
                        <MudAlert Severity="Severity.Info">
                            No edges defined. Add edges to connect nodes.
                        </MudAlert>
                    }
                    else
                    {
                        <MudTable Items="@_edges" Hover Dense Striped>
                            <HeaderContent>
                                <MudTh>Source</MudTh>
                                <MudTh></MudTh>
                                <MudTh>Target</MudTh>
                                <MudTh>Condition</MudTh>
                                <MudTh>Priority</MudTh>
                                <MudTh>Actions</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Source">@GetNodeName(context.SourceNodeId)</MudTd>
                                <MudTd><MudIcon Icon="@Icons.Material.Filled.ArrowForward" Size="Size.Small" /></MudTd>
                                <MudTd DataLabel="Target">@GetNodeName(context.TargetNodeId)</MudTd>
                                <MudTd DataLabel="Condition">
                                    @if (!string.IsNullOrEmpty(context.Condition))
                                    {
                                        <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">@context.Condition</MudChip>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Priority">@context.Priority</MudTd>
                                <MudTd DataLabel="Actions">
                                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small"
                                                   OnClick="() => OpenEditEdgeDialog(context)" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error"
                                                   OnClick="() => RemoveEdge(context)" />
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                    }
                </MudTabPanel>

                <MudTabPanel Text="Validation" Icon="@Icons.Material.Filled.VerifiedUser">
                    <div class="mt-4">
                        @if (_validationErrors.Count == 0)
                        {
                            <MudAlert Severity="Severity.Success">
                                Click "Validate" to check the workflow for errors.
                            </MudAlert>
                        }
                        else
                        {
                            @foreach (var error in _validationErrors)
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-2">@error</MudAlert>
                            }
                        }
                    </div>
                </MudTabPanel>
            </MudTabs>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="3" Class="pa-2">
        <MudPaper Elevation="2" Class="pa-4" Style="height: 100%; overflow-y: auto;">
            @if (_selectedNode is not null)
            {
                <MudStack Row AlignItems="AlignItems.Center" Class="mb-4">
                    <MudText Typo="Typo.h6">Node Properties</MudText>
                    <MudSpacer />
                    <MudIconButton Icon="@Icons.Material.Filled.Close" Size="Size.Small"
                                   OnClick="() => _selectedNode = null" />
                </MudStack>
                <MudDivider Class="mb-4" />

                <MudTextField @bind-Value="_selectedNode.Name" Label="Name" Variant="Variant.Outlined" Class="mb-4" />

                <MudSelect @bind-Value="_selectedNode.Type" Label="Type" Variant="Variant.Outlined" Class="mb-4">
                    @foreach (WorkflowNodeType t in Enum.GetValues<WorkflowNodeType>())
                    {
                        <MudSelectItem Value="@t">@t</MudSelectItem>
                    }
                </MudSelect>

                @switch (_selectedNode.Type)
                {
                    case WorkflowNodeType.Agent:
                        <MudSelect @bind-Value="_selectedNode.AgentId" Label="Agent" Variant="Variant.Outlined"
                                   Clearable Class="mb-4">
                            @foreach (var agent in _agents)
                            {
                                <MudSelectItem Value="@agent.Id">@agent.Name (@agent.Harness)</MudSelectItem>
                            }
                        </MudSelect>
                        break;

                    case WorkflowNodeType.Delay:
                        <MudNumericField @bind-Value="_selectedNode.DelaySeconds" Label="Delay (seconds)"
                                         Variant="Variant.Outlined" Min="1" Max="86400" Class="mb-4" />
                        break;

                    case WorkflowNodeType.Approval:
                        break;
                }

                <MudNumericField @bind-Value="_selectedNode.TimeoutMinutes" Label="Timeout (minutes)"
                                 Variant="Variant.Outlined" Min="1" Max="1440" Class="mb-4" />

                <MudDivider Class="mb-4" />
                <MudText Typo="Typo.subtitle2" Class="mb-2">Input Mappings</MudText>
                @foreach (var key in _selectedNode.InputMappings.Keys.ToList())
                {
                    var k = key;
                    <MudStack Row Class="mb-2" AlignItems="AlignItems.Center">
                        <MudTextField Value="@k" Label="Key" Variant="Variant.Outlined" Margin="Margin.Dense" ReadOnly
                                      Style="max-width: 120px;" />
                        <MudTextField Value="@_selectedNode.InputMappings[k]" Label="Value" Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      ValueChanged="@((string v) => _selectedNode.InputMappings[k] = v)" />
                        <MudIconButton Icon="@Icons.Material.Filled.Remove" Color="Color.Error" Size="Size.Small"
                                       OnClick="() => { _selectedNode.InputMappings.Remove(k); StateHasChanged(); }" />
                    </MudStack>
                }
                <MudStack Row Class="mb-4" AlignItems="AlignItems.Center">
                    <MudTextField @bind-Value="_newInputKey" Label="Key" Variant="Variant.Outlined" Margin="Margin.Dense"
                                  Style="max-width: 120px;" />
                    <MudTextField @bind-Value="_newInputValue" Label="Value" Variant="Variant.Outlined" Margin="Margin.Dense" />
                    <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Primary" Size="Size.Small"
                                   OnClick="AddInputMapping" />
                </MudStack>

                <MudText Typo="Typo.subtitle2" Class="mb-2">Output Mappings</MudText>
                @foreach (var key in _selectedNode.OutputMappings.Keys.ToList())
                {
                    var k = key;
                    <MudStack Row Class="mb-2" AlignItems="AlignItems.Center">
                        <MudTextField Value="@k" Label="Key" Variant="Variant.Outlined" Margin="Margin.Dense" ReadOnly
                                      Style="max-width: 120px;" />
                        <MudTextField Value="@_selectedNode.OutputMappings[k]" Label="Value" Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      ValueChanged="@((string v) => _selectedNode.OutputMappings[k] = v)" />
                        <MudIconButton Icon="@Icons.Material.Filled.Remove" Color="Color.Error" Size="Size.Small"
                                       OnClick="() => { _selectedNode.OutputMappings.Remove(k); StateHasChanged(); }" />
                    </MudStack>
                }
                <MudStack Row Class="mb-4" AlignItems="AlignItems.Center">
                    <MudTextField @bind-Value="_newOutputKey" Label="Key" Variant="Variant.Outlined" Margin="Margin.Dense"
                                  Style="max-width: 120px;" />
                    <MudTextField @bind-Value="_newOutputValue" Label="Value" Variant="Variant.Outlined" Margin="Margin.Dense" />
                    <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Primary" Size="Size.Small"
                                   OnClick="AddOutputMapping" />
                </MudStack>
            }
            else
            {
                <MudText Typo="Typo.h6" Class="mb-4">Workflow Properties</MudText>
                <MudDivider Class="mb-4" />

                <MudTextField @bind-Value="_name" Label="Name" Variant="Variant.Outlined" Required
                              RequiredError="Name is required" Class="mb-4" />

                <MudTextField @bind-Value="_description" Label="Description" Variant="Variant.Outlined"
                              Lines="3" Class="mb-4" />

                <MudSelect T="string" Value="_repositoryId" Label="Repository" Variant="Variant.Outlined"
                           Class="mb-4" ValueChanged="OnRepositoryChanged">
                    @foreach (var r in _repositories)
                    {
                        <MudSelectItem Value="@r.Id">@r.Name</MudSelectItem>
                    }
                </MudSelect>

                <MudSwitch @bind-Value="_enabled" Label="Enabled" Color="Color.Primary" Class="mb-4" />

                <MudNumericField @bind-Value="_maxConcurrentNodes" Label="Max Concurrent Nodes"
                                 Variant="Variant.Outlined" Min="1" Max="32" Class="mb-4" />

                <MudDivider Class="mb-4" />
                <MudText Typo="Typo.subtitle2" Class="mb-2">Trigger</MudText>

                <MudSelect @bind-Value="_triggerType" Label="Trigger Type" Variant="Variant.Outlined" Class="mb-4">
                    <MudSelectItem Value="@("Manual")">Manual</MudSelectItem>
                    <MudSelectItem Value="@("Cron")">Cron</MudSelectItem>
                    <MudSelectItem Value="@("Webhook")">Webhook</MudSelectItem>
                </MudSelect>

                @if (_triggerType == "Cron")
                {
                    <MudTextField @bind-Value="_cronExpression" Label="Cron Expression" Variant="Variant.Outlined"
                                  HelperText="e.g. 0 */6 * * *" Class="mb-4" />
                }

                @if (_triggerType == "Webhook")
                {
                    <MudTextField @bind-Value="_webhookEventFilter" Label="Webhook Event Filter"
                                  Variant="Variant.Outlined" HelperText="e.g. push, pull_request" Class="mb-4" />
                }
            }
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    [Parameter] public string? Id { get; set; }

    private bool IsNew => string.IsNullOrEmpty(Id) || Id == "new";

    private string _name = "";
    private string _description = "";
    private string _repositoryId = "";
    private bool _enabled = true;
    private int _maxConcurrentNodes = 4;
    private string _triggerType = "Manual";
    private string _cronExpression = "";
    private string _webhookEventFilter = "";

    private string? _statusMessage;
    private Severity _statusSeverity = Severity.Info;

    private WorkflowNodeConfig? _selectedNode;
    private string _newInputKey = "";
    private string _newInputValue = "";
    private string _newOutputKey = "";
    private string _newOutputValue = "";

    private List<WorkflowNodeConfig> _nodes = [];
    private List<WorkflowEdgeConfig> _edges = [];
    private List<string> _validationErrors = [];

    private List<RepositoryDocument> _repositories = [];
    private List<AgentDocument> _agents = [];

    private readonly List<NodeTypeInfo> _nodeTypes =
    [
        new(WorkflowNodeType.Start, "Start", Icons.Material.Filled.PlayCircle, Color.Success),
        new(WorkflowNodeType.Agent, "Agent", Icons.Material.Filled.SmartToy, Color.Primary),
        new(WorkflowNodeType.Delay, "Delay", Icons.Material.Filled.Schedule, Color.Warning),
        new(WorkflowNodeType.Approval, "Approval", Icons.Material.Filled.CheckCircle, Color.Info),
        new(WorkflowNodeType.End, "End", Icons.Material.Filled.StopCircle, Color.Error),
    ];

    private readonly DialogOptions _dialogOptions = new() { MaxWidth = MaxWidth.Medium, FullWidth = true };

    private record NodeTypeInfo(WorkflowNodeType Type, string Label, string Icon, Color Color);

    protected override async Task OnInitializedAsync()
    {
        var projects = await Store.ListProjectsAsync(CancellationToken.None);
        foreach (var p in projects)
        {
            var repos = await Store.ListRepositoriesAsync(p.Id, CancellationToken.None);
            _repositories.AddRange(repos);
        }

        if (!IsNew)
        {
            var workflow = await Store.GetWorkflowV2Async(Id!, CancellationToken.None);
            if (workflow is not null)
            {
                _name = workflow.Name;
                _description = workflow.Description;
                _repositoryId = workflow.RepositoryId;
                _enabled = workflow.Enabled;
                _maxConcurrentNodes = workflow.MaxConcurrentNodes;
                _triggerType = workflow.Trigger.Type;
                _cronExpression = workflow.Trigger.CronExpression;
                _webhookEventFilter = workflow.Trigger.WebhookEventFilter;
                _nodes = workflow.Nodes.ToList();
                _edges = workflow.Edges.ToList();
            }
        }

        if (!string.IsNullOrEmpty(_repositoryId))
        {
            _agents = await Store.ListAgentsByRepositoryAsync(_repositoryId, CancellationToken.None);
        }
        else
        {
            _agents = await Store.ListAllAgentsAsync(CancellationToken.None);
        }
    }

    private async Task OnRepositoryChanged(string value)
    {
        _repositoryId = value;
        _agents = !string.IsNullOrEmpty(_repositoryId)
            ? await Store.ListAgentsByRepositoryAsync(_repositoryId, CancellationToken.None)
            : await Store.ListAllAgentsAsync(CancellationToken.None);
    }

    private void OnNodeSelected(WorkflowNodeConfig node)
    {
        _selectedNode = node;
    }

    private void AddNodeFromPalette(WorkflowNodeType type)
    {
        var node = new WorkflowNodeConfig
        {
            Name = $"{type} {_nodes.Count(n => n.Type == type) + 1}",
            Type = type,
            PositionX = _nodes.Count * 200,
            PositionY = 100,
        };
        _nodes.Add(node);
        _selectedNode = node;
    }

    private void RemoveNode(WorkflowNodeConfig node)
    {
        _nodes.Remove(node);
        _edges.RemoveAll(e => e.SourceNodeId == node.Id || e.TargetNodeId == node.Id);
        if (_selectedNode?.Id == node.Id)
            _selectedNode = null;
    }

    private void RemoveEdge(WorkflowEdgeConfig edge)
    {
        _edges.Remove(edge);
    }

    private async Task OpenEditNodeDialog(WorkflowNodeConfig node)
    {
        var parameters = new DialogParameters<GraphNodeDialog>
        {
            { x => x.Node, node },
            { x => x.Agents, _agents }
        };

        var dialog = await DialogService.ShowAsync<GraphNodeDialog>("Edit Node", parameters, _dialogOptions);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled && result.Data is WorkflowNodeConfig updated)
        {
            var idx = _nodes.FindIndex(n => n.Id == node.Id);
            if (idx >= 0)
            {
                _nodes[idx] = updated;
                if (_selectedNode?.Id == node.Id)
                    _selectedNode = updated;
            }
        }
    }

    private async Task OpenAddEdgeDialog()
    {
        var parameters = new DialogParameters<GraphEdgeDialog>
        {
            { x => x.Edge, null },
            { x => x.Nodes, _nodes }
        };

        var dialog = await DialogService.ShowAsync<GraphEdgeDialog>("Add Edge", parameters, _dialogOptions);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled && result.Data is WorkflowEdgeConfig edge)
        {
            _edges.Add(edge);
        }
    }

    private async Task OpenEditEdgeDialog(WorkflowEdgeConfig edge)
    {
        var parameters = new DialogParameters<GraphEdgeDialog>
        {
            { x => x.Edge, edge },
            { x => x.Nodes, _nodes }
        };

        var dialog = await DialogService.ShowAsync<GraphEdgeDialog>("Edit Edge", parameters, _dialogOptions);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled && result.Data is WorkflowEdgeConfig updated)
        {
            var idx = _edges.FindIndex(e => e.Id == edge.Id);
            if (idx >= 0)
                _edges[idx] = updated;
        }
    }

    private void AddInputMapping()
    {
        if (_selectedNode is null || string.IsNullOrWhiteSpace(_newInputKey)) return;
        _selectedNode.InputMappings[_newInputKey.Trim()] = _newInputValue.Trim();
        _newInputKey = "";
        _newInputValue = "";
    }

    private void AddOutputMapping()
    {
        if (_selectedNode is null || string.IsNullOrWhiteSpace(_newOutputKey)) return;
        _selectedNode.OutputMappings[_newOutputKey.Trim()] = _newOutputValue.Trim();
        _newOutputKey = "";
        _newOutputValue = "";
    }

    private string GetNodeName(string nodeId)
    {
        var node = _nodes.FirstOrDefault(n => n.Id == nodeId);
        return node?.Name ?? nodeId[..Math.Min(8, nodeId.Length)];
    }

    private static Color GetNodeColor(WorkflowNodeType type) => type switch
    {
        WorkflowNodeType.Start => Color.Success,
        WorkflowNodeType.Agent => Color.Primary,
        WorkflowNodeType.Delay => Color.Warning,
        WorkflowNodeType.Approval => Color.Info,
        WorkflowNodeType.End => Color.Error,
        _ => Color.Default,
    };

    private void ValidateWorkflow()
    {
        _validationErrors.Clear();

        if (string.IsNullOrWhiteSpace(_name))
            _validationErrors.Add("Workflow name is required.");

        if (string.IsNullOrWhiteSpace(_repositoryId))
            _validationErrors.Add("Repository must be selected.");

        if (_nodes.Count == 0)
            _validationErrors.Add("At least one node is required.");

        var startNodes = _nodes.Count(n => n.Type == WorkflowNodeType.Start);
        if (startNodes == 0)
            _validationErrors.Add("Workflow must have at least one Start node.");
        if (startNodes > 1)
            _validationErrors.Add("Workflow must have exactly one Start node.");

        var endNodes = _nodes.Count(n => n.Type == WorkflowNodeType.End);
        if (endNodes == 0)
            _validationErrors.Add("Workflow must have at least one End node.");

        foreach (var node in _nodes)
        {
            if (string.IsNullOrWhiteSpace(node.Name))
                _validationErrors.Add($"Node '{node.Id[..8]}' is missing a name.");

            if (node.Type == WorkflowNodeType.Agent && string.IsNullOrEmpty(node.AgentId))
                _validationErrors.Add($"Agent node '{node.Name}' must have an agent assigned.");

            if (node.Type == WorkflowNodeType.Delay && (!node.DelaySeconds.HasValue || node.DelaySeconds < 1))
                _validationErrors.Add($"Delay node '{node.Name}' must have a delay duration >= 1 second.");
        }

        foreach (var edge in _edges)
        {
            if (!_nodes.Any(n => n.Id == edge.SourceNodeId))
                _validationErrors.Add($"Edge references non-existent source node '{edge.SourceNodeId[..Math.Min(8, edge.SourceNodeId.Length)]}'.");
            if (!_nodes.Any(n => n.Id == edge.TargetNodeId))
                _validationErrors.Add($"Edge references non-existent target node '{edge.TargetNodeId[..Math.Min(8, edge.TargetNodeId.Length)]}'.");
            if (edge.SourceNodeId == edge.TargetNodeId)
                _validationErrors.Add($"Edge cannot connect a node to itself.");
        }

        var nodeIds = new HashSet<string>(_nodes.Select(n => n.Id));
        var connectedNodes = new HashSet<string>(
            _edges.Select(e => e.SourceNodeId).Concat(_edges.Select(e => e.TargetNodeId)));
        foreach (var node in _nodes.Where(n => n.Type != WorkflowNodeType.Start && n.Type != WorkflowNodeType.End))
        {
            if (!connectedNodes.Contains(node.Id))
                _validationErrors.Add($"Node '{node.Name}' is not connected to any edges.");
        }

        if (_validationErrors.Count == 0)
        {
            _statusMessage = "Workflow is valid.";
            _statusSeverity = Severity.Success;
        }
        else
        {
            _statusMessage = $"Validation found {_validationErrors.Count} error(s).";
            _statusSeverity = Severity.Error;
        }
    }

    private async Task SaveAsync()
    {
        if (string.IsNullOrWhiteSpace(_name))
        {
            _statusMessage = "Workflow name is required.";
            _statusSeverity = Severity.Error;
            return;
        }

        try
        {
            var client = HttpClientFactory.CreateClient("Api");
            var nodeRequests = _nodes.Select(n => new WorkflowNodeConfigRequest(
                n.Id, n.Name, n.Type, n.AgentId, n.DelaySeconds,
                n.TimeoutMinutes, n.RetryPolicy, n.InputMappings, n.OutputMappings,
                n.PositionX, n.PositionY)).ToList();

            var edgeRequests = _edges.Select(e => new WorkflowEdgeConfigRequest(
                e.SourceNodeId, e.TargetNodeId, e.Condition, e.Priority, e.Label)).ToList();

            var triggerRequest = new WorkflowV2TriggerConfigRequest(_triggerType, _cronExpression, _webhookEventFilter);

            if (IsNew)
            {
                var request = new CreateWorkflowV2Request(
                    _repositoryId, _name, _description, nodeRequests, edgeRequests,
                    triggerRequest, _enabled, _maxConcurrentNodes);

                var response = await client.PostAsJsonAsync("/api/workflows-v2", request);
                if (response.IsSuccessStatusCode)
                {
                    var created = await response.Content.ReadFromJsonAsync<WorkflowV2Document>();
                    if (created is not null)
                    {
                        Snackbar.Add("Workflow created", Severity.Success);
                        Nav.NavigateTo($"/workflows-v2/{created.Id}");
                    }
                }
                else
                {
                    _statusMessage = $"Failed to create workflow: {response.StatusCode}";
                    _statusSeverity = Severity.Error;
                }
            }
            else
            {
                var request = new UpdateWorkflowV2Request(
                    _name, _description, nodeRequests, edgeRequests,
                    triggerRequest, _enabled, _maxConcurrentNodes);

                var response = await client.PutAsJsonAsync($"/api/workflows-v2/{Id}", request);
                if (response.IsSuccessStatusCode)
                {
                    _statusMessage = "Workflow saved successfully.";
                    _statusSeverity = Severity.Success;
                    Snackbar.Add("Workflow saved", Severity.Success);
                }
                else
                {
                    _statusMessage = $"Failed to save workflow: {response.StatusCode}";
                    _statusSeverity = Severity.Error;
                }
            }
        }
        catch (Exception ex)
        {
            _statusMessage = $"Error saving workflow: {ex.Message}";
            _statusSeverity = Severity.Error;
        }
    }

    private async Task ExecuteWorkflowAsync()
    {
        if (IsNew) return;

        try
        {
            var client = HttpClientFactory.CreateClient("Api");
            var request = new ExecuteWorkflowV2Request(TriggeredBy: "manual");
            var response = await client.PostAsJsonAsync($"/api/workflows-v2/{Id}/execute", request);

            if (response.IsSuccessStatusCode)
            {
                var execution = await response.Content.ReadFromJsonAsync<WorkflowExecutionV2Document>();
                if (execution is not null)
                {
                    Snackbar.Add("Workflow execution started", Severity.Success);
                    Nav.NavigateTo($"/workflows-v2/executions/{execution.Id}");
                    return;
                }
            }

            _statusMessage = $"Failed to execute workflow: {response.StatusCode}";
            _statusSeverity = Severity.Error;
        }
        catch (Exception ex)
        {
            _statusMessage = $"Failed to execute workflow: {ex.Message}";
            _statusSeverity = Severity.Error;
        }
    }
}
