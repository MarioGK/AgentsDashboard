<MudDialog>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="@_isValid">
            <MudStack Spacing="3">
                <MudTextField @bind-Value="_name" Label="Name" Required RequiredError="Name is required" />

                <MudSelect @bind-Value="_type" Label="Type" Required>
                    @foreach (WorkflowNodeType t in Enum.GetValues<WorkflowNodeType>())
                    {
                        <MudSelectItem Value="@t">@t</MudSelectItem>
                    }
                </MudSelect>

                @if (_type == WorkflowNodeType.Agent)
                {
                    <MudSelect T="string" @bind-Value="_agentId" Label="Agent" Required
                               RequiredError="Agent is required for Agent nodes">
                        @foreach (var agent in Agents)
                        {
                            <MudSelectItem T="string" Value="@agent.Id">@agent.Name (@agent.Harness)</MudSelectItem>
                        }
                    </MudSelect>
                }

                @if (_type == WorkflowNodeType.Delay)
                {
                    <MudNumericField @bind-Value="_delaySeconds" Label="Delay (seconds)" Min="1" Max="86400"
                                     Required RequiredError="Delay is required for Delay nodes" />
                }

                @if (_type == WorkflowNodeType.Approval)
                {
                    <MudNumericField @bind-Value="_timeoutMinutes" Label="Approval Timeout (minutes)" Min="1" Max="1440" />
                }

                <MudNumericField @bind-Value="_timeoutMinutes" Label="Timeout (minutes)" Min="1" Max="1440" />
            </MudStack>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Submit" Disabled="@(!_isValid)">
            @(Node is not null ? "Update" : "Add")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter]
    public WorkflowNodeConfig? Node { get; set; }

    [Parameter]
    public List<AgentDocument> Agents { get; set; } = [];

    private MudForm _form = default!;
    private bool _isValid;

    private string _name = string.Empty;
    private WorkflowNodeType _type = WorkflowNodeType.Agent;
    private string? _agentId;
    private int? _delaySeconds = 60;
    private int? _timeoutMinutes = 30;

    protected override void OnInitialized()
    {
        if (Node is not null)
        {
            _name = Node.Name;
            _type = Node.Type;
            _agentId = Node.AgentId;
            _delaySeconds = Node.DelaySeconds ?? 60;
            _timeoutMinutes = Node.TimeoutMinutes ?? 30;
        }
    }

    private void Cancel() => MudDialog.Cancel();

    private void Submit()
    {
        var node = new WorkflowNodeConfig
        {
            Id = Node?.Id ?? Guid.NewGuid().ToString("N"),
            Name = _name.Trim(),
            Type = _type,
            AgentId = _type == WorkflowNodeType.Agent ? _agentId : null,
            DelaySeconds = _type == WorkflowNodeType.Delay ? _delaySeconds : null,
            TimeoutMinutes = _timeoutMinutes,
            RetryPolicy = Node?.RetryPolicy,
            InputMappings = Node?.InputMappings ?? [],
            OutputMappings = Node?.OutputMappings ?? [],
            PositionX = Node?.PositionX ?? 0,
            PositionY = Node?.PositionY ?? 0,
        };

        MudDialog.Close(DialogResult.Ok(node));
    }
}
