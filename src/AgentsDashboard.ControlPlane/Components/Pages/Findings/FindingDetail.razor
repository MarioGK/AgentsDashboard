@page "/settings/findings/{Id}"
@layout SettingsLayout
@rendermode InteractiveServer

@inject AgentsDashboard.ControlPlane.Data.IOrchestratorStore Store
@inject AgentsDashboard.ControlPlane.Services.RunDispatcher Dispatcher
@inject AgentsDashboard.ControlPlane.Services.TaskTemplateService TemplateService
@inject NavigationManager Navigation

<PageTitle>Finding @Id?[..8] - AgentsDashboard</PageTitle>

@if (_finding is null)
{
    <MudProgressLinear Indeterminate />
}
else
{
    <MudStack Row AlignItems="AlignItems.Center" Class="mb-4">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Href="/settings/findings" />
        <MudText Typo="Typo.h4">@_finding.Title</MudText>
        <MudChip T="string" Color="@GetSeverityColor(_finding.Severity)" Class="ml-2">@_finding.Severity</MudChip>
        <MudChip T="string" Variant="Variant.Outlined">@_finding.State</MudChip>
        <MudSpacer />
    </MudStack>

    <MudPaper Class="pa-6 mb-4" Elevation="2">
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudField Label="Finding ID" Variant="Variant.Outlined">@_finding.Id</MudField>
            </MudItem>
            <MudItem xs="12" md="6">
                <MudField Label="Created" Variant="Variant.Outlined">@_finding.CreatedAtUtc.ToString("g") UTC</MudField>
            </MudItem>
            <MudItem xs="12" md="6">
                <MudField Label="Repository" Variant="Variant.Outlined">
                    <MudLink Href="@($"/settings/repositories/{_finding.RepositoryId}")">@_finding.RepositoryId[..8]</MudLink>
                </MudField>
            </MudItem>
            <MudItem xs="12" md="6">
                <MudField Label="Source Run" Variant="Variant.Outlined">
                    <MudLink Href="@($"/settings/runs/{_finding.RunId}")">@_finding.RunId[..8]</MudLink>
                </MudField>
            </MudItem>
            <MudItem xs="12" md="6">
                <MudField Label="Assigned To" Variant="Variant.Outlined">
                    @(string.IsNullOrEmpty(_finding.AssignedTo) ? "Unassigned" : _finding.AssignedTo)
                </MudField>
            </MudItem>
            <MudItem xs="12">
                <MudField Label="Description" Variant="Variant.Outlined">@_finding.Description</MudField>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudText Typo="Typo.h6" Class="mb-3">Actions</MudText>
    <MudStack Row Spacing="2" Class="mb-4">
        <MudTextField @bind-Value="_assignee" Label="Assign To" Variant="Variant.Outlined" Style="max-width: 250px;" />
        <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Assignment"
                   OnClick="AssignAsync">
            Assign
        </MudButton>
    </MudStack>
    <MudStack Row Spacing="2">
        @if (_finding.State is FindingState.New)
        {
            <MudButton Variant="Variant.Outlined" Color="Color.Info" StartIcon="@Icons.Material.Filled.Visibility"
                       OnClick="() => SetStateAsync(FindingState.Acknowledged)">
                Acknowledge
            </MudButton>
        }
        @if (_finding.State is FindingState.New or FindingState.Acknowledged or FindingState.InProgress)
        {
            <MudButton Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Filled.CheckCircle"
                       OnClick="() => SetStateAsync(FindingState.Resolved)">
                Resolve
            </MudButton>
            <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Replay"
                       OnClick="RetryAsync">
                Retry Run
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Default" StartIcon="@Icons.Material.Filled.VisibilityOff"
                       OnClick="() => SetStateAsync(FindingState.Ignored)">
                Ignore
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.AddTask"
                       OnClick="() => _showTaskDialog = true">
                Create Follow-up Task
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Warning" StartIcon="@Icons.Material.Filled.Replay"
                       OnClick="() => _showRegressionDialog = true">
                Create Regression Replay
            </MudButton>
        }
    </MudStack>
}

<MudDialog @bind-Visible="_showTaskDialog">
    <TitleContent>Create Follow-up Task</TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="_taskName" Label="Task Name" Class="mb-3" />
        <MudSelect @bind-Value="_taskHarness" Label="Harness" Class="mb-3">
            <MudSelectItem T="string" Value='@("codex")'>Codex</MudSelectItem>
            <MudSelectItem T="string" Value='@("opencode")'>OpenCode</MudSelectItem>
            <MudSelectItem T="string" Value='@("claude-code")'>Claude Code</MudSelectItem>
            <MudSelectItem T="string" Value='@("zai")'>Zai (GLM-5)</MudSelectItem>
        </MudSelect>
        <MudTextField @bind-Value="_taskCommand" Label="Command" Class="mb-3" />
        <MudTextField @bind-Value="_taskPrompt" Label="Prompt" Lines="4" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="() => _showTaskDialog = false">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="CreateFollowupTaskAsync">Create</MudButton>
    </DialogActions>
</MudDialog>

<MudDialog @bind-Visible="_showRegressionDialog">
    <TitleContent>Create Regression Replay Task</TitleContent>
    <DialogContent>
        <MudAlert Severity="Severity.Info" Class="mb-3">
            This will create a task linked to run <strong>@(_finding?.RunId?[..8])</strong> for regression replay.
        </MudAlert>
        <MudTextField @bind-Value="_regressionTaskName" Label="Task Name" Class="mb-3" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="() => _showRegressionDialog = false">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="CreateRegressionReplayTaskAsync">Create</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter] public string? Id { get; set; }

    private FindingDocument? _finding;
    private string _assignee = string.Empty;
    private bool _showTaskDialog;
    private bool _showRegressionDialog;
    private string _taskName = string.Empty;
    private string _taskHarness = "codex";
    private string _taskCommand = string.Empty;
    private string _taskPrompt = string.Empty;
    private string _regressionTaskName = "Regression Replay";

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(Id))
            _finding = await Store.GetFindingAsync(Id, CancellationToken.None);
    }

    private async Task SetStateAsync(FindingState state)
    {
        if (_finding is null) return;
        var updated = await Store.UpdateFindingStateAsync(_finding.Id, state, CancellationToken.None);
        if (updated is not null) _finding = updated;
    }

    private async Task AssignAsync()
    {
        if (_finding is null) return;
        await Store.AssignFindingAsync(_finding.Id, _assignee.Trim(), CancellationToken.None);
        _finding = await Store.GetFindingAsync(_finding.Id, CancellationToken.None);
    }

    private async Task CreateFollowupTaskAsync()
    {
        if (_finding is null) return;
        _showTaskDialog = false;

        var created = await CreateTaskFromFindingAsync(
            _taskName.Trim(),
            _taskHarness,
            _taskCommand,
            _taskPrompt,
            [_finding.RunId]);

        if (created is not null)
            Navigation.NavigateTo($"/settings/repositories/{_finding.RepositoryId}");
    }

    private async Task CreateRegressionReplayTaskAsync()
    {
        if (_finding is null) return;
        _showRegressionDialog = false;

        var template = await TemplateService.GetTemplateByTemplateIdAsync("regression-replay", CancellationToken.None);
        if (template is null) return;

        var created = await CreateTaskFromFindingAsync(
            _regressionTaskName.Trim(),
            template.Harness,
            string.Join(" && ", template.Commands),
            template.Prompt,
            [_finding.RunId]);

        if (created is not null)
            Navigation.NavigateTo($"/settings/repositories/{_finding.RepositoryId}");
    }

    private Task RetryAsync()
    {
        if (_finding is null) return Task.CompletedTask;
        return RetryInternalAsync();
    }

    private async Task RetryInternalAsync()
    {
        if (_finding is null) return;

        var run = await Store.GetRunAsync(_finding.RunId, CancellationToken.None);
        if (run is null) return;

        var task = await Store.GetTaskAsync(run.TaskId, CancellationToken.None);
        if (task is null) return;

        var repo = await Store.GetRepositoryAsync(task.RepositoryId, CancellationToken.None);
        if (repo is null) return;

        var retryRun = await Store.CreateRunAsync(task, CancellationToken.None, run.Attempt + 1);
        await Dispatcher.DispatchAsync(repo, task, retryRun, CancellationToken.None);
        await Store.UpdateFindingStateAsync(_finding.Id, FindingState.InProgress, CancellationToken.None);

        Navigation.NavigateTo($"/settings/runs/{retryRun.Id}");
    }

    private static Color GetSeverityColor(FindingSeverity severity) => severity switch
    {
        FindingSeverity.Critical => Color.Error,
        FindingSeverity.High => Color.Warning,
        FindingSeverity.Medium => Color.Info,
        FindingSeverity.Low => Color.Default,
        _ => Color.Default,
    };

    private async Task<TaskDocument?> CreateTaskFromFindingAsync(
        string name,
        string harness,
        string command,
        string prompt,
        List<string>? linkedFailureRuns)
    {
        if (_finding is null)
            return null;

        var run = await Store.GetRunAsync(_finding.RunId, CancellationToken.None);
        if (run is null)
            return null;

        var sourceTask = await Store.GetTaskAsync(run.TaskId, CancellationToken.None);
        if (sourceTask is null)
            return null;

        var createTaskRequest = new CreateTaskRequest(
            RepositoryId: sourceTask.RepositoryId,
            Name: name,
            Kind: TaskKind.OneShot,
            Harness: harness,
            Prompt: prompt,
            Command: command,
            AutoCreatePullRequest: false,
            CronExpression: string.Empty,
            Enabled: true,
            LinkedFailureRuns: linkedFailureRuns ?? [_finding.RunId]);

        return await Store.CreateTaskAsync(createTaskRequest, CancellationToken.None);
    }
}
