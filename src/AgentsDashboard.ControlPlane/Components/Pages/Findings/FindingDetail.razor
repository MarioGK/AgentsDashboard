@page "/findings/{Id}"
@attribute [Authorize]
@rendermode InteractiveServer

@inject AgentsDashboard.ControlPlane.Data.OrchestratorStore Store
@inject AgentsDashboard.ControlPlane.Services.RunDispatcher Dispatcher
@inject NavigationManager Navigation

<PageTitle>Finding @Id?[..8] - AgentsDashboard</PageTitle>

@if (_finding is null)
{
    <MudProgressLinear Indeterminate />
}
else
{
    <MudStack Row AlignItems="AlignItems.Center" Class="mb-4">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Href="/findings" />
        <MudText Typo="Typo.h4">@_finding.Title</MudText>
        <MudChip T="string" Color="@GetSeverityColor(_finding.Severity)" Class="ml-2">@_finding.Severity</MudChip>
        <MudChip T="string" Variant="Variant.Outlined">@_finding.State</MudChip>
        <MudSpacer />
    </MudStack>

    <MudPaper Class="pa-6 mb-4" Elevation="2">
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudField Label="Finding ID" Variant="Variant.Outlined">@_finding.Id</MudField>
            </MudItem>
            <MudItem xs="12" md="6">
                <MudField Label="Created" Variant="Variant.Outlined">@_finding.CreatedAtUtc.ToString("g") UTC</MudField>
            </MudItem>
            <MudItem xs="12" md="6">
                <MudField Label="Repository" Variant="Variant.Outlined">
                    <MudLink Href="@($"/repositories/{_finding.RepositoryId}")">@_finding.RepositoryId[..8]</MudLink>
                </MudField>
            </MudItem>
            <MudItem xs="12" md="6">
                <MudField Label="Source Run" Variant="Variant.Outlined">
                    <MudLink Href="@($"/runs/{_finding.RunId}")">@_finding.RunId[..8]</MudLink>
                </MudField>
            </MudItem>
            <MudItem xs="12" md="6">
                <MudField Label="Assigned To" Variant="Variant.Outlined">
                    @(string.IsNullOrEmpty(_finding.AssignedTo) ? "Unassigned" : _finding.AssignedTo)
                </MudField>
            </MudItem>
            <MudItem xs="12">
                <MudField Label="Description" Variant="Variant.Outlined">@_finding.Description</MudField>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudText Typo="Typo.h6" Class="mb-3">Actions</MudText>
    <MudStack Row Spacing="2" Class="mb-4">
        <MudTextField @bind-Value="_assignee" Label="Assign To" Variant="Variant.Outlined" Style="max-width: 250px;" />
        <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Assignment"
                   OnClick="AssignAsync">
            Assign
        </MudButton>
    </MudStack>
    <MudStack Row Spacing="2">
        @if (_finding.State is FindingState.New)
        {
            <MudButton Variant="Variant.Outlined" Color="Color.Info" StartIcon="@Icons.Material.Filled.Visibility"
                       OnClick="() => SetStateAsync(FindingState.Acknowledged)">
                Acknowledge
            </MudButton>
        }
        @if (_finding.State is FindingState.New or FindingState.Acknowledged or FindingState.InProgress)
        {
            <MudButton Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Filled.CheckCircle"
                       OnClick="() => SetStateAsync(FindingState.Resolved)">
                Resolve
            </MudButton>
            <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Replay"
                       OnClick="RetryAsync">
                Retry Run
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Default" StartIcon="@Icons.Material.Filled.VisibilityOff"
                       OnClick="() => SetStateAsync(FindingState.Ignored)">
                Ignore
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.AddTask"
                       OnClick="CreateFollowupTaskAsync">
                Create Follow-up Task
            </MudButton>
        }
    </MudStack>
}

@code {
    [Parameter] public string? Id { get; set; }

    private FindingDocument? _finding;
    private string _assignee = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(Id))
            _finding = await Store.GetFindingAsync(Id, CancellationToken.None);
    }

    private async Task SetStateAsync(FindingState state)
    {
        if (_finding is null) return;
        var updated = await Store.UpdateFindingStateAsync(_finding.Id, state, CancellationToken.None);
        if (updated is not null) _finding = updated;
    }

    private async Task AssignAsync()
    {
        if (_finding is null) return;
        await Store.AssignFindingAsync(_finding.Id, _assignee.Trim(), CancellationToken.None);
        _finding = await Store.GetFindingAsync(_finding.Id, CancellationToken.None);
    }

    private Task CreateFollowupTaskAsync()
    {
        if (_finding is null) return Task.CompletedTask;
        Navigation.NavigateTo($"/repositories/{_finding.RepositoryId}");
        return Task.CompletedTask;
    }

    private async Task RetryAsync()
    {
        if (_finding is null) return;

        var run = await Store.GetRunAsync(_finding.RunId, CancellationToken.None);
        if (run is null) return;

        var task = await Store.GetTaskAsync(run.TaskId, CancellationToken.None);
        if (task is null) return;

        var repo = await Store.GetRepositoryAsync(task.RepositoryId, CancellationToken.None);
        if (repo is null) return;

        var project = await Store.GetProjectAsync(repo.ProjectId, CancellationToken.None);
        if (project is null) return;

        var retryRun = await Store.CreateRunAsync(task, project.Id, CancellationToken.None, run.Attempt + 1);
        await Dispatcher.DispatchAsync(project, repo, task, retryRun, CancellationToken.None);
        await Store.UpdateFindingStateAsync(_finding.Id, FindingState.InProgress, CancellationToken.None);

        Navigation.NavigateTo($"/runs/{retryRun.Id}");
    }

    private static Color GetSeverityColor(FindingSeverity severity) => severity switch
    {
        FindingSeverity.Critical => Color.Error,
        FindingSeverity.High => Color.Warning,
        FindingSeverity.Medium => Color.Info,
        FindingSeverity.Low => Color.Default,
        _ => Color.Default,
    };
}
