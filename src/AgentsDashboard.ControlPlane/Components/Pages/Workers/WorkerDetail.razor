@page "/settings/workers/{WorkerId}"
@layout SettingsLayout
@rendermode InteractiveServer
@using AgentsDashboard.Contracts.Worker
@inject AgentsDashboard.ControlPlane.Services.IWorkerLifecycleManager WorkerLifecycle
@inject AgentsDashboard.ControlPlane.Services.IMagicOnionClientFactory MagicOnionClientFactory
@inject ISnackbar Snackbar

<PageTitle>Worker Details - AgentsDashboard</PageTitle>

<MudStack Spacing="3">
    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
        <MudButton Variant="Variant.Outlined"
                   StartIcon="@Icons.Material.Filled.ArrowBack"
                   Href="/settings/workers">
            Back
        </MudButton>

        <MudText Typo="Typo.h4">Worker Details</MudText>
        <MudChip T="string" Size="Size.Small" Color="@GetWorkerStatusColor()">
            @GetWorkerStatusText()
        </MudChip>
        <MudSpacer />

        <MudButton Variant="Variant.Outlined"
                   Color="Color.Info"
                   StartIcon="@Icons.Material.Filled.Refresh"
                   OnClick="RefreshAsync"
                   Disabled="@_loading">
            Refresh
        </MudButton>
    </MudStack>

    <MudText Typo="Typo.body2" Color="Color.Secondary">
        Worker ID: <code>@WorkerId</code>
    </MudText>

    @if (_loading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Info" />
    }
    else if (_worker is null)
    {
        <MudAlert Severity="Severity.Warning">
            Worker <code>@WorkerId</code> is not currently available.
        </MudAlert>
    }
    else
    {
        <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4">
            <MudTabPanel Text="Overview" Icon="@Icons.Material.Filled.Info">
                <MudSimpleTable Dense="true">
                    <tbody>
                        <tr>
                            <td><MudText Typo="Typo.body2" Color="Color.Secondary">Container ID</MudText></td>
                            <td><MudText Typo="Typo.body2" Style="font-family: monospace;">@_worker.ContainerId</MudText></td>
                        </tr>
                        <tr>
                            <td><MudText Typo="Typo.body2" Color="Color.Secondary">Container Name</MudText></td>
                            <td><MudText Typo="Typo.body2">@_worker.ContainerName</MudText></td>
                        </tr>
                        <tr>
                            <td><MudText Typo="Typo.body2" Color="Color.Secondary">Lifecycle State</MudText></td>
                            <td><MudText Typo="Typo.body2">@_worker.LifecycleState</MudText></td>
                        </tr>
                        <tr>
                            <td><MudText Typo="Typo.body2" Color="Color.Secondary">Slots</MudText></td>
                            <td><MudText Typo="Typo.body2">@_worker.ActiveSlots / @_worker.MaxSlots</MudText></td>
                        </tr>
                        <tr>
                            <td><MudText Typo="Typo.body2" Color="Color.Secondary">gRPC Endpoint</MudText></td>
                            <td><MudText Typo="Typo.body2" Style="font-family: monospace;">@_worker.GrpcEndpoint</MudText></td>
                        </tr>
                        <tr>
                            <td><MudText Typo="Typo.body2" Color="Color.Secondary">Proxy Endpoint</MudText></td>
                            <td><MudText Typo="Typo.body2" Style="font-family: monospace;">@_worker.ProxyEndpoint</MudText></td>
                        </tr>
                        <tr>
                            <td><MudText Typo="Typo.body2" Color="Color.Secondary">CPU / Memory</MudText></td>
                            <td><MudText Typo="Typo.body2">@($"{_worker.CpuPercent:0.0}% / {_worker.MemoryPercent:0.0}%")</MudText></td>
                        </tr>
                        <tr>
                            <td><MudText Typo="Typo.body2" Color="Color.Secondary">Last Activity (UTC)</MudText></td>
                            <td><MudText Typo="Typo.body2">@_worker.LastActivityUtc.ToString("g")</MudText></td>
                        </tr>
                        <tr>
                            <td><MudText Typo="Typo.body2" Color="Color.Secondary">Image Ref</MudText></td>
                            <td><MudText Typo="Typo.body2" Style="font-family: monospace;">@_worker.ImageRef</MudText></td>
                        </tr>
                    </tbody>
                </MudSimpleTable>
            </MudTabPanel>

            <MudTabPanel Text="Tools" Icon="@Icons.Material.Filled.Terminal">
                <MudStack Spacing="2">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudText Typo="Typo.h6">Harness Tools</MudText>
                        <MudSpacer />
                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Info"
                                   StartIcon="@Icons.Material.Filled.Refresh"
                                   OnClick="RefreshToolsAsync"
                                   Disabled="@(_isRefreshingTools || _worker is null)">
                            @if (_isRefreshingTools)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                <span>Refreshing...</span>
                            }
                            else
                            {
                                <span>Refresh Tools</span>
                            }
                        </MudButton>
                    </MudStack>

                    @if (!string.IsNullOrWhiteSpace(_toolError))
                    {
                        <MudAlert Severity="Severity.Warning">@_toolError</MudAlert>
                    }

                    <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4">
                        @foreach (var tool in Tools)
                        {
                            <MudTabPanel Text="@tool.DisplayName" Icon="@tool.Icon">
                                @RenderToolPanel(tool)
                            </MudTabPanel>
                        }
                    </MudTabs>

                    @if (_toolsCheckedAtUtc.HasValue)
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            Last refreshed: @_toolsCheckedAtUtc.Value.ToLocalTime().ToString("g")
                        </MudText>
                    }
                </MudStack>
            </MudTabPanel>
        </MudTabs>
    }
</MudStack>

@code {
    [Parameter]
    public string WorkerId { get; set; } = string.Empty;

    private sealed record ToolInfo(string Command, string DisplayName, string Description, string Icon);

    private static readonly ToolInfo[] Tools =
    [
        new("codex", "Codex", "OpenAI-based CLI harness used for code-focused tasks.", Icons.Material.Filled.Code),
        new("opencode", "OpenCode", "Alternative open-source harness for coding tasks.", Icons.Material.Filled.OpenInNew),
        new("claude-code", "Claude Code", "Anthropic-backed Claude Code harness for model execution.", Icons.Material.Filled.Psychology),
        new("zai", "Z.ai", "GLM-5 based harness for additional model coverage.", Icons.Material.Filled.SmartToy)
    ];

    private AgentsDashboard.ControlPlane.Services.WorkerRuntime? _worker;
    private bool _loading = true;
    private bool _isRefreshingTools;
    private string? _toolError;
    private DateTime? _toolsCheckedAtUtc;
    private IReadOnlyDictionary<string, HarnessToolStatus> _toolStatusByCommand = new Dictionary<string, HarnessToolStatus>(StringComparer.OrdinalIgnoreCase);

    protected override async Task OnParametersSetAsync()
    {
        await LoadAsync();
    }

    private async Task RefreshAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        _loading = true;
        _toolError = null;

        try
        {
            _worker = await WorkerLifecycle.GetWorkerAsync(WorkerId, CancellationToken.None);

            if (_worker is null)
            {
                _toolStatusByCommand = new Dictionary<string, HarnessToolStatus>(StringComparer.OrdinalIgnoreCase);
                _toolsCheckedAtUtc = null;
                return;
            }

            await RefreshToolsAsync(showFailureToast: false);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task RefreshToolsAsync()
    {
        await RefreshToolsAsync(showFailureToast: true);
    }

    private async Task RefreshToolsAsync(bool showFailureToast)
    {
        _isRefreshingTools = true;
        _toolError = null;

        try
        {
            _worker = await WorkerLifecycle.GetWorkerAsync(WorkerId, CancellationToken.None);

            if (_worker is null || !_worker.IsRunning)
            {
                _toolStatusByCommand = new Dictionary<string, HarnessToolStatus>(StringComparer.OrdinalIgnoreCase);
                _toolError = "Worker is not running; tool status is unavailable.";
                _toolsCheckedAtUtc = DateTime.UtcNow;
                return;
            }

            var workerClient = MagicOnionClientFactory.CreateWorkerGatewayService(_worker.WorkerId, _worker.GrpcEndpoint);
            var response = await workerClient.GetHarnessToolsAsync(new GetHarnessToolsRequest
            {
                RequestId = Guid.NewGuid().ToString("N")
            });

            if (!response.Success)
            {
                _toolStatusByCommand = new Dictionary<string, HarnessToolStatus>(StringComparer.OrdinalIgnoreCase);
                _toolError = string.IsNullOrWhiteSpace(response.ErrorMessage)
                    ? "Worker returned an unknown tool status error."
                    : response.ErrorMessage;
                _toolsCheckedAtUtc = response.CheckedAt.UtcDateTime;
                return;
            }

            _toolStatusByCommand = response.Tools
                .GroupBy(x => NormalizeCommand(x.Command), StringComparer.OrdinalIgnoreCase)
                .ToDictionary(g => g.Key, g => g.Last(), StringComparer.OrdinalIgnoreCase);

            _toolsCheckedAtUtc = response.CheckedAt.UtcDateTime;
        }
        catch (Grpc.Core.RpcException ex) when (ex.StatusCode == Grpc.Core.StatusCode.Unimplemented)
        {
            _toolStatusByCommand = new Dictionary<string, HarnessToolStatus>(StringComparer.OrdinalIgnoreCase);
            _toolsCheckedAtUtc = DateTime.UtcNow;
            _toolError = "Worker image does not support harness tool diagnostics yet. Ensure the worker image and recycle this worker.";

            if (showFailureToast)
            {
                Snackbar.Add(_toolError, Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            _toolStatusByCommand = new Dictionary<string, HarnessToolStatus>(StringComparer.OrdinalIgnoreCase);
            _toolsCheckedAtUtc = DateTime.UtcNow;
            _toolError = $"Failed to load worker tool status: {ex.Message}";

            if (showFailureToast)
            {
                Snackbar.Add(_toolError, Severity.Warning);
            }
        }
        finally
        {
            _isRefreshingTools = false;
        }
    }

    private HarnessToolStatus? GetToolStatus(string command)
    {
        return _toolStatusByCommand.TryGetValue(NormalizeCommand(command), out var status)
            ? status
            : null;
    }

    private static string NormalizeCommand(string command)
    {
        if (string.Equals(command, "claude", StringComparison.OrdinalIgnoreCase))
        {
            return "claude-code";
        }

        return command.Trim();
    }

    private Color GetWorkerStatusColor()
    {
        if (_worker is null)
        {
            return Color.Warning;
        }

        if (!_worker.IsRunning)
        {
            return Color.Error;
        }

        return _worker.LifecycleState switch
        {
            AgentsDashboard.ControlPlane.Services.WorkerLifecycleState.Busy => Color.Warning,
            AgentsDashboard.ControlPlane.Services.WorkerLifecycleState.Ready => Color.Success,
            AgentsDashboard.ControlPlane.Services.WorkerLifecycleState.Draining => Color.Warning,
            _ => Color.Info
        };
    }

    private string GetWorkerStatusText()
    {
        if (_worker is null)
        {
            return "Unavailable";
        }

        if (!_worker.IsRunning)
        {
            return "Stopped";
        }

        return _worker.LifecycleState.ToString();
    }

    private RenderFragment RenderToolPanel(ToolInfo tool) => @<MudStack Spacing="2">
        @{
            var health = GetToolStatus(tool.Command);
            var status = NormalizeStatus(health?.Status);
            var statusColor = status switch
            {
                "available" => Color.Success,
                "unavailable" => Color.Error,
                _ => Color.Default
            };
            var statusText = status switch
            {
                "available" => "Available",
                "unavailable" => "Unavailable",
                _ => "Unknown"
            };
        }

        <MudPaper Class="pa-4" Elevation="0">
            <MudStack Spacing="3">
                <MudText Typo="Typo.h6">@tool.DisplayName</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">@tool.Description</MudText>

                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudChip T="string" Size="Size.Small" Color="@statusColor" Variant="Variant.Filled">
                        @statusText
                    </MudChip>
                </MudStack>

                <MudSimpleTable Dense="true">
                    <tbody>
                        <tr>
                            <td><MudText Typo="Typo.body2" Color="Color.Secondary">Executable</MudText></td>
                            <td><MudText Typo="Typo.body2" Style="font-family: monospace;">@tool.Command</MudText></td>
                        </tr>
                        <tr>
                            <td><MudText Typo="Typo.body2" Color="Color.Secondary">Detected version</MudText></td>
                            <td><MudText Typo="Typo.body2">@(string.IsNullOrWhiteSpace(health?.Version) ? "Not available" : health.Version)</MudText></td>
                        </tr>
                        <tr>
                            <td><MudText Typo="Typo.body2" Color="Color.Secondary">Status</MudText></td>
                            <td><MudText Typo="Typo.body2">@statusText</MudText></td>
                        </tr>
                    </tbody>
                </MudSimpleTable>
            </MudStack>
        </MudPaper>
    </MudStack>;

    private static string NormalizeStatus(string? status)
    {
        if (string.IsNullOrWhiteSpace(status))
        {
            return "unknown";
        }

        var normalized = status.Trim().ToLowerInvariant();
        return normalized is "available" or "unavailable" ? normalized : "unknown";
    }
}
