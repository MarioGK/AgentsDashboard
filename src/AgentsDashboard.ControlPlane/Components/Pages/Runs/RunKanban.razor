@page "/settings/runs"
@layout SettingsLayout
@rendermode InteractiveServer
@implements IDisposable

@inject AgentsDashboard.ControlPlane.Data.IOrchestratorStore Store
@inject AgentsDashboard.ControlPlane.Services.IUiRealtimeBroker UiRealtimeBroker

<PageTitle>Runs - AgentsDashboard</PageTitle>

<MudStack Row AlignItems="AlignItems.Center" Spacing="2" Class="mb-4">
    <MudText Typo="Typo.h4">Runs</MudText>
    <MudSpacer />
    <MudTextField T="string"
                  @bind-Value="_query"
                  Placeholder="Filter by run id, task id, or summary"
                  Variant="Variant.Outlined"
                  Margin="Margin.Dense"
                  Immediate="true"
                  Adornment="Adornment.Start"
                  AdornmentIcon="@Icons.Material.Filled.Search"
                  Style="min-width: 320px;" />
    <MudSelect T="RunState?"
               @bind-Value="_stateFilter"
               Label="State"
               Variant="Variant.Outlined"
               Margin="Margin.Dense"
               Style="min-width: 180px;">
        <MudSelectItem T="RunState?" Value="@((RunState?)null)">All states</MudSelectItem>
        @foreach (var state in _stateOrder)
        {
            <MudSelectItem T="RunState?" Value="@state">@GetRunStateLabel(state)</MudSelectItem>
        }
    </MudSelect>
    <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Refresh" OnClick="LoadAsync">
        Refresh
    </MudButton>
</MudStack>

@if (_loading)
{
    <MudProgressLinear Indeterminate />
}
else
{
    <MudTable Items="FilteredRuns" Dense Hover Striped>
        <HeaderContent>
            <MudTh>Run</MudTh>
            <MudTh>Task</MudTh>
            <MudTh>Status</MudTh>
            <MudTh>Attempt</MudTh>
            <MudTh>Created</MudTh>
            <MudTh>Duration</MudTh>
            <MudTh>Summary</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>
                <MudLink Href="@($"/settings/runs/{context.Id}")" Typo="Typo.body2" Title="@context.Id">
                    @context.Id[..Math.Min(8, context.Id.Length)]
                </MudLink>
            </MudTd>
            <MudTd Title="@context.TaskId">@context.TaskId[..Math.Min(8, context.TaskId.Length)]</MudTd>
            <MudTd>
                <MudChip T="string" Size="Size.Small" Color="@GetRunStateColor(context.State)">
                    @GetRunStateLabel(context.State)
                </MudChip>
            </MudTd>
            <MudTd>@context.Attempt</MudTd>
            <MudTd>@context.CreatedAtUtc.ToLocalTime().ToString("g")</MudTd>
            <MudTd>@FormatDuration(context)</MudTd>
            <MudTd>@(string.IsNullOrWhiteSpace(context.Summary) ? "—" : context.Summary)</MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText Typo="Typo.body2" Color="Color.Secondary">No runs match the current filters.</MudText>
        </NoRecordsContent>
    </MudTable>
}

@code {
    private readonly RunState[] _stateOrder =
    [
        RunState.PendingApproval,
        RunState.Queued,
        RunState.Running,
        RunState.Succeeded,
        RunState.Failed,
        RunState.Cancelled,
        RunState.Obsolete
    ];

    private string _query = string.Empty;
    private RunState? _stateFilter;
    private List<RunDocument> _runs = [];
    private bool _loading = true;
    private IDisposable? _runStatusSubscription;
    private IEnumerable<RunDocument> FilteredRuns => _runs.Where(MatchesFilters);

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();

        _runStatusSubscription = UiRealtimeBroker.Subscribe<AgentsDashboard.Contracts.SignalR.RunStatusChangedEvent>(
            async _ =>
        {
            await InvokeAsync(async () =>
            {
                await LoadAsync();
                StateHasChanged();
            });
        });
    }

    private async Task LoadAsync()
    {
        _loading = true;
        _runs = await Store.ListRecentRunsAsync(CancellationToken.None);
        _loading = false;
    }

    private bool MatchesFilters(RunDocument run)
    {
        if (_stateFilter.HasValue && run.State != _stateFilter.Value)
        {
            return false;
        }

        if (string.IsNullOrWhiteSpace(_query))
        {
            return true;
        }

        var query = _query.Trim();
        if (run.Id.Contains(query, StringComparison.OrdinalIgnoreCase))
        {
            return true;
        }

        if (run.TaskId.Contains(query, StringComparison.OrdinalIgnoreCase))
        {
            return true;
        }

        return !string.IsNullOrWhiteSpace(run.Summary)
            && run.Summary.Contains(query, StringComparison.OrdinalIgnoreCase);
    }

    private static string FormatDuration(RunDocument run)
    {
        if (run.StartedAtUtc is null) return "—";
        var end = run.EndedAtUtc ?? DateTime.UtcNow;
        var duration = end - run.StartedAtUtc.Value;
        if (duration.TotalHours >= 1) return $"{(int)duration.TotalHours}h {duration.Minutes}m";
        return duration.TotalMinutes >= 1 ? $"{duration.TotalMinutes:F0}m {duration.Seconds}s" : $"{duration.TotalSeconds:F0}s";
    }

    private static Color GetRunStateColor(RunState state)
        => TaskRunStatusPresentation.FromRunState(state).Color;

    private static string GetRunStateLabel(RunState state)
        => TaskRunStatusPresentation.FromRunState(state).Label;

    public void Dispose()
    {
        _runStatusSubscription?.Dispose();
    }
}
