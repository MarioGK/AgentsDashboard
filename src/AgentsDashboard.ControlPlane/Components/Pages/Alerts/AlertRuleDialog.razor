@using AgentsDashboard.Contracts.Domain

<MudDialog>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="@_isValid">
            <MudTextField @bind-Value="_name" Label="Rule Name" Required RequiredError="Name is required" />

            <MudSelect @bind-Value="_ruleType" Label="Rule Type" Required>
                <MudSelectItem Value="AlertRuleType.MissingHeartbeat">Missing Heartbeat</MudSelectItem>
                <MudSelectItem Value="AlertRuleType.FailureRateSpike">Failure Rate Spike</MudSelectItem>
                <MudSelectItem Value="AlertRuleType.QueueBacklog">Queue Backlog</MudSelectItem>
                <MudSelectItem Value="AlertRuleType.RepeatedPrFailures">Repeated PR Failures</MudSelectItem>
            </MudSelect>

            <MudNumericField @bind-Value="_threshold" Label="Threshold" Required Min="1"
                            HelperText="@GetThresholdHelperText()" />

            <MudNumericField @bind-Value="_windowMinutes" Label="Window (minutes)" Required Min="1" Max="1440"
                            HelperText="Time window to evaluate the rule (1-1440 minutes)" />

            <MudTextField @bind-Value="_webhookUrl" Label="Webhook URL (optional)"
                         HelperText="HTTP endpoint to POST alert events to" />

            <MudSwitch @bind-Value="_enabled" Label="Enabled" Color="Color.Primary" />
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Submit" Disabled="@(!_isValid)">
            @(IsEdit ? "Update" : "Create")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter]
    public bool IsEdit { get; set; }

    [Parameter]
    public AlertRuleDocument? Rule { get; set; }

    private MudForm _form = default!;
    private bool _isValid;

    private string _name = string.Empty;
    private AlertRuleType _ruleType = AlertRuleType.MissingHeartbeat;
    private int _threshold = 5;
    private int _windowMinutes = 10;
    private string _webhookUrl = string.Empty;
    private bool _enabled = true;

    protected override void OnInitialized()
    {
        if (IsEdit && Rule != null)
        {
            _name = Rule.Name;
            _ruleType = Rule.RuleType;
            _threshold = Rule.Threshold;
            _windowMinutes = Rule.WindowMinutes;
            _webhookUrl = Rule.WebhookUrl;
            _enabled = Rule.Enabled;
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private void Submit()
    {
        var rule = new AlertRuleDocument
        {
            Id = IsEdit && Rule != null ? Rule.Id : Guid.NewGuid().ToString("N"),
            Name = _name,
            RuleType = _ruleType,
            Threshold = _threshold,
            WindowMinutes = _windowMinutes,
            WebhookUrl = _webhookUrl,
            Enabled = _enabled,
            CreatedAtUtc = IsEdit && Rule != null ? Rule.CreatedAtUtc : DateTime.UtcNow
        };

        MudDialog.Close(DialogResult.Ok(rule));
    }

    private string GetThresholdHelperText() => _ruleType switch
    {
        AlertRuleType.MissingHeartbeat => "Minutes since last heartbeat",
        AlertRuleType.FailureRateSpike => "Number of failed runs",
        AlertRuleType.QueueBacklog => "Number of active runs",
        AlertRuleType.RepeatedPrFailures => "Number of consecutive PR failures per repo",
        _ => "Threshold value"
    };
}
