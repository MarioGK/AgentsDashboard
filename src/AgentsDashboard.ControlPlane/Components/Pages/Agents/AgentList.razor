@page "/agents"
@attribute [Authorize]
@rendermode InteractiveServer
@inject AgentsDashboard.ControlPlane.Data.OrchestratorStore Store
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Nav
@using AgentsDashboard.Contracts.Domain

<PageTitle>Agents - AgentsDashboard</PageTitle>

<MudStack Row AlignItems="AlignItems.Center" Class="mb-4">
    <MudText Typo="Typo.h4">Agents</MudText>
    <MudSpacer />
    <MudSelect T="string" Value="_selectedRepoId" Label="Filter by Repository" Variant="Variant.Outlined"
               Dense Class="mr-4" Style="max-width: 300px;" ValueChanged="OnRepositoryFilterChanged">
        <MudSelectItem T="string" Value='@("")'>All Repositories</MudSelectItem>
        @foreach (var repo in _repositories)
        {
            <MudSelectItem T="string" Value="@repo.Id">@repo.Name</MudSelectItem>
        }
    </MudSelect>
    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
               OnClick="OpenCreateDialog">
        Create Agent
    </MudButton>
</MudStack>

@if (_loading)
{
    <MudProgressLinear Indeterminate />
}
else if (_agents.Count == 0)
{
    <MudAlert Severity="Severity.Info">No agents found. Create one to get started.</MudAlert>
}
else
{
    <MudPaper Elevation="2">
        <MudTable Items="@_agents" Hover Dense Striped>
            <HeaderContent>
                <MudTh>Name</MudTh>
                <MudTh>Repository</MudTh>
                <MudTh>Harness</MudTh>
                <MudTh>Enabled</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Name"><b>@context.Name</b></MudTd>
                <MudTd DataLabel="Repository">@GetRepositoryName(context.RepositoryId)</MudTd>
                <MudTd DataLabel="Harness">
                    <MudChip T="string" Size="Size.Small">@context.Harness</MudChip>
                </MudTd>
                <MudTd DataLabel="Enabled">
                    <MudIcon Icon="@(context.Enabled ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Cancel)"
                             Color="@(context.Enabled ? Color.Success : Color.Error)" Size="Size.Small" />
                </MudTd>
                <MudTd DataLabel="Actions">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small"
                                   OnClick="() => OpenEditDialog(context)" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error"
                                   OnClick="() => DeleteAgent(context)" />
                </MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager />
            </PagerContent>
        </MudTable>
    </MudPaper>
}

@code {
    private List<AgentDocument> _agents = [];
    private List<RepositoryDocument> _repositories = [];
    private Dictionary<string, string> _repoNameMap = [];
    private string _selectedRepoId = "";
    private bool _loading = true;
    private readonly DialogOptions _dialogOptions = new() { MaxWidth = MaxWidth.Medium, FullWidth = true };

    protected override async Task OnInitializedAsync()
    {
        await LoadRepositoriesAsync();
        await LoadAgentsAsync();
    }

    private async Task LoadRepositoriesAsync()
    {
        var projects = await Store.ListProjectsAsync(CancellationToken.None);
        var allRepos = new List<RepositoryDocument>();
        foreach (var project in projects)
        {
            var repos = await Store.ListRepositoriesAsync(project.Id, CancellationToken.None);
            allRepos.AddRange(repos);
        }
        _repositories = allRepos.OrderBy(r => r.Name).ToList();
        _repoNameMap = _repositories.ToDictionary(r => r.Id, r => r.Name);
    }

    private async Task LoadAgentsAsync()
    {
        _loading = true;

        _agents = string.IsNullOrEmpty(_selectedRepoId)
            ? await Store.ListAllAgentsAsync(CancellationToken.None)
            : await Store.ListAgentsByRepositoryAsync(_selectedRepoId, CancellationToken.None);

        _loading = false;
    }

    private async Task OnRepositoryFilterChanged(string repoId)
    {
        _selectedRepoId = repoId;
        await LoadAgentsAsync();
    }

    private string GetRepositoryName(string repositoryId)
    {
        return _repoNameMap.TryGetValue(repositoryId, out var name) ? name : repositoryId[..Math.Min(8, repositoryId.Length)];
    }

    private async Task OpenCreateDialog()
    {
        var parameters = new DialogParameters<AgentDialog>
        {
            { x => x.Agent, null },
            { x => x.Repositories, _repositories }
        };

        var dialog = await DialogService.ShowAsync<AgentDialog>("Create Agent", parameters, _dialogOptions);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled && result.Data is AgentDocument newAgent)
        {
            await Store.CreateAgentAsync(newAgent, CancellationToken.None);
            await LoadAgentsAsync();
            Snackbar.Add("Agent created", Severity.Success);
        }
    }

    private async Task OpenEditDialog(AgentDocument agent)
    {
        var parameters = new DialogParameters<AgentDialog>
        {
            { x => x.Agent, agent },
            { x => x.Repositories, _repositories }
        };

        var dialog = await DialogService.ShowAsync<AgentDialog>("Edit Agent", parameters, _dialogOptions);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled && result.Data is AgentDocument updatedAgent)
        {
            await Store.UpdateAgentAsync(agent.Id, updatedAgent, CancellationToken.None);
            await LoadAgentsAsync();
            Snackbar.Add("Agent updated", Severity.Success);
        }
    }

    private async Task DeleteAgent(AgentDocument agent)
    {
        var confirm = await DialogService.ShowMessageBox(
            "Confirm Delete",
            $"Are you sure you want to delete agent '{agent.Name}'?",
            yesText: "Delete", cancelText: "Cancel");

        if (confirm == true)
        {
            await Store.DeleteAgentAsync(agent.Id, CancellationToken.None);
            await LoadAgentsAsync();
            Snackbar.Add("Agent deleted", Severity.Success);
        }
    }
}
