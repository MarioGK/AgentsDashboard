@page "/proxy-audits"
@attribute [Authorize]
@rendermode InteractiveServer
@inject AgentsDashboard.ControlPlane.Data.OrchestratorStore Store

<PageTitle>Proxy Audits - AgentsDashboard</PageTitle>

<MudStack Row AlignItems="AlignItems.Center" Class="mb-4">
    <MudText Typo="Typo.h4">Proxy Audits</MudText>
    <MudSpacer />
    <MudTextField @bind-Value="_projectIdFilter" Label="Project ID" Variant="Variant.Outlined"
                  Margin="Margin.Dense" Style="max-width: 200px;" Clearable />
    <MudTextField @bind-Value="_repoIdFilter" Label="Repo ID" Variant="Variant.Outlined"
                  Margin="Margin.Dense" Style="max-width: 200px;" Clearable />
    <MudTextField @bind-Value="_taskIdFilter" Label="Task ID" Variant="Variant.Outlined"
                  Margin="Margin.Dense" Style="max-width: 200px;" Clearable />
    <MudTextField @bind-Value="_runIdFilter" Label="Run ID" Variant="Variant.Outlined"
                  Margin="Margin.Dense" Style="max-width: 200px;" Clearable />
    <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.FilterAlt" OnClick="ApplyFilters">
        Filter
    </MudButton>
    <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Refresh" OnClick="LoadAsync">
        Refresh
    </MudButton>
</MudStack>

@if (_loading)
{
    <MudProgressLinear Indeterminate />
}
else if (_audits.Count == 0)
{
    <MudAlert Severity="Severity.Info">No proxy audit records found.</MudAlert>
}
else
{
    <MudPaper Elevation="2">
        <MudTable Items="@_audits" Hover Dense Striped @ref="_table">
            <HeaderContent>
                <MudTh>Timestamp</MudTh>
                <MudTh>Path</MudTh>
                <MudTh>Target</MudTh>
                <MudTh>Status</MudTh>
                <MudTh>Latency</MudTh>
                <MudTh>Run ID</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Timestamp">@context.TimestampUtc.ToLocalTime().ToString("g")</MudTd>
                <MudTd DataLabel="Path">
                    <MudTooltip Text="@context.Path" Placement="Placement.Top">
                        <span style="max-width: 300px; display: inline-block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            @context.Path
                        </span>
                    </MudTooltip>
                </MudTd>
                <MudTd DataLabel="Target">@context.UpstreamTarget</MudTd>
                <MudTd DataLabel="Status">
                    <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.StatusCode)">
                        @context.StatusCode
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Latency">@($"{context.LatencyMs:F1} ms")</MudTd>
                <MudTd DataLabel="Run ID">
                    @if (!string.IsNullOrEmpty(context.RunId))
                    {
                        <MudLink Href="@($"/runs/{context.RunId}")">@context.RunId[..Math.Min(8, context.RunId.Length)]</MudLink>
                    }
                </MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager PageSizeOptions="new int[] { 25, 50, 100, 200 }" />
            </PagerContent>
        </MudTable>
    </MudPaper>
}

@code {
    private List<ProxyAuditDocument> _audits = [];
    private bool _loading = true;
    private string? _projectIdFilter;
    private string? _repoIdFilter;
    private string? _taskIdFilter;
    private string? _runIdFilter;
    private MudTable<ProxyAuditDocument> _table = null!;

    protected override async Task OnInitializedAsync() => await LoadAsync();

    private async Task LoadAsync()
    {
        _loading = true;
        _audits = await Store.ListProxyAuditsAsync(null, null, null, null, 200, CancellationToken.None);
        _loading = false;
    }

    private async Task ApplyFilters()
    {
        _loading = true;
        _audits = await Store.ListProxyAuditsAsync(
            _projectIdFilter,
            _repoIdFilter,
            _taskIdFilter,
            _runIdFilter,
            200,
            CancellationToken.None);
        _loading = false;
    }

    private static Color GetStatusColor(int statusCode) => statusCode switch
    {
        >= 200 and < 300 => Color.Success,
        >= 300 and < 400 => Color.Info,
        >= 400 and < 500 => Color.Warning,
        >= 500 => Color.Error,
        _ => Color.Default,
    };
}
