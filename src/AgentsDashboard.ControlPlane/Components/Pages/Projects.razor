@page "/projects"
@rendermode InteractiveServer
@inject Data.OrchestratorStore Store
@inject NavigationManager Nav
@inject IDialogService DialogService

<PageTitle>Projects</PageTitle>

<MudStack Spacing="2">
    <MudText Typo="Typo.h4">Projects</MudText>

    <MudPaper Class="pa-4">
        <MudText Typo="Typo.h6" Class="mb-3">Create Project</MudText>
        <MudGrid>
            <MudItem xs="12" md="4">
                <MudTextField @bind-Value="_newProjectName" Label="Project Name" Required="true" />
            </MudItem>
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="_newProjectDescription" Label="Description" />
            </MudItem>
            <MudItem xs="12" md="2" Class="d-flex align-center">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="CreateProjectAsync">Create</MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudTable Items="_projects" Dense Hover>
        <HeaderContent>
            <MudTh>Name</MudTh>
            <MudTh>Description</MudTh>
            <MudTh>Created</MudTh>
            <MudTh></MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>@context.Name</MudTd>
            <MudTd>@context.Description</MudTd>
            <MudTd>@context.CreatedAtUtc.ToLocalTime().ToString("g")</MudTd>
            <MudTd>
                <MudButtonGroup Variant="Variant.Outlined">
                    <MudButton Color="Color.Primary" OnClick='@(() => Nav.NavigateTo($"/projects/{context.Id}"))'>
                        Open
                    </MudButton>
                    <MudButton Color="Color.Error" OnClick="@(() => ConfirmDeleteProjectAsync(context))">
                        Delete
                    </MudButton>
                </MudButtonGroup>
            </MudTd>
        </RowTemplate>
    </MudTable>
</MudStack>

@code {
    private readonly List<ProjectDocument> _projects = [];
    private string _newProjectName = string.Empty;
    private string _newProjectDescription = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task CreateProjectAsync()
    {
        if (string.IsNullOrWhiteSpace(_newProjectName))
        {
            return;
        }

        await Store.CreateProjectAsync(new CreateProjectRequest(_newProjectName.Trim(), _newProjectDescription.Trim()), CancellationToken.None);
        _newProjectName = string.Empty;
        _newProjectDescription = string.Empty;
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        _projects.Clear();
        _projects.AddRange(await Store.ListProjectsAsync(CancellationToken.None));
    }

    private async Task ConfirmDeleteProjectAsync(ProjectDocument project)
    {
        var result = await DialogService.ShowMessageBox(
            "Delete Project",
            $"Are you sure you want to delete project '{project.Name}'? This will also delete all repositories, tasks, and runs associated with this project.",
            yesText: "Delete",
            cancelText: "Cancel");

        if (result == true)
        {
            using var httpClient = new HttpClient { BaseAddress = new Uri(Nav.BaseUri) };
            await httpClient.DeleteAsync($"/api/projects/{project.Id}");
            await LoadAsync();
        }
    }
}
