@inherits LayoutComponentBase
@inject Data.IOrchestratorStore Store
@inject Services.IGlobalSelectionService SelectionService
@inject IJSRuntime JS
@inject Services.IUiRealtimeBroker UiRealtimeBroker
@implements IAsyncDisposable

<MudThemeProvider IsDarkMode="true" Theme="_theme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout Class="codex-shell">
    <MudAppBar Elevation="0" Dense="true" Class="codex-appbar">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="ToggleDrawer" />
        <MudText Typo="Typo.subtitle1" Class="ml-2 codex-brand">Agents Dashboard</MudText>

        <MudSpacer />

        @if (SelectionService.IsInitialized)
        {
            <div class="codex-context-selectors">
                <MudSelect T="string"
                           Value="@SelectionService.SelectedProjectId"
                           ValueChanged="OnProjectChanged"
                           Label="Project"
                           Variant="Variant.Outlined"
                           Margin="Margin.Dense"
                           Class="codex-context-select"
                           Style="max-width: 220px;">
                    @foreach (var project in SelectionService.Projects)
                    {
                        <MudSelectItem Value="@project.Id">@project.Name</MudSelectItem>
                    }
                </MudSelect>

                <MudSelect T="string"
                           Value="@SelectionService.SelectedRepositoryId"
                           ValueChanged="OnRepositoryChanged"
                           Label="Repository"
                           Variant="Variant.Outlined"
                           Margin="Margin.Dense"
                           Class="codex-context-select"
                           Style="max-width: 220px;">
                    @foreach (var repo in SelectionService.Repositories)
                    {
                        <MudSelectItem Value="@repo.Id">@repo.Name</MudSelectItem>
                    }
                </MudSelect>

                <MudTooltip Text="Refresh" Placement="Placement.Bottom">
                    <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                                   Color="Color.Inherit"
                                   OnClick="RefreshSelectionAsync" />
                </MudTooltip>
            </div>
        }

        @if (_healthLoaded)
        {
            <div class="codex-health-strip">
                <MudChip T="string" Size="Size.Small" Color="@GetWorkerHealthColor()">
                    <MudIcon Icon="@Icons.Material.Filled.Dns" Size="Size.Small" Class="mr-1" />
                    @(_onlineWorkers)/@_totalWorkers Workers
                </MudChip>
                <MudChip T="string" Size="Size.Small" Color="@GetRunHealthColor()">
                    <MudIcon Icon="@Icons.Material.Filled.PlayCircle" Size="Size.Small" Class="mr-1" />
                    @_activeRuns Active
                </MudChip>
            </div>
        }
    </MudAppBar>

    <MudDrawer @bind-Open="_drawerOpen"
               ClipMode="DrawerClipMode.Always"
               Elevation="0"
               Variant="DrawerVariant.Mini"
               OpenMiniOnHover="true"
               Class="codex-rail">
        <MudNavMenu Dense="true" Class="codex-rail-nav">
            <MudNavLink Href="/" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Chat">Overview</MudNavLink>
            <MudNavLink Href="/settings" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Tune" Class="codex-parent-settings-link">Settings</MudNavLink>
        </MudNavMenu>
    </MudDrawer>

    <MudMainContent Class="codex-main">
        <MudContainer MaxWidth="MaxWidth.False" Class="codex-main-container">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    private bool _drawerOpen = true;
    private bool _healthLoaded;
    private int _onlineWorkers;
    private int _totalWorkers;
    private int _activeRuns;
    private readonly Dictionary<string, string> _terminalRunStates = new(StringComparer.OrdinalIgnoreCase);
    private readonly object _terminalRunStateLock = new();
    private CancellationTokenSource? _cts;
    private IDisposable? _runStatusSubscription;
    private IDisposable? _selectionSubscription;

    private readonly MudTheme _theme = new()
    {
        PaletteDark = new PaletteDark
        {
            Primary = "#7CC4FF",
            Secondary = "#4CE0C4",
            Tertiary = "#9A8CFF",
            Info = "#53B1FD",
            Success = "#32D583",
            Warning = "#F79009",
            Error = "#F97066",
            Background = "#07090D",
            BackgroundGray = "#0E1118",
            Surface = "#0E131C",
            AppbarBackground = "#0B0F17",
            AppbarText = "#F4F7FB",
            DrawerBackground = "#0A0E15",
            DrawerText = "#C9D2E3",
            DrawerIcon = "#91A4BD",
            TextPrimary = "#F4F7FB",
            TextSecondary = "#A5B1C1",
            ActionDefault = "#A5B1C1",
            ActionDisabled = "#5F6C7E",
            ActionDisabledBackground = "#141920",
            LinesDefault = "#1A2230",
            LinesInputs = "#2A3446",
            TableLines = "#1A2230",
            TableStriped = "#0F1218",
            Divider = "#1A2230"
        }
    };

    private void ToggleDrawer() => _drawerOpen = !_drawerOpen;

    protected override async Task OnInitializedAsync()
    {
        _cts = new CancellationTokenSource();

        _selectionSubscription = SelectionService.Subscribe(_ => InvokeAsync(StateHasChanged));
        _runStatusSubscription = UiRealtimeBroker.Subscribe<AgentsDashboard.Contracts.SignalR.RunStatusChangedEvent>(async runStatus =>
        {
            var terminalState = GetTerminalRunState(runStatus.State);
            if (terminalState is null)
            {
                return;
            }

            lock (_terminalRunStateLock)
            {
                if (_terminalRunStates.ContainsKey(runStatus.RunId))
                {
                    return;
                }

                _terminalRunStates[runStatus.RunId] = terminalState;
            }

            await InvokeAsync(async () =>
            {
                try
                {
                    await JS.InvokeVoidAsync("agentsDashboard.playRunCompletedSound", terminalState);
                }
                catch
                {
                }
            });
        });

        _ = Task.Run(async () =>
        {
            while (!_cts.Token.IsCancellationRequested)
            {
                try
                {
                    await LoadHealthAsync();
                    await InvokeAsync(StateHasChanged);
                }
                catch
                {
                }

                await Task.Delay(TimeSpan.FromSeconds(30), _cts.Token);
            }
        }, _cts.Token);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await SelectionService.InitializeAsync(_cts?.Token ?? CancellationToken.None);
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task OnProjectChanged(string? projectId)
    {
        await SelectionService.SelectProjectAsync(projectId, _cts?.Token ?? CancellationToken.None);
    }

    private async Task OnRepositoryChanged(string? repositoryId)
    {
        await SelectionService.SelectRepositoryAsync(repositoryId, _cts?.Token ?? CancellationToken.None);
    }

    private async Task RefreshSelectionAsync()
    {
        await SelectionService.RefreshAsync(_cts?.Token ?? CancellationToken.None);
        StateHasChanged();
    }

    private async Task LoadHealthAsync()
    {
        var workers = await Store.ListWorkersAsync(CancellationToken.None);
        _totalWorkers = workers.Count;
        _onlineWorkers = workers.Count(w => w.Online);

        var runs = await Store.ListRecentRunsAsync(CancellationToken.None);
        _activeRuns = runs.Count(r => r.State is RunState.Running or RunState.Queued);

        _healthLoaded = true;
    }

    private Color GetWorkerHealthColor()
    {
        if (_totalWorkers == 0) return Color.Error;
        if (_onlineWorkers == _totalWorkers) return Color.Success;
        if (_onlineWorkers > 0) return Color.Warning;
        return Color.Error;
    }

    private Color GetRunHealthColor()
    {
        if (_activeRuns == 0) return Color.Default;
        if (_activeRuns > 10) return Color.Warning;
        return Color.Info;
    }

    private static string? GetTerminalRunState(string? state)
    {
        return state switch
        {
            not null when string.Equals(state, "Succeeded", StringComparison.OrdinalIgnoreCase) => "succeeded",
            not null when string.Equals(state, "Failed", StringComparison.OrdinalIgnoreCase) => "failed",
            not null when string.Equals(state, "Cancelled", StringComparison.OrdinalIgnoreCase) => "cancelled",
            _ => null
        };
    }

    public async ValueTask DisposeAsync()
    {
        _selectionSubscription?.Dispose();
        _runStatusSubscription?.Dispose();
        _cts?.Cancel();
        _cts?.Dispose();
    }
}
