# AI Orchestrator - Claude Code Harness Image
# Anthropic Claude Code CLI harness
# Build: docker build -f Dockerfile.harness-claudecode -t ghcr.io/mariogk/harness-claudecode:latest .

FROM ghcr.io/mariogk/ai-harness-base:latest

LABEL org.opencontainers.image.source=https://github.com/mariogk/AgentsDashboard \
      org.opencontainers.image.description="Claude Code harness for AI Orchestrator" \
      org.opencontainers.image.licenses=MIT

USER root

RUN npm install -g @anthropic-ai/claude-code 2>/dev/null || echo "Claude Code CLI installation attempted"

RUN mkdir -p /home/agent/.claude && chown -R agent:agent /home/agent/.claude

COPY --chmod=755 <<'EOF' /usr/local/bin/claude-wrapper
#!/bin/bash
# Claude Code CLI wrapper for AI Orchestrator

set -e

if command -v claude &> /dev/null; then
    if [ "$CLAUDE_OUTPUT_ENVELOPE" = "true" ]; then
        OUTPUT=$(claude "$@" 2>&1)
        EXIT_CODE=$?
        cat <<ENVELOPE
{
    "runId": "${CLAUDE_RUN_ID:-unknown}",
    "taskId": "${CLAUDE_TASK_ID:-unknown}",
    "status": "$([ $EXIT_CODE -eq 0 ] && echo 'succeeded' || echo 'failed')",
    "summary": "Claude Code execution completed",
    "error": "$([ $EXIT_CODE -ne 0 ] && echo "$OUTPUT" | head -1 | jq -Rs . || echo 'null')",
    "metadata": {
        "exitCode": $EXIT_CODE,
        "outputLength": ${#OUTPUT}
    }
}
ENVELOPE
    else
        exec claude "$@"
    fi
else
    if [ -z "$ANTHROPIC_API_KEY" ]; then
        echo '{"status": "failed", "error": "ANTHROPIC_API_KEY not set and claude CLI not installed"}' >&2
        exit 1
    fi
    
    PROMPT="${CLAUDE_PROMPT:-$PROMPT}"
    if [ -z "$PROMPT" ]; then
        echo '{"status": "failed", "error": "No prompt provided"}' >&2
        exit 1
    fi
    
    MODEL="${CLAUDE_MODEL:-claude-sonnet-4-20250514}"
    
    RESPONSE=$(curl -s -X POST https://api.anthropic.com/v1/messages \
        -H "Content-Type: application/json" \
        -H "x-api-key: $ANTHROPIC_API_KEY" \
        -H "anthropic-version: 2023-06-01" \
        -d "{
            \"model\": \"$MODEL\",
            \"max_tokens\": 8192,
            \"messages\": [{\"role\": \"user\", \"content\": $(echo "$PROMPT" | jq -Rs .)}]
        }")
    
    if [ "$CLAUDE_OUTPUT_ENVELOPE" = "true" ]; then
        CONTENT=$(echo "$RESPONSE" | jq -r '.content[0].text // empty')
        cat <<ENVELOPE
{
    "runId": "${CLAUDE_RUN_ID:-unknown}",
    "taskId": "${CLAUDE_TASK_ID:-unknown}",
    "status": "succeeded",
    "summary": "Claude API execution completed",
    "metadata": {
        "model": "$MODEL",
        "contentLength": "${#CONTENT}"
    }
}
ENVELOPE
    else
        echo "$RESPONSE" | jq -r '.content[0].text // .error.message // "No response"'
    fi
fi
EOF

RUN ln -sf /usr/local/bin/claude-wrapper /usr/local/bin/claude-code

USER agent

ENV CLAUDE_OUTPUT_ENVELOPE=true \
    CLAUDE_MODEL=claude-sonnet-4-20250514

WORKDIR /workspace

CMD ["/bin/bash"]
