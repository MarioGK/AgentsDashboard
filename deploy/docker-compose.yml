services:
  harness-image:
    build:
      context: ./harness-image
      dockerfile: Dockerfile
    image: ghcr.io/mariogk/ai-harness:latest
    profiles:
      - build

  harness-base:
    build:
      context: ./harness-images
      dockerfile: Dockerfile.harness-base
    image: ghcr.io/mariogk/ai-harness-base:latest
    profiles:
      - build-harnesses

  harness-codex:
    build:
      context: ./harness-images
      dockerfile: Dockerfile.harness-codex
    image: ghcr.io/mariogk/harness-codex:latest
    profiles:
      - build-harnesses
    depends_on:
      - harness-base

  harness-opencode:
    build:
      context: ./harness-images
      dockerfile: Dockerfile.harness-opencode
    image: ghcr.io/mariogk/harness-opencode:latest
    profiles:
      - build-harnesses
    depends_on:
      - harness-base

  harness-claudecode:
    build:
      context: ./harness-images
      dockerfile: Dockerfile.harness-claudecode
    image: ghcr.io/mariogk/harness-claudecode:latest
    profiles:
      - build-harnesses
    depends_on:
      - harness-base

  harness-zai:
    build:
      context: ./harness-images
      dockerfile: Dockerfile.harness-zai
    image: ghcr.io/mariogk/harness-zai:latest
    profiles:
      - build-harnesses
    depends_on:
      - harness-base

  mongodb:
    image: mongo:8.0
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD:-changeme}
    volumes:
      - mongo-data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')", "-u", "${MONGO_INITDB_ROOT_USERNAME:-admin}", "-p", "${MONGO_INITDB_ROOT_PASSWORD:-changeme}", "--authenticationDatabase", "admin"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          memory: 1g
        reservations:
          memory: 256m
    networks:
      - orchestrator-backend

  victoria-metrics:
    image: victoriametrics/victoria-metrics:latest
    restart: unless-stopped
    command: ["-storageDataPath=/victoria-metrics-data", "-retentionPeriod=30d", "-otlp.httpListener=:8428"]
    ports:
      - "8428:8428"
    volumes:
      - vm-data:/victoria-metrics-data
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8428/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 512m
        reservations:
          memory: 128m
    networks:
      - orchestrator-backend

  vmui:
    image: victoriametrics/vmui:latest
    restart: unless-stopped
    ports:
      - "8081:8080"
    environment:
      VMUI_BACKEND_URL: http://victoria-metrics:8428
    depends_on:
      victoria-metrics:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 256m
        reservations:
          memory: 64m
    networks:
      - orchestrator-backend

  worker-gateway:
    build:
      context: ..
      dockerfile: src/AgentsDashboard.WorkerGateway/Dockerfile
    restart: unless-stopped
    environment:
      Worker__UseDocker: "true"
      Worker__DefaultImage: "ghcr.io/mariogk/ai-harness:latest"
      Worker__HarnessImages__codex: "ghcr.io/mariogk/harness-codex:latest"
      Worker__HarnessImages__opencode: "ghcr.io/mariogk/harness-opencode:latest"
      Worker__HarnessImages__claude-code: "ghcr.io/mariogk/harness-claudecode:latest"
      Worker__HarnessImages__zai: "ghcr.io/mariogk/harness-zai:latest"
      Orchestrator__MongoConnectionString: mongodb://${MONGO_INITDB_ROOT_USERNAME:-admin}:${MONGO_INITDB_ROOT_PASSWORD:-changeme}@mongodb:27017?authSource=admin
      Orchestrator__MongoDatabase: ${MONGODB_DATABASE:-agentsdashboard}
      CODEX_API_KEY: ${CODEX_API_KEY:-}
      OPENCODE_API_KEY: ${OPENCODE_API_KEY:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      Z_AI_API_KEY: ${Z_AI_API_KEY:-}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - artifacts-data:/artifacts
      - workspaces-data:/workspaces
    depends_on:
      mongodb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=:5201"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 1g
        reservations:
          memory: 256m
    networks:
      - orchestrator-backend

  control-plane:
    build:
      context: ..
      dockerfile: src/AgentsDashboard.ControlPlane/Dockerfile
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      Orchestrator__MongoConnectionString: mongodb://${MONGO_INITDB_ROOT_USERNAME:-admin}:${MONGO_INITDB_ROOT_PASSWORD:-changeme}@mongodb:27017?authSource=admin
      Orchestrator__MongoDatabase: ${MONGODB_DATABASE:-agentsdashboard}
      Orchestrator__WorkerGrpcAddress: http://worker-gateway:5201
      OTEL_EXPORTER_OTLP_ENDPOINT: http://victoria-metrics:8428
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - artifacts-data:/artifacts:ro
    depends_on:
      mongodb:
        condition: service_healthy
      worker-gateway:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 1g
        reservations:
          memory: 256m
    networks:
      - orchestrator-backend
      - orchestrator-frontend

  nginx:
    image: nginx:1.27-alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - certbot-www:/var/www/certbot:ro
    depends_on:
      control-plane:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "-T", "5", "http://localhost:80/nginx_health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    deploy:
      resources:
        limits:
          memory: 128m
        reservations:
          memory: 32m
    networks:
      - orchestrator-frontend

volumes:
  mongo-data:
  vm-data:
  artifacts-data:
  workspaces-data:
  certbot-www:

networks:
  orchestrator-backend:
    driver: bridge
    internal: false
  orchestrator-frontend:
    driver: bridge
