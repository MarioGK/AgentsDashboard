services:
  control-plane:
    build:
      context: .
      dockerfile: src/AgentsDashboard.ControlPlane/Dockerfile
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      Orchestrator__LiteDbPath: /data/litedb/orchestrator.db
      Orchestrator__Workers__ContainerImage: ${WORKER_CONTAINER_IMAGE:-agentsdashboard-task-runtime-gateway:latest}
      Orchestrator__Workers__ContainerNamePrefix: task-runtime-gateway
      Orchestrator__Workers__DockerNetwork: agentsdashboard
      Orchestrator__Workers__ConnectivityMode: DockerDnsOnly
      WORKER_DEFAULT_IMAGE: ${WORKER_DEFAULT_IMAGE:-ghcr.io/mariogk/ai-harness:latest}
      WORKER_CONTROL_PLANE_URL: http://control-plane:8080
      CODEX_API_KEY: ${CODEX_API_KEY:-}
      OPENCODE_API_KEY: ${OPENCODE_API_KEY:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      Z_AI_API_KEY: ${Z_AI_API_KEY:-}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./data:/data
      - ./data/artifacts:/artifacts
      - ./data/workspaces:/workspaces
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - agentsdashboard

networks:
  agentsdashboard:
    name: agentsdashboard
    driver: bridge
